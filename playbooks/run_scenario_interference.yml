---
# This scenario runs iperf between the first UE and the core_node host with some interference.
# Most tasks run on 'faraday', except for the iperf server which is delegated to 'core_node'.

- name: Global initialization
  hosts: all
  gather_facts: true
  tasks:
    - name: Normalize booleans at playbook start
      import_tasks: ../tasks/reload_booleans.yml


- name: Main Test Sequence on Faraday
  hosts: faraday
  gather_facts: false

  vars:
    fiveg_profile: default
    duration: 12
    core_ip: "{{ hostvars[groups['core_node'][0]]['ip'] | default(hostvars[groups['core_node'][0]]['ansible_host']) }}"

  tasks:

    # ---------------- UE PREP ----------------
    - name: Initialize UE variable
      set_fact:
        current_ue: "{{ groups['qhats'][0] }}"

    - name: Load active 5G profile
      include_vars:
        file: "{{ playbook_dir }}/../group_vars/all/5g_profile_{{ fiveg_profile }}.yaml"
        name: fiveg

    - name: Validate UE exists in profile
      fail:
        msg: "UE {{ current_ue }} not found in 5G profile"
      when: current_ue not in fiveg.ues

    - name: Get UE slice
      set_fact:
        ue_slice: "{{ fiveg.ues[current_ue].slice }}"

    # ---------------- CONNECT UE ----------------
    - name: Check if UE already has IP
      shell: |
        ssh -o ConnectTimeout=5 -o BatchMode=yes -o StrictHostKeyChecking=no root@{{ current_ue }} \
        "ip -4 addr show wwan0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}'"
      register: check_ip_ready
      changed_when: false
      ignore_errors: true

    - name: Connect UE if needed
      include_role:
        name: r2lab/ue/connect
      vars:
        ue_item: "{{ current_ue }}"
      when: check_ip_ready.stdout == "" or check_ip_ready.rc != 0

    - name: Retrieve UE IP
      shell: |
        ssh root@{{ current_ue }} \
        "ip -4 addr show wwan0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}'"
      register: ue_ip_cmd
      until: ue_ip_cmd.stdout != ""
      retries: 5
      delay: 2
      changed_when: false

    - name: Ensure route to core exists
      shell: ssh root@{{ current_ue }} "ip route get {{ core_ip }}"
      register: route_check
      changed_when: false
      ignore_errors: true

    - name: Add route if missing
      shell: ssh root@{{ current_ue }} "ip route add {{ core_ip }} dev wwan0"
      when: '"dev wwan0" not in route_check.stdout'
      ignore_errors: true

    # ---------------- IPERF SERVER ----------------
    - name: Run iperf server on core
      delegate_to: "{{ groups['core_node'][0] }}"
      become: true
      block:
        - include_role:
            name: scenarios/iperf_server
          vars:
            nb_ues: "1"

    # ---------------- START IPERF ----------------
    - name: Start iperf
      shell: >
        ssh root@{{ current_ue }}
        'iperf3 -B {{ ue_ip_cmd.stdout }} -c {{ core_ip }} --bidir -t 300 -J > /tmp/iperf_test.json'
      async: 1800
      poll: 0
      register: iperf_job

    - name: Wait before interference
      pause:
        seconds: 100

    # =========================================================
    #  INTERFERENCE NODE INITIALIZATION (FIXED VERSION)
    # =========================================================

    - set_fact:
        faraday_host: "{{ groups['faraday'][0] }}"

    - set_fact:
        interference_node: "{{ groups['fit_nodes'][0] }}"
      when: hostvars[faraday_host].interference_usrp == "fit"

    - set_fact:
        interference_node: "{{ hostvars[faraday_host].interference_usrp }}"
      when: hostvars[faraday_host].interference_usrp in ["n300","n320"]

    - name: Debug chosen interference node
      debug:
        msg: "Interference node = {{ interference_node }} (type={{ hostvars[faraday_host].interference_usrp }})"

    # ---------------- RUN INTERFERENCE ----------------
    - name: Run noise generator
      become: true
      vars:
        usrp_type: "{{ hostvars[faraday_host].interference_usrp | default('') }}"
      block:
        - include_role:
            name: scenarios/interference/run
          vars:
            node: "{{ interference_node }}"
            freq: "{{ hostvars[faraday_host].freq }}"
            time: 100
          when: usrp_type in ['fit','n300','n320']

    # ---------------- WAIT IPERF ----------------
    - name: Wait for iperf job
      async_status:
        jid: "{{ iperf_job.ansible_job_id }}"
      register: result
      until: result.finished
      retries: 100
      delay: 10


# =========================================================
# COLLECT RESULTS
# =========================================================

- name: Collect and display stats
  hosts: faraday
  gather_facts: false

  tasks:

    - name: Find iperf logs
      find:
        paths: "/root/IPERF"
        patterns: "iperf_*.log"
      delegate_to: "{{ groups['core_node'][0] }}"
      become: true
      register: iperf_files

    - name: Read logs
      command: "cat {{ item.path }}"
      loop: "{{ iperf_files.files | sort(attribute='path') }}"
      register: log_contents
      delegate_to: "{{ groups['core_node'][0] }}"
      become: true
      when: iperf_files.matched > 0
      changed_when: false

    - name: FINAL SUMMARY
      debug:
        msg: |
          {% if log_contents.results is defined %}
          {% for log in log_contents.results if log.stdout is defined %}
          ============================================================
          FILE: {{ log.item.path | basename }}
          ============================================================
          {{ log.stdout }}
          {% endfor %}
          {% endif %}

    - name: NOTE location of iperf results
      debug:
        msg: "All iperf results are stored on core node in /root/IPERF"
