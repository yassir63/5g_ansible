---
# This scenario runs iperf between the first UE and the core_node host with some interference.
# Most tasks run on 'faraday', except for the iperf server which is delegated to 'core_node'.

- name: Global initialization
  hosts: all
  gather_facts: true
  tasks:
    - name: Normalize booleans at playbook start
      import_tasks: ../tasks/reload_booleans.yml

- name: Main Test Sequence on Faraday
  hosts: faraday
  gather_facts: false
  vars:
    fiveg_profile: default
    duration: 12
    # Retrieve the IP of the first host in the core_node group
    core_ip: "{{ hostvars[groups['core_node'][0]]['ip'] | default(hostvars[groups['core_node'][0]]['ansible_host']) }}"
    # Identify the node that actually handles the interference USRP
    interference_host: "{{ groups['ran_nodes'][0] }}"

  tasks:
    # --- UE INFO PREPARATION ---
    - name: Initialize UE-related variables
      set_fact:
        current_ue: "{{ groups['qhats'][0] }}"

    - name: Load active 5G profile
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../group_vars/all/5g_profile_{{ fiveg_profile }}.yaml"
        name: fiveg

    - name: Validate if UE exists in 5G profile
      fail:
        msg: "UE {{ current_ue }} not found in 5G profile"
      when: current_ue not in fiveg.ues

    - name: Get slice name associated with UE
      set_fact:
        ue_slice: "{{ fiveg.ues[current_ue].slice }}"

    # --- CONNECTION AND ROUTING (Executed via Faraday) ---
    - name: Check if {{ current_ue }} already has a wwan0 IP
      shell: |
        ssh -o ConnectTimeout=5 -o BatchMode=yes -o StrictHostKeyChecking=no root@{{ current_ue }} \
        "ip -4 addr show wwan0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}'"
      register: check_ip_ready
      changed_when: false
      ignore_errors: true

    - name: Connect UE {{ current_ue }} to 5G network if needed
      include_role:
        name: r2lab/ue/connect
      vars:
        ue_item: "{{ current_ue }}"
      when: check_ip_ready.stdout == "" or check_ip_ready.rc != 0

    - name: Retrieve wwan0 IP for {{ current_ue }}
      shell: |
        ssh -o ConnectTimeout=5 root@{{ current_ue }} \
        "ip -4 addr show wwan0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}'"
      register: ue_ip_cmd
      until: ue_ip_cmd.stdout != ""
      retries: 5
      delay: 2
      changed_when: false

    - name: Check route to {{ core_ip }} on {{ current_ue }}
      shell: ssh -o BatchMode=yes root@{{ current_ue }} "ip route get {{ core_ip }}"
      register: route_check
      changed_when: false
      ignore_errors: true

    - name: Add route to {{ core_ip }} via wwan0 if missing
      shell: ssh -o BatchMode=yes root@{{ current_ue }} "ip route add {{ core_ip }} dev wwan0"
      when: '"dev wwan0" not in route_check.stdout'
      ignore_errors: true

    # --- IPERF SERVER (Delegated to Core Node) ---
    - name: Run iperf servers on Core node
      delegate_to: "{{ groups['core_node'][0] }}"
      become: true
      block:
        - name: Include iperf_server role
          include_role:
            name: scenarios/iperf_server
          vars:
            nb_ues: "1"

    # --- PERFORMANCE TEST AND INTERFERENCE ---
    - name: Start bidirectional iperf3 on first UE in background
      shell: >
        ssh root@{{ current_ue }}
        'iperf3 -B {{ ue_ip_cmd.stdout }} -c {{ core_ip }} --bidir -t 300 -J > /tmp/iperf_test.json'
      async: 1800
      poll: 0
      register: iperf_job

    - name: Wait 100 seconds before running noise generator
      pause:
        seconds: 100

    - name: Run interference role if USRP type is compatible
      delegate_to: "{{ interference_host }}"
      become: true
      block:
        - name: Include interference role
          include_role:
            name: scenarios/interference/run
          vars:
            node: "{{ hostvars[interference_host].interference_usrp | default('n300') }}"
            time: 100
          when: 
            - hostvars[interference_host].interference_usrp is defined
            - hostvars[interference_host].interference_usrp in ['n300', 'n320']

    - name: Wait for iperf job to finish
      async_status:
        jid: "{{ iperf_job.ansible_job_id }}"
      register: result
      until: result.finished
      retries: 100
      delay: 10

# --- COLLECT AND DISPLAY STATS ---
- name: Collect and Display Interference Test Stats
  hosts: faraday
  gather_facts: false
  tasks:
    - name: Find iperf log files on Core Node
      find:
        paths: "/root/IPERF"
        patterns: "iperf_*.log"
      delegate_to: "{{ groups['core_node'][0] }}"
      become: true
      register: iperf_files

    - name: Read session logs from Core Node
      command: "cat {{ item.path }}"
      loop: "{{ iperf_files.files | sort(attribute='path') }}"
      register: log_contents
      delegate_to: "{{ groups['core_node'][0] }}"
      become: true
      when: iperf_files.matched > 0
      changed_when: false

    - name: "ðŸ“Š FINAL SUMMARY (Server Side)"
      debug:
        msg: |
          {% if log_contents.results is defined %}
          {% for log in log_contents.results if log.stdout is defined %}
          ============================================================
          FILE: {{ log.item.path | basename }}
          ============================================================
          {{ log.stdout }}
          {% endfor %}
          {% endif %}
