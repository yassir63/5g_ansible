---
- hosts: webshell
  gather_facts: false
  vars:
    original_inventory: "{{ inventory_file }}"  
  tasks:
    - name: DEBUG â€“ Inventory
      debug:
        msg: "Used inventory for run_pos playbook : {{ original_inventory }}"
      
    - name: Run pos reset in parallel for each sopnode
      ansible.builtin.command: >
        ansible-playbook -i {{ inventory_file }} playbooks/run_pos.yml --extra-vars "node={{ item }}" -c local
      args:
        chdir: "{{ playbook_dir | dirname }}"
      async: 1800
      poll: 0
      loop: "{{ groups['sopnodes'] }}"
      loop_control:
        label: "{{ item }}"
      register: prepare_jobs

    - name: Wait for all sopnodes used to be reset
      async_status:
        jid: "{{ item.ansible_job_id }}"
      register: job_result
      until: job_result.finished
      retries: 100
      delay: 10
      loop: "{{ prepare_jobs.results }}"
      loop_control:
        label: "{{ item.item }}"

- name: Common sopnodes setup
  hosts: sopnodes
  roles:
    - role: setup/common
    - role: setup/netplan
    - role: setup/containerd
    - role: setup/k8s/k8s_setup
    - role: setup/k8s/k8s_env
    - role: setup/optimization/cpu

- name: PTP setup on ran_node for fhi72 scenarios
  hosts: ran_node
  become: true
  roles:
    - role: setup/optimization/nic
      when: fhi72
    - role: setup/ptp
      when: fhi72

- name: Create and setup Kubernetes Cluster on Master
  hosts: core_node
  roles:
    # forces core-node to have similar date than ran-node, else possible k8s certificate issues
    - role: setup/ntp 
      when: fhi72
    - role: setup/k8s/cluster_create

- name: Join Kubernetes Cluster on Workers
  hosts: k8s_workers
  become: true
  roles:
    - role: setup/k8s/cluster_join

- name: Install Multus / CNAO # only once workers have joined
  hosts: core_node
  become: true
  roles:
    - role: setup/cni

- name: Apply specific tuning on RAN Node
  hosts: ran_node
  become: true
  roles:
    - role: setup/k8s/aw2s_specific_tuning
      when: aw2s and f1f2_ran
    - role: setup/k8s/aw2s_specific_tuning_f3
      when: aw2s and f3_ran
    - role: setup/k8s/benetel_specific_tuning_f3
      when: fhi72 and f3_ran

- name: Deploy 5G-Monarch
  hosts: monitor_node
  roles:
    - role: monarch/deploy
      when: monitoring_enabled

- name: SRIOV setup
  hosts: ran_node
  become: true
  gather_facts: true
  roles:
    - role: setup/sriov_operator
      when: fhi72
    - role: setup/sriov_nnp_create    
      when: fhi72

- name: Deploy OAI CN and RAN
  hosts: ran_node
  roles:
    - role: 5g/oai/setup
      when: core == 'oai' or ran == 'oai'
    - role: 5g/oai/config
      when: core == 'oai' or ran == 'oai'
    - role: 5g/oai/core
      when: core == 'oai'
    - role: 5g/oai/ran
      when: ran == 'oai'
      
- name: Deploy Open5GS CN
  hosts: core_node
  vars_files:
    - group_vars/all/5g_profiles/default.yaml
  roles:
    - role: 5g/open5gs/fiveg_profile
      when: core == 'open5gs'
    - role: 5g/open5gs/config
      when: core == 'open5gs'

- name: Launch 5G-Monarch monitoring
  hosts: monitor_node
  roles:
    - role: monarch/monitoring
      when: monitoring_enabled