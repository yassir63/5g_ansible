---
- hosts: all
  gather_facts: true
  tasks:
    - name: Normalize booleans at playbook start
      import_tasks: ../tasks/reload_booleans.yml

- name: Run iperf servers on Core node and optionally run NR-UE tests
  hosts: core_node
  become: true
  vars:
    duration: 12
    sleep: 5
    ignore_task_errors: yes
    nb_ues: "{{ 3 if rru == 'rfsim' else groups['qhats'] | length }}"
    core_ip: "{{ hostvars[groups['core_node'][0]].ip }}"
  roles:
    - role: scenarios/iperf_server
    - role: scenarios/iperf/nr-ue-to-core_node
      when: rru == "rfsim"

- name: Optionally run UE-to-core iperf tests from Faraday
  hosts: faraday
  vars:
    duration: 12
    sleep: 5
    ignore_task_errors: yes
    nb_ues: "{{ groups['qhats'] | length }}"
    core_ip: "{{ hostvars[groups['core_node'][0]].ip }}"
  roles:
    - role: scenarios/iperf/ue-to-core_node
      when: rru != "rfsim"

- name: "ðŸ“Š FINAL SUMMARY (Server Side)"
  hosts: core_node
  become: true
  gather_facts: false
  tasks:
    - name: Find recent iperf log files
      find:
        paths: "/root/IPERF"
        patterns: "iperf_*.log"
        age: -300
      register: iperf_files

    - name: Read logs
      slurp:
        src: "{{ item.path }}"
      loop: "{{ iperf_files.files | default([]) | sort(attribute='mtime', reverse=true) }}"
      register: log_contents

    - name: ðŸš€ BERSERK DISPLAY (Direct Terminal Output)
      delegate_to: localhost
      become: false
      run_once: true
      python_script:
        content: |
          import sys
          colors = {
              "5201": "\033[91m",
              "5202": "\033[92m",
              "5203": "\033[94m",
              "reset": "\033[0m"
          }
          
          results = {{ log_contents.results | to_json }}
          
          for res in results:
              path = res['item']['path']
              import base64
              raw_content = base64.b64decode(res['content']).decode('utf-8', errors='ignore').replace('\x00', '')
              
              port = "5201" if "5201" in path else "5202" if "5202" in path else "5203" if "5203" in path else "reset"
              color = colors.get(port, colors["reset"])
              
              print(f"\n{color}--- FILE: {path} ---")
              print(raw_content)
              print(f"{colors['reset']}-----------------------------------------------------------")
      vars:

        results_data: "{{ log_contents.results }}"

