---
- hosts: all
  gather_facts: true
  tasks:
    - name: Normalize booleans at playbook start
      import_tasks: ../tasks/reload_booleans.yml

- name: Run iperf servers on Core node and optionally run NR-UE tests
  hosts: core_node
  become: true
  vars:
    duration: 12
    sleep: 5
    ignore_errors: yes
    nb_ues: "{{ 3 if rru == 'rfsim' else groups['qhats'] | length }}"
    core_ip: "{{ hostvars[groups['core_node'][0]].ip }}"
  roles:
    - role: scenarios/iperf_server
    - role: scenarios/iperf/nr-ue-to-core_node
      when: rru == "rfsim"

- name: Optionally run UE-to-core iperf tests from Faraday
  hosts: faraday
  vars:
    duration: 12
    sleep: 5
    ignore_errors: yes
    nb_ues: "{{ groups['qhats'] | length }}"
    core_ip: "{{ hostvars[groups['core_node'][0]].ip }}"
  roles:
    - role: scenarios/iperf/ue-to-core_node
      when: rru != "rfsim"

- name: Collect and Display Stats
  hosts: core_node
  gather_facts: true
  tasks:
    - name: Find iperf log files on Core Node
      find:
        paths: "/root/IPERF"
        patterns: "iperf_*.log"
      register: iperf_files

    - name: Read session logs from Core Node
      command: "cat {{ item.path }}"
      loop: "{{ iperf_files.files | sort(attribute='path') }}"
      register: log_contents
      changed_when: false
      when: iperf_files.matched > 0 and iperf_files.files | length > 0

    - name: "üìä FINAL SUMMARY (Server Side)"
      debug:
        msg: |
          {% if log_contents.results is defined and log_contents.results | length > 0 %}
            {% for log in log_contents.results %}
            ============================================================
            FILE: {{ log.item.path | basename }}
            ============================================================
            {{ log.stdout }}
            {% endfor %}
          {% else %}
          ‚ö†Ô∏è No iperf logs found
          {% endif %}
