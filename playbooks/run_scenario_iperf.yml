---
- hosts: all
  gather_facts: true
  tasks:
    - name: Normalize booleans at playbook start
      import_tasks: ../tasks/reload_booleans.yml

- name: Run iperf servers on Core node and optionally run NR-UE tests
  hosts: core_node
  become: true
  vars:
    duration: 12
    sleep: 5
    ignore_task_errors: yes
    nb_ues: "{{ 3 if rru == 'rfsim' else groups['qhats'] | length }}"
    core_ip: "{{ hostvars[groups['core_node'][0]].ip }}"
  roles:
    - role: scenarios/iperf_server
    - role: scenarios/iperf/nr-ue-to-core_node
      when: rru == "rfsim"

- name: Optionally run UE-to-core iperf tests from Faraday
  hosts: faraday
  vars:
    duration: 12
    sleep: 5
    ignore_task_errors: yes
    nb_ues: "{{ groups['qhats'] | length }}"
    core_ip: "{{ hostvars[groups['core_node'][0]].ip }}"
  roles:
    - role: scenarios/iperf/ue-to-core_node
      when: rru != "rfsim"

- name: "ðŸ“Š FINAL SUMMARY (Server Side) - last 5 minutes"
  hosts: core_node
  gather_facts: false
  vars:
    # Couleurs ANSI par UE (ports)
    ue_colors:
      "5201": "\033[91m"  # rouge
      "5202": "\033[92m"  # vert
      "5203": "\033[94m"  # bleu
      "reset": "\033[0m"

    header_line: "============================================================"
    separator_line: "------------------------------------------------------------"

  tasks:
    - name: Find iperf log files modified in the last 5 minutes
      find:
        paths: "/root/IPERF"
        patterns: "iperf_*.log"
        age: 300  # 5 minutes in seconds
        age_stamp: mtime
      register: iperf_files

    - name: Sort files by port number
      set_fact:
        sorted_iperf_files: >-
          {{ iperf_files.files | sort(attribute='path') }}

    - name: Display each recent iperf log with color by port
      block:
        - name: Determine UE color based on port
          set_fact:
            ue_port: "{{ item.path | regex_search('iperf_(\\d+)_') | first }}"
            ue_color: "{{ ue_colors[ue_port] | default(ue_colors['reset']) }}"

        - name: Print header for UE log
          debug:
            msg: "{{ ue_color }}{{ header_line }}\nUE Port {{ ue_port }} log: {{ item.path }}\n{{ separator_line }}{{ ue_colors['reset'] }}"

        - name: Display log content
          command: "cat {{ item.path }}"
          register: log_content
          changed_when: false

        - name: Show log in Ansible output
          debug:
            msg: "{{ ue_color }}{{ log_content.stdout }}{{ ue_colors['reset'] }}"
      loop: "{{ sorted_iperf_files }}"

