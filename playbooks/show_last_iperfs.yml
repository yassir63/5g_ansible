---
- hosts: all
  gather_facts: true
  tasks:
    - name: Normalize booleans at playbook start
      import_tasks: ../tasks/reload_booleans.yml

- name: "ðŸ“Š FINAL SUMMARY -- show most recent iperf results (300s max)"
  hosts: core_node
  become: true
  gather_facts: false
  vars:
    max_age_seconds: 300  # only logs modified in the last 300 seconds
  tasks:
    - name: Find iperf logs
      find:
        paths: "/root/IPERF"
        patterns: "iperf_*.log"
      register: iperf_files

    - name: Filter logs modified in the last 300 seconds
      set_fact:
        recent_logs: >-
          {{ iperf_files.files
             | selectattr('mtime', '>=', (ansible_date_time.epoch | int) - max_age_seconds)
             | list }}

    - name: Read logs content
      slurp:
        src: "{{ item.path }}"
      loop: "{{ recent_logs | sort(attribute='mtime', reverse=true) }}"
      register: log_contents

    - name: ðŸš€ DISPLAY LOGS
      debug:
        msg: |
          FILE: {{ item.item.path }}
          {{ item.content | b64decode | regex_replace('\x00', '') }}
      loop: "{{ log_contents.results }}"
      loop_control:
        label: "{{ item.item.path }}"

