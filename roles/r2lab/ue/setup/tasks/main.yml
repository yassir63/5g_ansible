---
- name: RESTART_UE_SETUP
  ansible.builtin.meta: noop

- name: Load active 5G profile variables
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/../group_vars/all/5g_profile_{{ fiveg_profile | default('default') }}.yaml"

- name: Assert 5G profile is loaded
  ansible.builtin.assert:
    that:
      - slices is defined
      - ues is defined
    fail_msg: >
      5G profile not loaded.
      Expected group_vars/all/5g_profile_{{ fiveg_profile | default('default') }}.yml

- name: Power ON UEs PDU outlet
  shell: rhubarbe pdu on "{{ item }}"
  delegate_to: faraday.inria.fr
  async: 1800
  poll: 0
  loop: "{{ groups['qhats'] }}"
  loop_control:
    label: "{{ item }}"
  register: power_ue_jobs

- name: Wait for all UEs to be turned ON
  async_status:
    jid: "{{ item.ansible_job_id }}"
  register: job_result
  until: job_result.finished
  retries: 100
  delay: 10
  loop: "{{ power_ue_jobs.results }}"
  loop_control:
    label: "{{ item.item }}"

- name: Wait for UEs to be SSH accessible
  wait_for:
    host: "{{ item }}"
    port: 22
    timeout: 180
    sleep: 5
  delegate_to: faraday.inria.fr
  loop: "{{ groups['qhats'] }}"
  loop_control:
    label: "{{ item }}"
  register: power_ue_jobs

- name: Prepare and Display qhat-init command for each UE
  vars:
    # On définit la logique de calcul une seule fois pour le debug et pour l'exécution
    ue_slice_info: "{{ slices | selectattr('name', 'equalto', ues[item].slice) | first }}"
    qhat_command: >-
      qhat-init --mode={{ hostvars[item].mode | default('default') }}
      --dnn="{{ ue_slice_info.dnn }}"
      --nssai="{{ ue_slice_info.sst }}.{{ ue_slice_info.sd }}"
  debug:
    msg: "UE {{ item }} command: {{ qhat_command }}"
  loop: "{{ groups['qhats'] }}"
  loop_control:
    label: "{{ item }}"

- name: Init UEs via jump host using 5G profile from YAML
  vars:
    ue_slice_info: "{{ slices | selectattr('name', 'equalto', ues[item].slice) | first }}"
    # Note: J'ai corrigé le ":" en "." pour le NSSAI selon ton format 01.100000
    qhat_command: >-
      qhat-init --mode={{ hostvars[item].mode | default('default') }}
      --dnn="{{ ue_slice_info.dnn }}"
      --nssai="{{ ue_slice_info.sst }}.{{ ue_slice_info.sd }}"
  shell: |
    ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=5 -n root@{{ item }} '{{ qhat_command }}'
    ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=5 -n root@{{ item }} 'stop.sh'
  delegate_to: faraday.inria.fr
  async: 1800
  poll: 0
  loop: "{{ groups['qhats'] }}"
  loop_control:
    label: "{{ item }}"
  register: set_ue_jobs

- name: Wait for setup to finish on all UEs
  async_status:
    jid: "{{ item.ansible_job_id }}"
  register: job_result
  until: job_result.finished
  retries: 100
  delay: 10
  loop: "{{ set_ue_jobs.results }}"
  loop_control:
    label: "{{ item.item }}"

- name: Run qhat-check on each UE to verify configuration
  shell: |
    ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=5 -n root@{{ item }} 'qhat-check'
  delegate_to: faraday.inria.fr
  loop: "{{ groups['qhats'] }}"
  loop_control:
    label: "{{ item }}"
  register: check_results
  changed_when: false

- name: Display qhat-check output for each UE
  debug:
    msg: 
      - "------------------------------------------------"
      - "UE: {{ item.item }}"
      - "{{ item.stdout_lines }}"
      - "------------------------------------------------"
  loop: "{{ check_results.results }}"
  loop_control:
    label: "{{ item.item }}"