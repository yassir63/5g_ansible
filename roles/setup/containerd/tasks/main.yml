---
# roles/setup/containerd/tasks/main.yml
- name: RESTART_CONTAINERD
  ansible.builtin.meta: noop

- name: Remove old Docker repo junk
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/docker.list
    - /etc/apt/sources.list.d/docker.repo
    - /etc/apt/keyrings/docker.asc
    - /etc/apt/trusted.gpg.d/docker.gpg
  become: true
  when: ansible_facts.os_family == 'Debian'

- name: Install prerequisites
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present
  become: true
  when: ansible_facts.os_family == 'Debian'

- name: Add Docker GPG key
  ansible.builtin.shell: |
    install -m 0755 -d /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | \
      gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    chmod a+r /etc/apt/keyrings/docker.gpg
  args:
    creates: /etc/apt/keyrings/docker.gpg
  become: true
  when: ansible_facts.os_family == 'Debian'

- name: Set Docker repo codename
  ansible.builtin.set_fact:
    docker_repo_codename: >-
      {% if ansible_distribution_release == 'jammy' %}jammy{% else %}noble{% endif %}
  when: ansible_facts.os_family == 'Debian'

- name: Add Docker APT repository
  ansible.builtin.apt_repository:
    repo: >-
      deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg]
      https://download.docker.com/linux/ubuntu
      {{ docker_repo_codename }} stable
    state: present
    filename: docker
    update_cache: yes
  become: true
  when: ansible_facts.os_family == 'Debian'

- name: Install containerd
  ansible.builtin.apt:
    name: >-
      {% if ansible_distribution_release == 'questing' %}containerd{% else %}containerd.io{% endif %}
    state: present
  become: true
  when: ansible_facts.os_family == 'Debian'

- name: Create /etc/containerd
  ansible.builtin.file:
    path: /etc/containerd
    state: directory
  become: true

- name: Generate default config
  ansible.builtin.command: containerd config default
  register: default_config
  changed_when: false
  become: true

- name: Write fixed config.toml â€” USE OVERLAYFS, DISABLE NATIVE
  ansible.builtin.copy:
    dest: /etc/containerd/config.toml
    content: |
      {{ default_config.stdout
         | regex_replace('default_snapshotter = "native"', 'default_snapshotter = "overlayfs"')
         | regex_replace('SystemdCgroup = false', 'SystemdCgroup = true')
         | regex_replace('sandbox_image = ".*"', 'sandbox_image = "registry.k8s.io/pause:3.10"')
      }}
    mode: "0644"
    backup: yes
  become: true
  register: config_changed

- name: Fix containerd.service to use config
  ansible.builtin.lineinfile:
    path: /lib/systemd/system/containerd.service
    regexp: '^ExecStart=.*'
    line: 'ExecStart=/usr/bin/containerd --config /etc/containerd/config.toml'
  become: true
  register: unit_fixed

- name: Reload systemd and restart containerd
  ansible.builtin.systemd:
    daemon_reload: yes
    name: containerd
    state: restarted
    enabled: yes
  become: true
  when: config_changed.changed or unit_fixed.changed
