---
# Simple, minimal containerd setup â€“ jammy + questing
# No handlers, no complex logic, 100% idempotent

- name: Remove old Docker repo files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/docker.list
    - /etc/apt/sources.list.d/docker.repo
    - /etc/apt/sources.list.d/*docker*
    - /etc/apt/trusted.gpg.d/docker.gpg
    - /etc/apt/keyrings/docker.asc
  become: true

- name: Install prerequisites
  ansible.builtin.apt:
    name: [ca-certificates, curl, gnupg, lsb-release]
    state: present
    update_cache: yes
  become: true

- name: Ensure /etc/apt/keyrings exists
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"
  become: true

- name: Download Docker GPG key (curl)
  ansible.builtin.shell: |
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | \
    gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  args:
    creates: /etc/apt/keyrings/docker.gpg
  become: true
  register: gpg_result
  until: gpg_result is succeeded
  retries: 5
  delay: 10
  changed_when: gpg_result.rc == 0 and ('skipped' not in gpg_result or not gpg_result.skipped)

- name: Set Docker repo codename
  ansible.builtin.set_fact:
    docker_repo_codename: >-
      {% if ansible_distribution_release == 'jammy' %}jammy{% else %}noble{% endif %}

- name: Add Docker repo (jammy only)
  ansible.builtin.apt_repository:
    repo: >-
      deb [arch={{ ansible_architecture }} signed-by=/etc/apt/keyrings/docker.gpg]
      https://download.docker.com/linux/ubuntu {{ docker_repo_codename }} stable
    state: present
    filename: docker
    update_cache: yes
  become: true
  when: ansible_distribution_release == 'jammy'

- name: Install containerd (questing) or containerd.io (jammy)
  ansible.builtin.apt:
    name: >-
      {% if ansible_distribution_release == 'questing' %}containerd{% else %}containerd.io{% endif %}
    state: present
    update_cache: yes
  become: true

- name: Create /etc/containerd
  ansible.builtin.file:
    path: /etc/containerd
    state: directory
  become: true

- name: Generate default config
  ansible.builtin.command: containerd config default
  register: cfg
  changed_when: false
  become: true

- name: Write config.toml
  ansible.builtin.copy:
    dest: /etc/containerd/config.toml
    content: "{{ cfg.stdout }}"
    mode: "0644"
    backup: yes
  become: true
  register: config_changed

# --- SIMPLE CONFIG FIXES (idempotent replace) ---
- name: Disable overlayfs + enable native
  ansible.builtin.replace:
    path: /etc/containerd/config.toml
    regexp: '(\s*)\[plugins\."io\.containerd\.snapshotter\.v1\.overlayfs"\]'
    replace: |
      \1[plugins."io.containerd.snapshotter.v1.overlayfs"]
      \1  disabled = true

      \1[plugins."io.containerd.snapshotter.v1.native"]
      \1  async_remove = true
  become: true
  register: snapshotter_fix

- name: Enable systemd cgroup
  ansible.builtin.replace:
    path: /etc/containerd/config.toml
    regexp: 'SystemdCgroup = false'
    replace: 'SystemdCgroup = true'
  become: true
  register: cgroup_fix

- name: Set pause image to 3.10
  ansible.builtin.replace:
    path: /etc/containerd/config.toml
    regexp: 'sandbox_image = .*'
    replace: 'sandbox_image = "registry.k8s.io/pause:3.10"'
  become: true
  register: pause_fix

# --- Restart only if config changed ---
- name: Restart containerd if config changed
  ansible.builtin.systemd:
    name: containerd
    state: restarted
    enabled: yes
  become: true
  when: >
    config_changed.changed or
    snapshotter_fix.changed or
    cgroup_fix.changed or
    pause_fix.changed
