---
- name: Remove old Docker repo files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/docker.list
    - /etc/apt/sources.list.d/docker.repo
    - /etc/apt/sources.list.d/*docker*
    - /etc/apt/trusted.gpg.d/docker.gpg
    - /etc/apt/keyrings/docker.asc
  become: true

- name: Install prerequisites
  ansible.builtin.apt:
    name: [ca-certificates, curl, gnupg, lsb-release]
    state: present
    update_cache: yes
  become: true

- name: Ensure /etc/apt/keyrings exists
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"
  become: true

- name: Download Docker GPG key
  ansible.builtin.shell: |
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  args:
    creates: /etc/apt/keyrings/docker.gpg
  become: true
  register: gpg_result
  until: gpg_result is succeeded
  retries: 5
  delay: 10
  changed_when: gpg_result.rc == 0 and ('skipped' not in gpg_result or not gpg_result.skipped)

- name: Set Docker repo codename
  ansible.builtin.set_fact:
    docker_repo_codename: >-
      {% if ansible_distribution_release == 'jammy' %}jammy{% else %}noble{% endif %}

- name: Add Docker repo (jammy only)
  ansible.builtin.apt_repository:
    repo: >-
      deb [arch={{ ansible_architecture }} signed-by=/etc/apt/keyrings/docker.gpg]
      https://download.docker.com/linux/ubuntu {{ docker_repo_codename }} stable
    state: present
    filename: docker
    update_cache: yes
  become: true
  when: ansible_distribution_release == 'jammy'

- name: Install containerd (questing) or containerd.io (jammy)
  ansible.builtin.apt:
    name: >-
      {% if ansible_distribution_release == 'questing' %}containerd{% else %}containerd.io{% endif %}
    state: present
    update_cache: yes
  become: true

- name: Create /etc/containerd
  ansible.builtin.file:
    path: /etc/containerd
    state: directory
  become: true

- name: Generate default config
  ansible.builtin.command: containerd config default
  register: cfg
  changed_when: false
  become: true

- name: Write config.toml with NATIVE as default + overlayfs disabled
  ansible.builtin.copy:
    dest: /etc/containerd/config.toml
    content: |
      {{ cfg.stdout
         | regex_replace('disabled_snapshotter = ""', 'disabled_snapshotter = "overlayfs"')
         | regex_replace('default_snapshotter = "overlayfs"', 'default_snapshotter = "native"')
         | regex_replace('SystemdCgroup = false', 'SystemdCgroup = true')
         | regex_replace('sandbox_image = ".*"', 'sandbox_image = "registry.k8s.io/pause:3.10"')
      }}
    mode: "0644"
    backup: yes
  become: true
  register: config_changed

# === FINAL FIX: UNIT + PERMISSIONS + RESTART ===
- name: Ensure correct ExecStart in containerd.service (idempotent)
  ansible.builtin.lineinfile:
    path: /lib/systemd/system/containerd.service
    regexp: '^ExecStart=.*'
    line: 'ExecStart=/usr/bin/containerd --config /etc/containerd/config.toml'
    state: present
  become: true
  register: unit_fixed

- name: Fix config.toml permissions
  ansible.builtin.file:
    path: /etc/containerd/config.toml
    mode: "0644"
    owner: root
    group: root
  become: true
  when: config_changed.changed

- name: Reload daemon and restart containerd
  ansible.builtin.systemd:
    daemon_reload: yes
    name: containerd
    state: restarted
    enabled: yes
  become: true
  when: config_changed.changed or unit_fixed.changed
