---
# Original task list â€” FIXED for jammy + questing (Ubuntu 22.04 + 25.10)
# Only containerd. No K8s. No errors.

- name: Force remove any Docker repo definitions
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/docker.list
    - /etc/apt/sources.list.d/docker.repo
    - /etc/apt/sources.list.d/*docker*
    - /etc/apt/trusted.gpg.d/docker.gpg
    - /etc/apt/keyrings/docker.asc
  become: true
  when: ansible_facts['os_family'] == 'Debian'

- name: Install prerequisites (NO update_cache)
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present
    # update_cache: yes  REMOVED
  become: true
  when: ansible_facts['os_family'] == 'Debian'

- name: Add Docker GPG key
  ansible.builtin.shell: |
    install -m 0755 -d /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | \
      gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    chmod a+r /etc/apt/keyrings/docker.gpg
  args:
    creates: /etc/apt/keyrings/docker.gpg
  become: true
  when: ansible_facts['os_family'] == 'Debian'

- name: Set Docker repo codename (jammy or noble)
  ansible.builtin.set_fact:
    docker_repo_codename: >-
      {% if ansible_distribution_release == 'jammy' %}jammy{% else %}noble{% endif %}
  when: ansible_facts.os_family == 'Debian'

- name: Add Docker APT repository
  ansible.builtin.apt_repository:
    repo: >-
      deb [arch={{ ansible_architecture }} signed-by=/etc/apt/keyrings/docker.gpg]
      https://download.docker.com/linux/ubuntu
      {{ docker_repo_codename }} stable
    state: present
    filename: docker
    update_cache: yes
  become: true
  when: ansible_facts.os_family == 'Debian'

- name: Install containerd
  ansible.builtin.apt:
    name: >-
      {% if ansible_distribution_release == 'questing' %}containerd{% else %}containerd.io{% endif %}
    state: present
    update_cache: yes
  become: true
  when: ansible_facts.os_family == 'Debian'

- name: Create /etc/containerd directory
  ansible.builtin.file:
    path: /etc/containerd
    state: directory
  become: true

- name: Generate default containerd config
  ansible.builtin.command: containerd config default
  register: containerd_cfg
  changed_when: false
  become: true

- name: Write config.toml
  ansible.builtin.copy:
    dest: /etc/containerd/config.toml
    content: |
      {{ containerd_cfg.stdout
         | regex_replace('default_snapshotter = "overlayfs"', 'default_snapshotter = "native"')
         | regex_replace('disabled_snapshotter = ""', 'disabled_snapshotter = "overlayfs"')
         | regex_replace('SystemdCgroup = false', 'SystemdCgroup = true')
         | regex_replace('sandbox_image = ".*"', 'sandbox_image = "registry.k8s.io/pause:3.10"')
      }}
    mode: "0644"
    backup: yes
  become: true
  register: config_changed

- name: Fix containerd.service to use --config
  ansible.builtin.lineinfile:
    path: /lib/systemd/system/containerd.service
    regexp: '^ExecStart=.*'
    line: 'ExecStart=/usr/bin/containerd --config /etc/containerd/config.toml'
  become: true
  register: unit_fixed

- name: Reload daemon and restart containerd
  ansible.builtin.systemd:
    daemon_reload: yes
    name: containerd
    state: restarted
    enabled: yes
  become: true
  when: config_changed.changed or unit_fixed.changed

- name: Delete stuck kube-proxy pods after containerd fix
  kubernetes.core.k8s:
    state: absent
    kind: Pod
    namespace: kube-system
    label_selectors:
      - k8s-app=kube-proxy
      - kubernetes.io/hostname={{ inventory_hostname }}
  delegate_to: "{{ groups['control_plane'][0] }}"
  when:
    - "'realtime' in ansible_kernel | lower"
    - groups['control_plane'] is defined
  ignore_errors: yes