---
# roles/setup/containerd/tasks/main.yml
# ONLY CONTAINERD. NO K8S. NO APT UPDATE ERRORS.

- name: Remove old Docker repo junk
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/docker.list
    - /etc/apt/sources.list.d/docker.repo
    - /etc/apt/keyrings/docker.asc
    - /etc/apt/trusted.gpg.d/docker.gpg
  become: true
  when: ansible_facts.os_family == 'Debian'

- name: Install prerequisites (NO update_cache)
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present
  become: true
  when: ansible_facts.os_family == 'Debian'

- name: Create keyrings dir and add Docker GPG key
  ansible.builtin.shell: |
    install -m 0755 -d /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | \
      gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    chmod a+r /etc/apt/keyrings/docker.gpg
  args:
    creates: /etc/apt/keyrings/docker.gpg
  become: true
  when: ansible_facts.os_family == 'Debian'

- name: Set Docker repo codename
  ansible.builtin.set_fact:
    docker_repo_codename: >-
      {% if ansible_distribution_release == 'jammy' %}jammy{% else %}noble{% endif %}
  when: ansible_facts.os_family == 'Debian'

- name: Add Docker APT repository (NO update_cache)
  ansible.builtin.apt_repository:
    repo: >-
      deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg]
      https://download.docker.com/linux/ubuntu
      {{ docker_repo_codename }} stable
    state: present
    filename: docker
  become: true
  when: ansible_facts.os_family == 'Debian'

- name: Install containerd (NO update_cache)
  ansible.builtin.apt:
    name: >-
      {% if ansible_distribution_release == 'questing' %}containerd{% else %}containerd.io{% endif %}
    state: present
  become: true
  when: ansible_facts.os_family == 'Debian'

# === ONLY ONE APT UPDATE â€” AFTER DOCKER REPO ===
- name: Update apt cache ONCE
  ansible.builtin.apt:
    update_cache: yes
  become: true
  when: ansible_facts.os_family == 'Debian'

- name: Create /etc/containerd
  ansible.builtin.file:
    path: /etc/containerd
    state: directory
  become: true

- name: Generate default config
  ansible.builtin.command: containerd config default
  register: cfg
  changed_when: false
  become: true

- name: Write fixed config.toml
  ansible.builtin.copy:
    dest: /etc/containerd/config.toml
    content: |
      {{ cfg.stdout
         | regex_replace('default_snapshotter = "overlayfs"', 'default_snapshotter = "native"')
         | regex_replace('disabled_snapshotter = ""', 'disabled_snapshotter = "overlayfs"')
         | regex_replace('SystemdCgroup = false', 'SystemdCgroup = true')
         | regex_replace('sandbox_image = ".*"', 'sandbox_image = "registry.k8s.io/pause:3.10"')
      }}
    mode: "0644"
    backup: yes
  become: true
  register: config_changed

- name: Fix containerd.service
  ansible.builtin.lineinfile:
    path: /lib/systemd/system/containerd.service
    regexp: '^ExecStart=.*'
    line: 'ExecStart=/usr/bin/containerd --config /etc/containerd/config.toml'
  become: true
  register: unit_fixed

- name: Reload and restart containerd
  ansible.builtin.systemd:
    daemon_reload: yes
    name: containerd
    state: restarted
    enabled: yes
  become: true
  when: config_changed.changed or unit_fixed.changed

- name: Clean stuck kube-proxy pods
  kubernetes.core.k8s:
    state: absent
    kind: Pod
    namespace: kube-system
    label_selectors:
      - k8s-app=kube-proxy
      - kubernetes.io/hostname={{ inventory_hostname }}
  delegate_to: "{{ groups['control_plane'][0] }}"
  when:
    - "'realtime' in ansible_kernel | lower"
    - groups['control_plane'] is defined
  ignore_errors: yes
  