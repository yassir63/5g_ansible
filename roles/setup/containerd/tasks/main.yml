---
- name: RESTART_CONTAINERD
  ansible.builtin.meta: noop

# --- Handle live Ubuntu RAN images before containerd install ---
- name: Detect if running from a live Ubuntu image
  ansible.builtin.shell: |
    grep -q "boot=live" /proc/cmdline && echo "live" || echo "persistent"
  register: live_image_check
  changed_when: false
  become: true

- name: Ensure /var/lib/containerd is writable on live RAN systems
  block:
    - name: Create /var/lib/containerd directory
      ansible.builtin.file:
        path: /var/lib/containerd
        state: directory
        mode: '0755'

    - name: Mount tmpfs on /var/lib/containerd (live system ephemeral fix)
      ansible.builtin.mount:
        path: /var/lib/containerd
        src: tmpfs
        fstype: tmpfs
        opts: size=2G
        state: mounted
  when:
    - inventory_hostname in groups['ran_node']
    - live_image_check.stdout == "live"
  become: true
  tags: ['live-fix']

# containerd installation
- name: Remove old Docker repo junk
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/docker.list
    - /etc/apt/keyrings/docker.asc
  become: true
  when: ansible_facts.os_family == 'Debian'

- name: Install containerd
  ansible.builtin.apt:
    name: containerd
    state: present
    update_cache: yes
  become: true

- name: Ensure /etc/containerd exists
  ansible.builtin.file:
    path: /etc/containerd
    state: directory
    mode: '0755'
  become: true

- name: Generate default containerd config
  ansible.builtin.command: containerd config default
  register: containerd_cfg
  changed_when: false
  become: true

- name: Write config.toml
  ansible.builtin.copy:
    dest: /etc/containerd/config.toml
    content: "{{ containerd_cfg.stdout }}"
    owner: root
    group: root
    mode: '0644'
  become: true

# ---- Systemd cgroup compatibility (handles both key styles)
- name: Enable systemd-cgroup (compat for old/new containerd)
  ansible.builtin.replace:
    path: /etc/containerd/config.toml
    regexp: '(SystemdCgroup = false|systemd_cgroup = false)'
    replace: 'SystemdCgroup = true'
  become: true

- name: Ensure plugin section also enables systemd cgroup
  ansible.builtin.lineinfile:
    path: /etc/containerd/config.toml
    insertafter: '^\[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options\]'
    line: '            SystemdCgroup = true'
    state: present
  become: true

# ---- Optional performance tweak (native snapshotter = lower compat risk)
- name: Switch snapshotter to native
  ansible.builtin.replace:
    path: /etc/containerd/config.toml
    regexp: 'snapshotter = "overlayfs"'
    replace: 'snapshotter = "native"'
  become: true

# ---- Restart and enable
- name: Restart & enable containerd
  ansible.builtin.systemd:
    name: containerd
    enabled: yes
    state: restarted
    daemon_reload: true
  become: true

# ---- Sanity check
- name: Wait for containerd socket
  ansible.builtin.wait_for:
    path: /run/containerd/containerd.sock
    state: present
    timeout: 20
  become: true

- name: Display containerd cgroup driver for debug
  ansible.builtin.shell: |
    grep -E 'SystemdCgroup|systemd_cgroup' /etc/containerd/config.toml | head -n 3
  register: cgroup_check
  changed_when: false
  become: true

- ansible.builtin.debug:
    var: cgroup_check.stdout
