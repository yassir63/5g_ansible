---
- name: Ensure CPUAffinity is set in system.conf
  lineinfile:
    path: /etc/systemd/system.conf
    regexp: '^CPUAffinity='
    line: 'CPUAffinity=0-3'
    state: present

- name: Reload systemd config
  command: systemctl daemon-reexec

- name: Add Kubernetes and RT settings to sysctl.conf
  blockinfile:
    path: /etc/sysctl.conf
    insertafter: EOF
    block: |
      ## For kubernetes
      fs.inotify.max_user_instances=65536
      ## Realtime kernel settings
      kernel.sched_rt_runtime_us=-1
      kernel.timer_migration=0
    marker: "# {mark} RAN tuning"

- name: Ensure python3 and PyYAML are installed (required for YAML merge)
  apt:
    name:
      - python3
      - python3-yaml
    state: present
    update_cache: yes
  become: true

- name: Safely merge CPU-related kubelet settings (non-destructive)
  become: true
  shell: |
    python3 - <<'EOF'
    import yaml, os, sys

    cfg = "/var/lib/kubelet/config.yaml"
    patch = {
      "cgroupDriver": "systemd",
      "cpuManagerPolicy": "static",
      "cpuManagerPolicyOptions": {"full-pcpus-only": "true"},
      "reservedSystemCPUs": "0-5",
      "topologyManagerPolicy": "best-effort",
      "failSwapOn": False,
      "featureGates": {
        "CPUManager": True,
        "CPUManagerPolicyOptions": True,
      }
    }

    if os.path.exists(cfg):
      with open(cfg) as f:
        data = yaml.safe_load(f) or {}
    else:
      data = {}

    # featureGates merge
    fg = data.get("featureGates", {}) or {}
    for k,v in patch["featureGates"].items():
      fg[k] = v
    data["featureGates"] = fg

    for key, val in patch.items():
      if key != "featureGates":
        data[key] = val

    tmp = cfg + ".tmp"
    with open(tmp, "w") as f:
      yaml.safe_dump(data, f, default_flow_style=False, sort_keys=False)
    os.replace(tmp, cfg)
    print("APPLIED")
    EOF
  register: merge_output
  changed_when: "'APPLIED' in merge_output.stdout"

- name: Remove kubelet CPU manager checkpoint (force apply new CPU config)
  become: true
  file:
    path: /var/lib/kubelet/cpu_manager_state
    state: absent

- name: Restart kubelet
  become: true
  systemd:
    name: kubelet
    state: restarted
    daemon_reload: yes

- name: Wait for kubelet to be active
  become: true
  shell: systemctl is-active kubelet
  register: result
  until: result.stdout.strip() == "active"
  retries: 10
  delay: 3
