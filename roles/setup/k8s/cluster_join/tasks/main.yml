---
- name: RESTART_K8S_JOIN
  ansible.builtin.meta: noop

# === CLEANUP (si le node était déjà joint) ===================================
- name: Check if node is already part of a Kubernetes cluster
  stat:
    path: /etc/kubernetes/kubelet.conf
  register: kubelet_conf

- name: Reset node if already part of a cluster
  command: kubeadm reset -f
  when: kubelet_conf.stat.exists
  ignore_errors: true
  become: true

- name: Remove old Kubernetes and CNI data
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/cni/net.d
    - /var/lib/kubelet
    - /var/lib/cni
    - /opt/cni/bin
  when: kubelet_conf.stat.exists
  become: true
  ignore_errors: true

- name: Restart container runtime (containerd)
  service:
    name: containerd
    state: restarted
  when: kubelet_conf.stat.exists
  ignore_errors: true
  become: true

- name: Wait for containerd
  pause:
    seconds: 10

# === INSTALLATION DES PLUGINS CNI DE BASE ====================================
- name: Ensure CNI base directories exist
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /etc/cni/net.d
    - /opt/cni/bin
    - /var/lib/cni
  become: true

- name: Download and extract official CNI plugins
  ansible.builtin.unarchive:
    src: "https://github.com/containernetworking/plugins/releases/download/v1.5.1/cni-plugins-linux-amd64-v1.5.1.tgz"
    dest: /opt/cni/bin
    remote_src: true
  become: true

- name: Fix CNI binary permissions
  file:
    path: /opt/cni/bin
    owner: root
    group: root
    mode: '0755'
    recurse: true
  become: true

# === BASE SETUP ==============================================================
- name: Ensure .kube directory exists on worker node
  file:
    path: /root/.kube
    state: directory
    mode: '0755'
  become: true

- name: Fetch admin.conf from master to control machine
  fetch:
    src: /etc/kubernetes/admin.conf
    dest: ./admin.conf
    flat: yes
  delegate_to: "{{ groups['core_node'][0] }}"
  when: inventory_hostname == groups['k8s_workers'][0]

- name: Copy admin.conf from control machine to worker node
  copy:
    src: ./admin.conf
    dest: /root/.kube/config
    mode: '0644'
  become: true

# === JOIN CLUSTER ============================================================
- name: Ensure control-plane hostname is resolvable
  lineinfile:
    path: /etc/hosts
    line: "{{ hostvars[groups['core_node'][0]].ip }} {{ groups['core_node'][0] }}"
  become: true

- name: Read kubeadm join command from file
  set_fact:
    kubeadm_join_command: "{{ lookup('file', '/tmp/kubeadm_join_command.txt') }}"

- name: Debug join command
  debug:
    var: kubeadm_join_command

- name: Join the node to the cluster
  command: "{{ kubeadm_join_command }} --ignore-preflight-errors=SystemVerification --v=5"
  become: true
