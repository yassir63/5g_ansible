---
- name: RESTART_K8S_JOIN
  ansible.builtin.meta: noop

# === CLEANUP (si le node avait déjà rejoint un cluster) ======================
- name: Check if node is already part of a Kubernetes cluster
  ansible.builtin.stat:
    path: /etc/kubernetes/kubelet.conf
  register: kubelet_conf

- name: Reset node if already part of a cluster
  ansible.builtin.command: kubeadm reset -f
  when: kubelet_conf.stat.exists
  ignore_errors: true
  become: true

- name: Remove Kubernetes data and CNI directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/cni/net.d
    - /var/lib/kubelet
    - /var/lib/cni
    - /run/flannel
  when: kubelet_conf.stat.exists
  become: true
  ignore_errors: true

- name: Restart container runtime
  ansible.builtin.systemd:
    name: containerd
    state: restarted
  become: true
  ignore_errors: true

- name: Wait for containerd to settle
  ansible.builtin.pause:
    seconds: 5

# === INSTALLATION DES PLUGINS CNI DE BASE ====================================
- name: Ensure CNI directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /etc/cni/net.d
    - /opt/cni/bin
    - /var/lib/cni
  become: true

- name: Download CNI plugins (via curl, plus fiable)
  ansible.builtin.shell: |
    curl -fsSL -o /tmp/cni-plugins.tgz \
      https://github.com/containernetworking/plugins/releases/download/v1.5.1/cni-plugins-linux-amd64-v1.5.1.tgz
  args:
    creates: /tmp/cni-plugins.tgz
  become: true

- name: Extract CNI plugins
  ansible.builtin.unarchive:
    src: /tmp/cni-plugins.tgz
    dest: /opt/cni/bin
    remote_src: true
  become: true

- name: Fix permissions
  ansible.builtin.file:
    path: /opt/cni/bin
    owner: root
    group: root
    mode: '0755'
    recurse: true
  become: true

- name: Verify essential CNI binaries exist
  ansible.builtin.stat:
    path: "/opt/cni/bin/{{ item }}"
  with_items:
    - loopback
    - bridge
    - portmap
  register: cni_check
  become: true

- name: Fail if essential CNI plugins are missing
  ansible.builtin.fail:
    msg: "❌ CNI plugin {{ item.item }} missing on node {{ inventory_hostname }}"
  when: not item.stat.exists
  loop: "{{ cni_check.results }}"

# === PREPARE JOIN ============================================================
- name: Ensure /root/.kube exists
  ansible.builtin.file:
    path: /root/.kube
    state: directory
    mode: '0755'
  become: true

- name: Fetch admin.conf from master to control machine
  ansible.builtin.fetch:
    src: /etc/kubernetes/admin.conf
    dest: ./admin.conf
    flat: yes
  delegate_to: "{{ groups['core_node'][0] }}"
  when: inventory_hostname == groups['k8s_workers'][0]

- name: Copy admin.conf to worker node
  ansible.builtin.copy:
    src: ./admin.conf
    dest: /root/.kube/config
    mode: '0644'
  become: true

- name: Ensure master node is resolvable
  ansible.builtin.lineinfile:
    path: /etc/hosts
    line: "{{ hostvars[groups['core_node'][0]].ip }} {{ groups['core_node'][0] }}"
  become: true

- name: Read join command
  ansible.builtin.set_fact:
    kubeadm_join_command: "{{ lookup('file', '/tmp/kubeadm_join_command.txt') }}"

- name: Debug join command
  ansible.builtin.debug:
    var: kubeadm_join_command

# === JOIN THE CLUSTER ========================================================
- name: Join node to the cluster
  ansible.builtin.command: "{{ kubeadm_join_command }} --ignore-preflight-errors=SystemVerification --v=5"
  become: true

# === WAIT FOR CLUSTER DNS (CoreDNS) TO BE READY ==============================
- name: Wait until CoreDNS pods are Ready
  become: true
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  ansible.builtin.shell: |
    kubectl wait -n kube-system --for=condition=Ready pod -l k8s-app=kube-dns --timeout=180s
  register: coredns_wait
  retries: 5
  delay: 10
  until: coredns_wait.rc == 0
  changed_when: false

# === WAIT UNTIL THE JOINED NODE IS READY =====================================
- name: Wait until CoreDNS pods are Ready
  become: true
  delegate_to: "{{ groups['core_node'][0] }}"
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  ansible.builtin.shell: |
    kubectl wait -n kube-system \
      --for=condition=Ready pod -l k8s-app=kube-dns \
      --timeout=300s
  register: coredns_wait
  retries: 5
  delay: 10
  until: coredns_wait.rc == 0
  changed_when: false

# === TEST COREDNS RESOLUTION FROM BOTH NODES ================================
- name: Test CoreDNS resolution from core and ran nodes
  become: true
  delegate_to: "{{ groups['core_node'][0] }}"
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  ansible.builtin.shell: |
    set -eux
    for NODE in {{ groups['core_node'][0] }} {{ groups['ran_node'][0] }}; do
      echo "=== Testing DNS on $NODE ==="
      kubectl run dns-test-$NODE \
        --image=busybox:1.36 \
        --restart=Never \
        --overrides='{"spec": {"nodeName": "'"${NODE}"'"}}' \
        --command -- sh -c 'nslookup kubernetes.default.svc.cluster.local' || true
    done

    echo "Cleaning up test pods..."
    kubectl delete pod dns-test-{{ groups['core_node'][0] }} --ignore-not-found
    kubectl delete pod dns-test-{{ groups['ran_node'][0] }} --ignore-not-found
  changed_when: false


