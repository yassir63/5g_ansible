---
# CLEANUP IF NODE WAS ALREADY JOINED
- name: Check if node is already part of a Kubernetes cluster
  stat:
    path: /etc/kubernetes/kubelet.conf
  register: kubelet_conf

- name: Reset node if already part of a cluster
  command: kubeadm reset -f
  when: kubelet_conf.stat.exists
  ignore_errors: true

- name: Remove Kubernetes CNI configuration
  file:
    path: /etc/cni/net.d
    state: absent
  when: kubelet_conf.stat.exists

- name: Remove kubelet data directory
  file:
    path: /var/lib/kubelet
    state: absent
  when: kubelet_conf.stat.exists

- name: Restart container runtime (containerd)
  service:
    name: containerd
    state: restarted
  when: kubelet_conf.stat.exists
  ignore_errors: true

- name: Wait for containerd
  pause:
    seconds: 10

# PRE-PULL PAUSE IMAGE (NATIVE + --LOCAL) â€” BEFORE KUBELET
- name: Pre-pull pause image with --local (fixes native unpack bug)
  ansible.builtin.shell: >
    ctr -n k8s.io images pull \
      --platform linux/{{ 'amd64' if ansible_architecture == 'x86_64' else 'arm64' }} \
      --snapshotter native \
      --local \
      registry.k8s.io/pause:3.10
  become: true
  register: pause_pull
  retries: 15
  delay: 10
  until: pause_pull.rc == 0
  changed_when: false

# PRE-PULL KUBE-PROXY (AVOIDS ErrImagePull)
- name: Pre-pull kube-proxy image with --local
  ansible.builtin.shell: >
    ctr -n k8s.io images pull \
      --platform linux/{{ 'amd64' if ansible_architecture == 'x86_64' else 'arm64' }} \
      --snapshotter native \
      --local \
      registry.k8s.io/kube-proxy:v1.32.9
  become: true
  register: proxy_pull
  retries: 15
  delay: 10
  until: proxy_pull.rc == 0
  changed_when: false

- name: Restart containerd after pause pull
  ansible.builtin.systemd:
    name: containerd
    state: restarted
  become: true

- name: Wait for containerd
  ansible.builtin.pause:
    seconds: 15

# BASE SETUP
- name: Ensure .kube directory exists on worker node
  file:
    path: /root/.kube
    state: directory
    mode: '0755'

- name: Fetch admin.conf from master to control machine
  fetch:
    src: /etc/kubernetes/admin.conf
    dest: ./admin.conf
    flat: yes
  delegate_to: "{{ groups['core_node'][0] }}"
  when: inventory_hostname == groups['k8s_workers'][0]

- name: Copy admin.conf from control machine to worker node
  copy:
    src: ./admin.conf
    dest: /root/.kube/config
    mode: '0644'
  become: true

# JOIN THE CLUSTER
- name: Read kubeadm join command from file
  set_fact:
    kubeadm_join_command: "{{ lookup('file', '/tmp/kubeadm_join_command.txt') }}"

- name: Debug join command
  debug:
    var: kubeadm_join_command

- name: Join the node to the cluster
  command: "{{ kubeadm_join_command }} --ignore-preflight-errors=SystemVerification --v=5"
  become: true
  register: join_result
  retries: 3
  delay: 10
  until: join_result.rc == 0