---
# Cleanup if the node was already part of a cluster
- name: Check if node is already part of a Kubernetes cluster
  stat:
    path: /etc/kubernetes/kubelet.conf
  register: kubelet_conf

- name: Reset node if already part of a cluster
  command: kubeadm reset -f
  when: kubelet_conf.stat.exists
  ignore_errors: true

- name: Remove Kubernetes CNI configuration
  file:
    path: /etc/cni/net.d
    state: absent
  when: kubelet_conf.stat.exists

- name: Remove kubelet data directory
  file:
    path: /var/lib/kubelet
    state: absent
  when: kubelet_conf.stat.exists

- name: Restart container runtime (containerd)
  service:
    name: containerd
    state: restarted
  when: kubelet_conf.stat.exists
  ignore_errors: true


# Base setup
- name: Ensure .kube directory exists on worker node
  file:
    path: /root/.kube
    state: directory
    mode: '0755'

- name: Fetch admin.conf from master to control machine
  fetch:
    src: /etc/kubernetes/admin.conf
    dest: ./admin.conf
    flat: yes
  delegate_to: "{{ groups['core_node'][0] }}"
  when: inventory_hostname == groups['k8s_workers'][0]

- name: Copy admin.conf from control machine to worker node
  copy:
    src: ./admin.conf
    dest: /root/.kube/config
    mode: '0644'
  become: true


# Read the standard join command
- name: Read kubeadm join command from file
  set_fact:
    kubeadm_join_command: "{{ lookup('file', '/tmp/kubeadm_join_command.txt') }}"

- name: Debug join command
  debug:
    var: kubeadm_join_command


# Detect if RT setup is required
- name: Detect if RT setup is required
  set_fact:
    is_rt: "{{ (hostvars[groups['faraday'][0]].rru in ['benetel1', 'benetel2']) and (inventory_hostname == groups['ran_node'][0]) }}"


# Generate a kubeadm token dynamically (on master)
- name: Generate kubeadm token for RT join
  command: kubeadm token create
  register: kubeadm_rt_token
  delegate_to: "{{ groups['core_node'][0] }}"
  run_once: true
  when: is_rt


# Create the RT kubeadm join config on the worker
- name: Generate RT kubeadm join config
  copy:
    dest: /tmp/kubeadm-join-rt.yaml
    content: |
      apiVersion: kubeadm.k8s.io/v1beta3
      kind: JoinConfiguration
      discovery:
        bootstrapToken:
          apiServerEndpoint: "{{ hostvars[groups['core_node'][0]].ansible_host }}:6443"
          token: "{{ kubeadm_rt_token.stdout }}"
          caCertHashes:
            - "{{ lookup('file', '/tmp/kubeadm_join_ca_hash.txt') }}"
      nodeRegistration:
        kubeletExtraArgs:
          cgroup-driver: systemd
          cpu-manager-policy: static
          cpu-manager-policy-options: "full-pcpus-only=true"
          reserved-cpus: "0-5"
          topology-manager-policy: best-effort
          fail-swap-on: "false"
          container-log-max-size: 50Mi
          feature-gates: "CPUManager=true,CPUManagerPolicyOptions=true,CPUManagerPolicyBetaOptions=true"
  when: is_rt
  become: true


# Join cluster
- name: Join Kubernetes cluster
  shell: >-
    {% if is_rt %}
    kubeadm join --config /tmp/kubeadm-join-rt.yaml
    {% else %}
    {{ kubeadm_join_command }}
    {% endif %}
  become: true
  register: join_result
  retries: 5
  delay: 10
  until: join_result.rc == 0


# Verify reserved CPUs (RT only)
- name: Verify reserved CPUs (RT nodes only)
  shell: "grep reserved-cpus /etc/default/kubelet || echo 'not set'"
  register: reserved_cpus
  changed_when: false
  failed_when: false
  when: is_rt

- name: Show reserved CPUs
  debug:
    msg: "âœ… Worker {{ inventory_hostname }} reserved CPUs: {{ reserved_cpus.stdout }}"
  when: is_rt