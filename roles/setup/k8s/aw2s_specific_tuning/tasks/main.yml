---
# roles/setup/k8s/aw2s_specific_tuning/tasks/main.yml

- name: Ensure CPUAffinity is set in system.conf
  become: true
  ansible.builtin.lineinfile:
    path: /etc/systemd/system.conf
    regexp: '^CPUAffinity='
    line: 'CPUAffinity=4-15'
    state: present

- name: Reload systemd config
  become: true
  ansible.builtin.command:
    cmd: systemctl daemon-reexec

- name: Add Kubernetes and RT settings to sysctl.conf
  become: true
  ansible.builtin.blockinfile:
    path: /etc/sysctl.conf
    insertafter: EOF
    block: |
      ## For kubernetes
      fs.inotify.max_user_instances=65536
      ## Realtime kernel settings
      kernel.sched_rt_runtime_us=-1
      kernel.timer_migration=0
    marker: "# {mark} RAN tuning"

- name: Apply sysctl changes (reload)
  become: true
  ansible.builtin.command:
    cmd: sysctl -p
  changed_when: false

- name: Ensure python3 and PyYAML are installed
  become: true
  ansible.builtin.apt:
    name:
      - python3
      - python3-yaml
    state: present
    update_cache: yes

- name: Merge CPU-only kubelet config safely
  become: true
  ansible.builtin.shell: |
    python3 - <<'EOF'
    import yaml, os
    cfg = "/var/lib/kubelet/config.yaml"
    patch = {
      "cgroupDriver": "systemd",
      "cpuManagerPolicy": "static",
      "cpuManagerPolicyOptions": {"full-pcpus-only": "true"},
      "reservedSystemCPUs": "4-15",
      "topologyManagerPolicy": "best-effort",
      "failSwapOn": False,
      "featureGates": {
        "CPUManager": True,
        "CPUManagerPolicyOptions": True
      }
    }
    if not os.path.exists(cfg): exit(0)
    with open(cfg) as f: data = yaml.safe_load(f) or {}
    data.setdefault("featureGates", {}).update(patch["featureGates"])
    for k,v in patch.items():
        if k != "featureGates": data[k] = v
    with open(cfg+".tmp","w") as f: yaml.safe_dump(data,f,default_flow_style=False,sort_keys=False)
    os.replace(cfg+".tmp", cfg)
    print("APPLIED")
    EOF
  register: merge_result
  changed_when: "'APPLIED' in merge_result.stdout"

# --- Patch containerRuntimeEndpoint et thresholds pour kubelet ---
- name: Patch kubelet containerRuntimeEndpoint and eviction thresholds
  become: true
  ansible.builtin.shell: |
    python3 - <<'EOF'
    import yaml, os
    cfg = "/var/lib/kubelet/config.yaml"
    if not os.path.exists(cfg): exit(0)
    with open(cfg) as f: data = yaml.safe_load(f) or {}
    # Patch container runtime endpoint
    data["containerRuntimeEndpoint"] = "unix:///var/run/containerd/containerd.sock"
    # Patch image GC thresholds
    data["imageGCHighThresholdPercent"] = 85
    data["imageGCLowThresholdPercent"] = 80
    # Patch eviction thresholds
    data.setdefault("evictionHard", {})
    data["evictionHard"]["nodefs.available"] = "10%"
    data["evictionHard"]["imagefs.available"] = "15%"
    with open(cfg+".tmp","w") as f: yaml.safe_dump(data,f,default_flow_style=False,sort_keys=False)
    os.replace(cfg+".tmp", cfg)
    print("KUBELET PATCHED")
    EOF
  register: kubelet_patch
  changed_when: "'KUBELET PATCHED' in kubelet_patch.stdout"

- name: Restart kubelet
  become: true
  ansible.builtin.systemd:
    name: kubelet
    state: restarted
    daemon_reload: yes

- name: Remove kubelet CPU manager checkpoint file
  become: true
  ansible.builtin.file:
    path: /var/lib/kubelet/cpu_manager_state
    state: absent
