---
- name: Ensure Open vSwitch is installed
  apt:
    name: openvswitch-switch
    state: present
    update_cache: yes
  become: true

- name: Create OVS bridges for ovs-cni
  command: "ovs-vsctl --may-exist add-br {{ item }}"
  loop:
    - n2br
    - n3br
    - n4br
  become: true

# --- Rendre le NetworkAddonsConfig localement ---
- name: Render NetworkAddonsConfig manifest locally
  ansible.builtin.template:
    src: "roles/setup/cni/templates/network-addons-config.yaml.j2"
    dest: "/tmp/network-addons-config.yaml"
    mode: '0644'
  delegate_to: localhost
  run_once: true

# --- Déployer le Cluster Network Addons Operator ---
- name: Apply Cluster-Network-Addons Operator & OVS-CNI (namespace, crd, operator)
  kubernetes.core.k8s:
    state: present
    src: "{{ item }}"
    kubeconfig: "{{ kubeconfig | default('/etc/kubernetes/admin.conf') }}"
  loop:
    - "https://github.com/kubevirt/cluster-network-addons-operator/releases/download/v0.89.1/namespace.yaml"
    - "https://github.com/kubevirt/cluster-network-addons-operator/releases/download/v0.89.1/network-addons-config.crd.yaml"
    - "https://github.com/kubevirt/cluster-network-addons-operator/releases/download/v0.89.1/operator.yaml"
  become: false

# --- Attendre un court instant pour la création des CRDs ---
- name: Wait 10 seconds for cluster-network-addons operator to initialize
  pause:
    seconds: 10

# --- Vérifier la présence du fichier /tmp/network-addons-config.yaml ---
- name: Check if /tmp/network-addons-config.yaml exists
  ansible.builtin.stat:
    path: "/tmp/network-addons-config.yaml"
  register: nad_tmp_stat

# --- Appliquer la configuration NetworkAddonsConfig locale ---
- name: Apply NetworkAddonsConfig from /tmp if present
  kubernetes.core.k8s:
    state: present
    src: "/tmp/network-addons-config.yaml"
    kubeconfig: "{{ kubeconfig | default('/etc/kubernetes/admin.conf') }}"
  when: nad_tmp_stat.stat.exists
  become: false

# --- RBAC minimal pour Multus (sécurisé, idempotent) ---
- name: Ensure Multus has cluster-wide RBAC permissions
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRole
      metadata:
        name: multus-clusterrole
      rules:
        - apiGroups: [""]
          resources: ["pods"]
          verbs: ["get", "list", "watch"]

- name: Ensure Multus ClusterRoleBinding exists
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: multus-clusterrolebinding
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: multus-clusterrole
      subjects:
        - kind: ServiceAccount
          name: multus
          namespace: kube-system

