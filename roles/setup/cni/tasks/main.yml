---
- name: RESTART_K8S_ADDS_ON
  ansible.builtin.meta: noop

- name: Ensure Open vSwitch is installed
  apt:
    name: openvswitch-switch
    state: present
    update_cache: yes
  become: true

- name: Create OVS bridges for ovs-cni
  command: "ovs-vsctl --may-exist add-br {{ item }}"
  loop:
    - n2br
    - n3br
    - n4br
  become: true

- name: Render NetworkAddonsConfig manifest locally
  ansible.builtin.template:
    src: network-addons-config.yaml.j2
    dest: /tmp/network-addons-config.yaml

- name: Apply Cluster-Network-Addons Operator manifests
  ansible.builtin.shell: |
    kubectl apply -f {{ item }}
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  loop:
    - "https://github.com/kubevirt/cluster-network-addons-operator/releases/download/v0.89.1/namespace.yaml"
    - "https://github.com/kubevirt/cluster-network-addons-operator/releases/download/v0.89.1/network-addons-config.crd.yaml"
    - "https://github.com/kubevirt/cluster-network-addons-operator/releases/download/v0.89.1/operator.yaml"
  become: true

- name: Wait for cluster-network-addons namespace to exist
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Namespace
    name: cluster-network-addons
    kubeconfig: /etc/kubernetes/admin.conf
  register: cnano_ns
  retries: 15
  delay: 5
  until: cnano_ns.resources | length > 0
  changed_when: false

- name: Wait for cluster-network-addons-operator to be ready
  ansible.builtin.shell: |
    kubectl -n cluster-network-addons rollout status deployment/cluster-network-addons-operator --timeout=300s
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: cnao_operator_wait
  retries: 5
  delay: 10
  until: cnao_operator_wait.rc == 0
  changed_when: false

- name: Apply NetworkAddonsConfig from /tmp
  kubernetes.core.k8s:
    state: present
    src: /tmp/network-addons-config.yaml
    kubeconfig: /etc/kubernetes/admin.conf
  changed_when: false

- name: Wait until NetworkAddonsConfig and all CNAO pods are Ready (robust)
  ansible.builtin.shell: |
    set -e
    echo "üîé Waiting up to 10 minutes for CNAO to be Ready..."
    for i in $(seq 1 60); do
      # Read CR status (may not exist early)
      phase=$(kubectl -n cluster-network-addons get networkaddonsconfig cluster \
        -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}' 2>/dev/null || echo "Unknown")
      # Count pods not yet Ready
      not_ready=$(kubectl -n cluster-network-addons get pods --no-headers 2>/dev/null | awk '$2!=$3 {print $1}')
      # Evaluate
      if [ -z "$not_ready" ] && { [ "$phase" = "True" ] || [ "$phase" = "Unknown" ]; }; then
        echo "‚úÖ CNAO appears Ready (pods OK, CR=$phase) on attempt $i"
        exit 0
      fi
      echo "‚è≥ CNAO not Ready yet (attempt $i): CR=$phase, pending pods=[$not_ready]"
      sleep 10
    done
    echo "‚ùå CNAO did not become Ready within 10 minutes"
    echo "--- POD STATUS ---"
    kubectl -n cluster-network-addons get pods -o wide || true
    echo "--- CR STATUS ---"
    kubectl -n cluster-network-addons get networkaddonsconfig cluster -o yaml || true
    exit 1
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: cnao_wait
  retries: 1
  delay: 0
  changed_when: false
  