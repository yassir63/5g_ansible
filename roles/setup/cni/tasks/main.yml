---
- name: Ensure Open vSwitch is installed
  apt:
    name: openvswitch-switch
    state: present
    update_cache: yes
  become: true

- name: Create OVS bridges for ovs-cni
  command: "ovs-vsctl --may-exist add-br {{ item }}"
  loop:
    - n2br
    - n3br
    - n4br
  become: true

- name: Render NetworkAddonsConfig manifest locally (role template -> /tmp)
  ansible.builtin.template:
    src: network-addons-config.yaml.j2
    dest: /tmp/network-addons-config.yaml
  become: false

- name: Apply Cluster-Network-Addons Operator manifests from URLs
  ansible.builtin.shell: |
    kubectl apply -f {{ item }}
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  loop:
    - "https://github.com/kubevirt/cluster-network-addons-operator/releases/download/v0.89.1/namespace.yaml"
    - "https://github.com/kubevirt/cluster-network-addons-operator/releases/download/v0.89.1/network-addons-config.crd.yaml"
    - "https://github.com/kubevirt/cluster-network-addons-operator/releases/download/v0.89.1/operator.yaml"
  become: true

- name: Wait for cluster-network-addons namespace to exist
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Namespace
    name: cluster-network-addons
    kubeconfig: /etc/kubernetes/admin.conf
  register: cnano_ns
  retries: 10
  delay: 5
  until: cnano_ns.resources | length > 0

- name: Wait for cluster-network-addons deployment to be ready
  shell: >
    kubectl -n cluster-network-addons rollout status deploy -l name=cluster-network-addons --timeout=180s
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: cnano_rollout
  failed_when: cnano_rollout.rc != 0
  become: true

- name: Apply NetworkAddonsConfig from /tmp (only after operator is ready)
  kubernetes.core.k8s:
    state: present
    src: /tmp/network-addons-config.yaml
    kubeconfig: "{{ kubeconfig | default('/etc/kubernetes/admin.conf') }}"
  become: false

- name: Ensure Multus has cluster-wide RBAC permissions (safe, creates role only)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRole
      metadata:
        name: multus-clusterrole
      rules:
        - apiGroups: [""]
          resources: ["pods"]
          verbs: ["get", "list", "watch"]

- name: Ensure Multus ClusterRoleBinding exists
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: multus-clusterrolebinding
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: multus-clusterrole
      subjects:
        - kind: ServiceAccount
          name: multus
          namespace: kube-system
