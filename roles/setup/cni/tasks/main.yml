---
- name: RESTART_K8S_ADDS_ON
  ansible.builtin.meta: noop

- name: Ensure Open vSwitch is installed
  apt:
    name: openvswitch-switch
    state: present
    update_cache: yes
  become: true
  when: full_oai == false

- name: Create OVS bridges for ovs-cni
  command: "ovs-vsctl --may-exist add-br {{ item }}"
  loop:
    - n2br
    - n3br
    - n4br
  become: true
  when: full_oai == false

- name: Render NetworkAddonsConfig manifest locally
  ansible.builtin.template:
    src: network-addons-config.yaml.j2
    dest: /tmp/network-addons-config.yaml

- name: Apply Cluster-Network-Addons Operator manifests
  ansible.builtin.shell: |
    kubectl apply -f {{ item }}
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  loop:
    - "https://github.com/kubevirt/cluster-network-addons-operator/releases/download/v0.89.1/namespace.yaml"
    - "https://github.com/kubevirt/cluster-network-addons-operator/releases/download/v0.89.1/network-addons-config.crd.yaml"
    - "https://github.com/kubevirt/cluster-network-addons-operator/releases/download/v0.89.1/operator.yaml"
  become: true

- name: Wait for cluster-network-addons namespace to exist
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Namespace
    name: cluster-network-addons
    kubeconfig: /etc/kubernetes/admin.conf
  register: cnano_ns
  retries: 15
  delay: 5
  until: cnano_ns.resources | length > 0
  changed_when: false

- name: Wait for cluster-network-addons-operator to be ready
  ansible.builtin.shell: |
    kubectl -n cluster-network-addons rollout status deployment/cluster-network-addons-operator --timeout=300s
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: cnao_operator_wait
  retries: 5
  delay: 10
  until: cnao_operator_wait.rc == 0
  changed_when: false

- name: Apply NetworkAddonsConfig from /tmp
  kubernetes.core.k8s:
    state: present
    src: /tmp/network-addons-config.yaml
    kubeconfig: /etc/kubernetes/admin.conf
  changed_when: false

# Wait for NetworkAddonsConfig CR status to show Available=True
- name: Wait for NetworkAddonsConfig to reach Available condition
  ansible.builtin.shell: |
    set -e
    for i in $(seq 1 60); do
      phase=$(kubectl -n cluster-network-addons get networkaddonsconfig cluster -o jsonpath='{.status.conditions[?(@.type=="Available")].status}' 2>/dev/null || echo "Unknown")
      echo "⏳ Waiting for NetworkAddonsConfig to be Available (attempt $i): $phase"
      if [ "$phase" = "True" ]; then
        echo "✅ NetworkAddonsConfig is Available"
        exit 0
      fi
      sleep 10
    done
    echo "❌ NetworkAddonsConfig did not become Available in time"
    exit 1
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: cnao_available
  retries: 3
  delay: 5
  until: cnao_available.rc == 0
  changed_when: false
