---
- name: RESTART_OVS_SETUP
  ansible.builtin.meta: noop

- name: Ensure OVS is installed
  ansible.builtin.apt:
    name: openvswitch-switch
    state: present
    update_cache: yes
  become: true

- name: Ensure OVS services are running
  ansible.builtin.service:
    name: "{{ item }}"
    state: started
    enabled: yes
  loop:
    - ovsdb-server
    - ovs-vswitchd
  become: true

- name: Define OVS bridges
  set_fact:
    ovs_bridges:
      - n2br
      - n3br
      - n4br

- name: Create OVS bridges
  ansible.builtin.command: "ovs-vsctl --may-exist add-br {{ item }}"
  loop: "{{ ovs_bridges }}"
  become: true

- name: Pin ovs-vswitchd on cores 0-5 (RAN node only)
  block:
    - name: Enable CPUAffinity override dir
      ansible.builtin.file:
        path: /etc/systemd/system/ovs-vswitchd.service.d
        state: directory
    - name: Apply CPUAffinity for ovs-vswitchd
      ansible.builtin.copy:
        dest: /etc/systemd/system/ovs-vswitchd.service.d/cpu-affinity.conf
        content: |
          [Service]
          CPUAffinity=0-5
    - name: Restart ovs-vswitchd with new affinity
      ansible.builtin.systemd:
        daemon_reload: yes
        name: ovs-vswitchd
        state: restarted
  become: true
  when: inventory_hostname in groups['ran_node']

# Following block currently unused, only for fhi72 to prevent system crash due to intecations between ovs and dpdk
- name: IRQ pinning on sopnode-f3 ens15f0np0 network interface to cores 14-31 
  block:
    - name: Find IRQs for ens15f0np0
      ansible.builtin.shell: >
        grep -i 'ens15f0np0' /proc/interrupts | awk '{print $1}' | tr -d ':'
      register: ovs_irq_list
      changed_when: false

    - name: Apply IRQ affinity live (CPU list)
      ansible.builtin.shell: >
        echo 14-31 > /proc/irq/{{ item }}/smp_affinity_list
      loop: "{{ ovs_irq_list.stdout_lines }}"

    - name: Make IRQ pinning persistent on reboot
      ansible.builtin.copy:
        dest: /etc/systemd/system/irq-affinity-ens15f0np0.service
        content: |
          [Unit]
          Description=Pin IRQs for ens15f0np0
          After=multi-user.target

          [Service]
          Type=oneshot
          ExecStart=/bin/sh -c 'for i in {{ ovs_irq_list.stdout_lines | join(" ") }}; do echo 14-31 > /proc/irq/$i/smp_affinity_list; done'

          [Install]
          WantedBy=multi-user.target

    - name: Enable IRQ affinity service
      ansible.builtin.systemd:
        daemon_reload: yes
        name: irq-affinity-ens15f0np0.service
        enabled: yes

  become: true
  when: fhi72 and inventory_hostname in groups['ran_node']

#  Verification
- name: Verify OVS daemons
  ansible.builtin.service_facts:

- name: Fail if ovsdb-server is not running
  ansible.builtin.fail:
    msg: "❌ ovsdb-server is not running on {{ inventory_hostname }}"
  when: services['ovsdb-server.service'].state != "running"

- name: Fail if ovs-vswitchd is not running
  ansible.builtin.fail:
    msg: "❌ ovs-vswitchd is not running on {{ inventory_hostname }}"
  when: services['ovs-vswitchd.service'].state != "running"

- name: Verify OVS bridges
  ansible.builtin.command: "ovs-vsctl br-exists {{ item }}"
  loop: "{{ ovs_bridges }}"
  become: true
  changed_when: false
  
