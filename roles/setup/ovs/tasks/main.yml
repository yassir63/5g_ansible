---
- name: RESTART_OVS_SETUP
  ansible.builtin.meta: noop

- name: Ensure APT cache is updated
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600
  become: true
  run_once: true

- name: Install Open vSwitch
  ansible.builtin.apt:
    name: openvswitch-switch
    state: present
  become: true

- name: Ensure ovsdb-server and ovs-vswitchd are running
  ansible.builtin.service:
    name: "{{ item }}"
    state: started
    enabled: yes
  loop:
    - ovsdb-server
    - ovs-vswitchd
  become: true

- name: Create list of OVS bridges
  set_fact:
    ovs_bridges:
      - n2br
      - n3br
      - n4br

- name: Create required OVS bridges
  ansible.builtin.command: "ovs-vsctl --may-exist add-br {{ item }}"
  loop: "{{ ovs_bridges }}"
  become: true

# ---------------- CPU AFFINITY (Only RAN nodes) ----------------
- name: Ensure directory for OVS override exists
  ansible.builtin.file:
    path: /etc/systemd/system/ovs-vswitchd.service.d
    state: directory
    mode: '0755'
  become: true
  when: inventory_hostname in groups['ran_node']

- name: Apply CPU pinning for ovs-vswitchd on RAN nodes
  ansible.builtin.copy:
    dest: /etc/systemd/system/ovs-vswitchd.service.d/cpu-affinity.conf
    content: |
      [Service]
      CPUAffinity=0-5
  become: true
  when: inventory_hostname in groups['ran_node']

- name: Reload systemd if CPUAffinity applied
  ansible.builtin.systemd:
    daemon_reload: yes
  become: true
  when: inventory_hostname in groups['ran_node']

- name: Restart ovs services if CPUAffinity applied
  ansible.builtin.service:
    name: "{{ item }}"
    state: restarted
  loop:
    - ovs-vswitchd
    - ovsdb-server
  become: true
  when: inventory_hostname in groups['ran_node']

# ---------------- VERIFICATION ----------------

- name: Verify daemons running
  ansible.builtin.service_facts:

- name: Fail if OVS daemons are not alive
  ansible.builtin.fail:
    msg: "Open vSwitch is not running correctly on {{ inventory_hostname }}"
  when:
    - services['ovsdb-server.service'].state != "running"
    - services['ovs-vswitchd.service'].state != "running"

- name: Verify bridges exist
  ansible.builtin.command: "ovs-vsctl br-exists {{ item }}"
  loop: "{{ ovs_bridges }}"
  register: bridge_check
  failed_when: bridge_check.rc != 0
  changed_when: false
  become: true
