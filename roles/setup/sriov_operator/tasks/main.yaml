---
- name: RESTART_HERE
  ansible.builtin.meta: noop

- name: Update APT package cache
  ansible.builtin.apt:
    update_cache: yes
  become: true

- name: Install Go 1.24.6 (simple, safe, working)
  become: yes
  block:
    - name: Download and install Go in one step
      ansible.builtin.shell: |
        curl -fsSL https://dl.google.com/go/go1.24.6.linux-amd64.tar.gz | \
        sudo tar -xz -C /usr/local
      args:
        creates: /usr/local/go/bin/go

    - name: Create symlink in /usr/local/bin
      ansible.builtin.file:
        src: /usr/local/go/bin/go
        dest: /usr/local/bin/go
        state: link
        force: yes

- name: Deploy SR-IOV Network Operator
  block:
    - name: Install git
      ansible.builtin.apt:
        name: git
        state: present
      become: yes

    - name: Clean up previous SR-IOV Network Operator directory
      ansible.builtin.file:
        path: /root/sriov-network-operator
        state: absent
      become: yes

    - name: Clone SR-IOV Network Operator
      ansible.builtin.git:
        repo: https://github.com/k8snetworkplumbingwg/sriov-network-operator.git
        dest: /root/sriov-network-operator
        clone: yes
        version: master
      become: yes

    # Fix: kubernetes Python lib + venv + correct pip path
    - name: Install python3-venv and python3-pip
      ansible.builtin.apt:
        name:
          - python3-venv
          - python3-pip
        state: present
      become: yes

    - name: Create Ansible Kubernetes venv
      ansible.builtin.command:
        cmd: python3 -m venv /opt/ansible-k8s-venv
        creates: /opt/ansible-k8s-venv/bin/activate
      become: yes

    - name: Install kubernetes Python library in venv using venv's pip
      ansible.builtin.pip:
        name: kubernetes
        state: present
        executable: /opt/ansible-k8s-venv/bin/pip
      become: yes

    - name: Set ansible_python_interpreter to use venv
      ansible.builtin.set_fact:
        ansible_python_interpreter: /opt/ansible-k8s-venv/bin/python

    # Deploy
    - name: Create namespace sriov-network-operator
      kubernetes.core.k8s:
        api_version: v1
        kind: Namespace
        name: sriov-network-operator
        state: present

    - name: Wait 10 seconds
      ansible.builtin.pause:
        seconds: 10

    - name: Deploy SR-IOV Operator via Make
      ansible.builtin.shell: |
        make deploy-setup-k8s
      args:
        chdir: /root/sriov-network-operator
      become: yes

# Verify
- name: Verify SR-IOV Network Operator deployment
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: sriov-network-operator
  register: sriov_pods

- name: Debug deployed pods
  ansible.builtin.debug:
    var: sriov_pods.resources
