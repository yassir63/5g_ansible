---
# Minimal pre-k8s fix: handle disk pressure without breaking cluster_join

# --- Detect live-boot system ---
- name: Detect if running from live Ubuntu
  ansible.builtin.shell: |
    grep -q "boot=live" /proc/cmdline && echo "live" || echo "persistent"
  register: live_image_check
  changed_when: false
  become: true

# --- Containerd storage ---
- name: Create /var/lib/containerd
  ansible.builtin.file:
    path: /var/lib/containerd
    state: directory
    mode: '0755'
  become: true

- name: Mount tmpfs or persistent storage for containerd
  ansible.builtin.mount:
    path: /var/lib/containerd
    src: "{{ 'tmpfs' if live_image_check.stdout == 'live' else '/dev/' + storage }}"
    fstype: "{{ 'tmpfs' if live_image_check.stdout == 'live' else 'ext4' }}"
    opts: "{{ 'size=50G' if live_image_check.stdout == 'live' else omit }}"
    state: mounted
  become: true

# --- Kubelet preparation ---
- name: Ensure kubelet directory exists
  ansible.builtin.file:
    path: /var/lib/kubelet
    state: directory
    mode: '0755'
  become: true

- name: Ensure kubelet config exists
  ansible.builtin.file:
    path: /var/lib/kubelet/config.yaml
    state: touch
    mode: '0644'
  become: true

- name: Patch kubelet config rootDir and evictionHard
  ansible.builtin.blockinfile:
    path: /var/lib/kubelet/config.yaml
    block: |
      rootDir: /var/lib/containerd
      evictionHard:
        nodefs.available: "10%"
        imagefs.available: "10%"
    marker: "# {mark} RAN pre-K8s patch"
  become: true

# --- Restart services ---
- name: Restart containerd if present
  ansible.builtin.systemd:
    name: containerd
    state: restarted
    enabled: yes
    daemon_reload: yes
  become: true
  when: "'containerd.service' in ansible_facts.services"

- name: Restart kubelet if present
  ansible.builtin.systemd:
    name: kubelet
    state: restarted
    enabled: yes
    daemon_reload: yes
  become: true
  when: "'kubelet.service' in ansible_facts.services"

# --- Validation (safe) ---
- name: Check /var/lib/containerd mount
  ansible.builtin.shell: mount | grep /var/lib/containerd || true
  register: containerd_mount
  changed_when: false
  become: true

- name: Show containerd mount
  ansible.builtin.debug:
    msg: "{{ containerd_mount.stdout if containerd_mount.stdout else 'not mounted' }}"

- name: Verify kubelet rootDir
  ansible.builtin.shell: grep 'rootDir' /var/lib/kubelet/config.yaml || true
  register: kubelet_root
  changed_when: false
  become: true

- name: Show kubelet rootDir
  ansible.builtin.debug:
    msg: "{{ kubelet_root.stdout }}"
