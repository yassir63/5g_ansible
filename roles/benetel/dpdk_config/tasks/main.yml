---
- name: Load variables from group_vars/ran_node.yml
  ansible.builtin.include_vars:
    file: /home/turletti/xp/post5g-beta/ptp_test/5g_ansible/group_vars/ran_node.yml

- name: Debug loaded variables
  ansible.builtin.debug:
    msg: |
      Loaded variables:
      dpdk_interface: {{ dpdk_interface }}
      dpdk_max_ring_buffer_size: {{ dpdk_max_ring_buffer_size }}
      dpdk_mtu: {{ dpdk_mtu }}
      dpdk_vlan: {{ dpdk_vlan }}
      dpdk_du_u_plane_mac: {{ dpdk_du_u_plane_mac }}
      dpdk_du_c_plane_mac: {{ dpdk_du_c_plane_mac }}
      dpdk_u_plane_pci: {{ dpdk_u_plane_pci }}
      dpdk_c_plane_pci: {{ dpdk_c_plane_pci }}
      dpdk_driver: {{ dpdk_driver }}
      
- name: Ensure pciutils is installed
  ansible.builtin.apt:
    name: pciutils
    state: present
    update_cache: true
  become: yes

- name: Ensure iavf module is present
  ansible.builtin.modprobe:
    name: iavf
    state: present
  become: yes

- name: Debug variables
  ansible.builtin.debug:
    msg: "Using dpdk_interface: {{ dpdk_interface }}, U-plane PCI: {{ dpdk_u_plane_pci }}, C-plane PCI: {{ dpdk_c_plane_pci }}, Driver: {{ dpdk_driver }}"

- name: Set maximum ring buffers
  ansible.builtin.command: >
    ethtool -G {{ dpdk_interface }} rx {{ dpdk_max_ring_buffer_size }} tx {{ dpdk_max_ring_buffer_size }}
  changed_when: true
  become: yes

- name: Set MTU on physical interface
  ansible.builtin.command: >
    ip link set {{ dpdk_interface }} mtu {{ dpdk_mtu }}
  changed_when: true
  become: yes

- name: "Step 1: Unbind any existing VFs"
  ansible.builtin.shell: |
    for vf in {{ dpdk_u_plane_pci }} {{ dpdk_c_plane_pci }}; do
      /usr/local/bin/dpdk-devbind.py --unbind $vf || true
    done
  args:
    executable: /bin/bash
  changed_when: true
  become: yes

- name: "Step 2: Reset VFs to zero"
  ansible.builtin.shell: echo 0 > /sys/class/net/{{ dpdk_interface }}/device/sriov_numvfs
  args:
    executable: /bin/bash
  changed_when: true
  become: yes
  ignore_errors: yes

- name: "Step 3: Verify no VFs remain"
  ansible.builtin.shell: dpdk-devbind.py --status | grep '{{ dpdk_interface }}' || true
  register: vf_status_reset
  changed_when: false
  become: yes

- name: "Step 4: Create 2 VFs"
  ansible.builtin.shell: echo 2 > /sys/class/net/{{ dpdk_interface }}/device/sriov_numvfs
  args:
    executable: /bin/bash
  changed_when: true
  become: yes
  ignore_errors: yes

- name: "Step 5: Configure VF 0 (U-plane)"
  ansible.builtin.command: >
    ip link set {{ dpdk_interface }} vf 0 mac {{ dpdk_du_u_plane_mac }} vlan {{ dpdk_vlan }} mtu {{ dpdk_mtu }}
  changed_when: true
  become: yes

- name: "Step 6: Configure VF 1 (C-plane)"
  ansible.builtin.command: >
    ip link set {{ dpdk_interface }} vf 1 mac {{ dpdk_du_c_plane_mac }} vlan {{ dpdk_vlan }} mtu {{ dpdk_mtu }}
  changed_when: true
  become: yes

- name: "Step 7: Bind U-plane VF to DPDK driver"
  ansible.builtin.command: /usr/local/bin/dpdk-devbind.py --bind {{ dpdk_driver }} {{ dpdk_u_plane_pci }}
  changed_when: true
  become: yes

- name: "Step 8: Bind C-plane VF to DPDK driver"
  ansible.builtin.command: /usr/local/bin/dpdk-devbind.py --bind {{ dpdk_driver }} {{ dpdk_c_plane_pci }}
  changed_when: true
  become: yes

- name: "Step 9: Verify VFs are bound to DPDK driver"
  ansible.builtin.shell: dpdk-devbind.py --status | grep {{ dpdk_driver }}
  register: vf_status_bound
  changed_when: false
  become: yes

- name: Debug VF binding status
  ansible.builtin.debug:
    msg: "U-plane PCI: {{ dpdk_u_plane_pci }}, C-plane PCI: {{ dpdk_c_plane_pci }}"
