---
 
- name: Ensure pciutils is installed
  ansible.builtin.apt:
    name: pciutils
    state: present
    update_cache: true

- name: Ensure iavf module is present
  ansible.builtin.modprobe:
    name: iavf
    state: present

- name: Set maximum ring buffers
  ansible.builtin.command: >
    ethtool -G {{ dpdk_interface }} rx {{ dpdk_max_ring_buffer_size }} tx {{ dpdk_max_ring_buffer_size }}
  changed_when: true

- name: Set MTU on physical interface
  ansible.builtin.command: >
    ip link set {{ dpdk_interface }} mtu {{ dpdk_mtu }}
  changed_when: true

- name: Restart ptp4l service after network configuration
  ansible.builtin.service:
    name: ptp4l@{{ dpdk_interface }}
    state: restarted
    enabled: yes
  ignore_errors: yes

- name: "Step 1: Unbind any existing VFs (safe)"
  ansible.builtin.shell: |
    for vf in {{ dpdk_u_plane_pci }} {{ dpdk_c_plane_pci }}; do
      /usr/local/bin/dpdk-devbind.py --unbind $vf || true
    done
  args:
    executable: /bin/bash
  changed_when: true

- name: "Step 2: Reset VFs to zero"
  ansible.builtin.shell: echo 0 > /sys/class/net/{{ dpdk_interface }}/device/sriov_numvfs
  args:
    executable: /bin/bash
  changed_when: true

- name: "Step 3: Verify no VFs remain"
  ansible.builtin.shell: dpdk-devbind.py --status | grep '{{ dpdk_interface }}' || true
  register: vf_status_reset
  changed_when: false

- name: "Step 4: Create 2 VFs"
  ansible.builtin.shell: echo 2 > /sys/class/net/{{ dpdk_interface }}/device/sriov_numvfs
  args:
    executable: /bin/bash
  changed_when: true

- name: "Step 5: Configure VF 0 (U-plane)"
  ansible.builtin.command: >
    ip link set {{ dpdk_interface }} vf 0 mac {{ dpdk_du_u_plane_mac }} vlan {{ dpdk_vlan }} mtu {{ dpdk_mtu }}
  changed_when: true

- name: "Step 6: Configure VF 1 (C-plane)"
  ansible.builtin.command: >
    ip link set {{ dpdk_interface }} vf 1 mac {{ dpdk_du_c_plane_mac }} vlan {{ dpdk_vlan }} mtu {{ dpdk_mtu }}
  changed_when: true

- name: "Step 7: Bind U-plane VF to DPDK driver"
  ansible.builtin.command: /usr/local/bin/dpdk-devbind.py --bind {{ dpdk_driver }} {{ dpdk_u_plane_pci }}
  changed_when: true

- name: "Step 8: Bind C-plane VF to DPDK driver"
  ansible.builtin.command: /usr/local/bin/dpdk-devbind.py --bind {{ dpdk_driver }} {{ dpdk_c_plane_pci }}
  changed_when: true

- name: "Step 9: Verify VFs are bound to DPDK driver"
  ansible.builtin.shell: dpdk-devbind.py --status | grep vfio-pci
  register: vf_status_bound
  changed_when: false


