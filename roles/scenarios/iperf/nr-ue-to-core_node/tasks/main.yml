---
- name: Set defaults
  set_fact:
    duration: "{{ iperf_duration | default(12) }}"
    sleep: "{{ iperf_sleep | default(5) }}"
    target_server: "{{ hostvars[groups['core_node'][0]].ip }}"
    core_ns: "{{ core }}"
    valid_ues: []

- name: Get all pods in namespace
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ core_ns }}"
  register: all_pods

- name: Filter UE pods by name
  set_fact:
    ue_resources: "{{ all_pods.resources | selectattr('metadata.name', 'search', '^oai-nr-ue') | list }}"

- name: Force Install iperf3 (YUM then APT)
  shell: |
    kubectl exec -n {{ core_ns }} {{ item.metadata.name }} -- bash -c "
    if ! command -v iperf3 &> /dev/null; then
      if command -v yum &> /dev/null; then
        yum install -y -q iperf3 iproute
      elif command -v apt-get &> /dev/null; then
        apt-get update -qq && apt-get install -y -qq iperf3 iproute2
      else
        echo 'No package manager found' && exit 1
      fi
    fi
    command -v iperf3"
  loop: "{{ ue_resources }}"
  loop_control:
    label: "Installing iperf3 on {{ item.metadata.name }}"
  register: install_check
  failed_when: install_check.rc != 0

# following solve issues with iperf
- name: Configure UE MTU to 1350
  shell: |
    kubectl exec -n {{ core_ns }} {{ item.metadata.name }} -- \
    ip link set dev oaitun_ue1 mtu 1350
  loop: "{{ ue_resources }}"
  loop_control:
    label: "Setting MTU 1350 on {{ item.metadata.name }}"
  register: mtu_result
  failed_when: false

- name: Get oaitun_ue1 IP
  shell: |
    kubectl exec -n {{ core_ns }} {{ item.metadata.name }} -- bash -c "
    ip -4 addr show oaitun_ue1 2>/dev/null | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | head -n1 | tr -d '\n\r '"
  loop: "{{ ue_resources }}"
  loop_control:
    label: "Getting IP for {{ item.metadata.name }}"
  register: ue_ip_results
  changed_when: false

- name: Init and Classify valid UEs
  set_fact:
    valid_ues: "{{ valid_ues + [ {'pod': item.item.metadata.name, 'ip': item.stdout | trim} ] }}"
  loop: "{{ ue_ip_results.results }}"
  loop_control:
    label: "{{ item.item.metadata.name }} -> {{ item.stdout | trim }}"
  when:
    - item.stdout is defined
    - item.stdout | trim is search('^[0-9.]+$')

- name: Show iperf uplink command
  debug:
    msg: >
      kubectl exec -n {{ core_ns }} {{ item.pod }} --
      iperf3 -B {{ item.ip }} -c {{ target_server }} -p {{ (5201 + idx | int) }} -t {{ duration | int }}
  loop: "{{ valid_ues }}"
  loop_control:
    index_var: idx
    label: "Uplink CMD: {{ item.pod }}"

- name: Run iperf uplink
  shell: >
    kubectl exec -n {{ core_ns }} {{ item.pod }} --
    iperf3 -B {{ item.ip }} -c {{ target_server }} -p {{ (5201 + idx | int) }} -t {{ duration | int }}
  loop: "{{ valid_ues }}"
  loop_control:
    index_var: idx
    label: "Uplink: {{ item.pod }} (Port: {{ 5201 + idx | int }})"
  ignore_errors: yes

- name: Wait for sockets to clear
  pause:
    seconds: "{{ sleep }}"

- name: Show iperf downlink command
  debug:
    msg: >
      kubectl exec -n {{ core_ns }} {{ item.pod }} --
      iperf3 -B {{ item.ip }} -c {{ target_server }} -p {{ (5201 + idx | int) }} -t {{ duration | int }} -R
  loop: "{{ valid_ues }}"
  loop_control:
    index_var: idx
    label: "Downlink CMD: {{ item.pod }}"

- name: Run iperf downlink
  shell: >
    kubectl exec -n {{ core_ns }} {{ item.pod }} --
    iperf3 -B {{ item.ip }} -c {{ target_server }} -p {{ (5201 + idx | int) }} -t {{ duration | int }} -R
  loop: "{{ valid_ues }}"
  loop_control:
    index_var: idx
    label: "Downlink: {{ item.pod }} (Port: {{ 5201 + idx | int }})"
  ignore_errors: yes
