---
- name: Set defaults
  set_fact:
    duration: "{{ duration | default(10) }}"
    sleep: "{{ sleep | default(5) }}"
    core_ip: "{{ hostvars[groups['core_node'][0]].ip }}"

- name: Get NR-UE pods
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: open5gs
    label_selectors:
      - "app=oai-nr-ue"
  register: ue_pods

- name: Install iperf3 and get oaitun_ue1 IP
  shell: |
    kubectl exec -n open5gs {{ item.metadata.name }} -- bash -c '
      if ! command -v iperf3 >/dev/null 2>&1; then
        if command -v apt-get >/dev/null 2>&1; then
          apt-get update -qq && apt-get install -y -qq iperf3 iproute2
        elif command -v yum >/dev/null 2>&1; then
          yum install -y -q iperf3 iproute
        fi
      fi
      ip -4 addr show oaitun_ue1 2>/dev/null \
        | grep -oP "(?<=inet\s)\d+(\.\d+){3}" \
        | head -n1 || echo ""
    '
  loop: "{{ ue_pods.resources }}"
  register: ue_ip_results
  changed_when: false

- name: Init UE lists
  set_fact:
    valid_ues: []
    invalid_ues: []

- name: Classify UEs
  set_fact:
    valid_ues: "{{ valid_ues + [ {'pod': item.item.metadata.name, 'ip': item.stdout} ] }}"
    invalid_ues: "{{ invalid_ues + [ item.item.metadata.name ] }}"
  loop: "{{ ue_ip_results.results }}"
  when: item.stdout != ""
  
- name: Warn for UEs with no IP
  debug:
    msg: "UE {{ item }} has no IP"
  loop: "{{ ue_ip_results.results }}"
  when: item.stdout == ""

- name: Pause
  pause:
    seconds: "{{ sleep }}"

- name: Run iperf uplink
  shell: >
    kubectl exec -n open5gs {{ item.pod }} -- iperf3 -B {{ item.ip }} -c {{ core_ip }} -t {{ duration }}
  loop: "{{ valid_ues }}"
  ignore_errors: yes

- name: Pause
  pause:
    seconds: "{{ sleep }}"

- name: Run iperf downlink
  shell: >
    kubectl exec -n open5gs {{ item.pod }} -- iperf3 -B {{ item.ip }} -c {{ core_ip }} -t {{ duration }} -R
  loop: "{{ valid_ues }}"
  ignore_errors: yes

- name: Pause
  pause:
    seconds: "{{ sleep }}"
