---
- name: Set default vars
  set_fact:
    duration: "{{ duration | default(10) }}"
    sleep: "{{ sleep | default(5) }}"
    core_ip: "{{ hostvars[groups['core_node'][0]].ip }}"

- name: Get list of NR-UE pods
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: open5gs
    label_selectors:
      - "app=oai-nr-ue"
  register: ue_pods

- name: Install iperf3 and get oaitun_ue1 IPs on NR-UEs
  shell: |
    #!/bin/bash
    if ! command -v iperf3 >/dev/null 2>&1; then
      if command -v apt-get >/dev/null 2>&1; then
        apt-get update -qq && apt-get install -y -qq iperf3 iproute2
      elif command -v yum >/dev/null 2>&1; then
        yum install -y -q iperf3 iproute
      fi
    fi
    ip -4 addr show oaitun_ue1 | grep -oP "(?<=inet\s)\d+(\.\d+){3}" | head -n1 || echo ""
  loop: "{{ ue_pods.resources }}"
  args:
    executable: /bin/bash
  register: ue_setup
  changed_when: false

- name: Filter out UEs without oaitun_ue1 IP
  set_fact:
    ue_list: "{{ ue_list_filtered }}"
    ue_ips: "{{ ue_ips_filtered }}"
  vars:
    ue_list_raw: "{{ ue_pods.resources | map(attribute='metadata.name') | list }}"
    ue_ips_raw: "{{ ue_setup.results | map(attribute='stdout') | list }}"
    ue_list_filtered: >-
      {{ ue_list_raw | zip(ue_ips_raw) | selectattr('1','!=','') | map('first') | list }}
    ue_ips_filtered: >-
      {{ ue_list_raw | zip(ue_ips_raw) | selectattr('1','!=','') | map('last') | list }}

- name: Warn for UEs without IP
  debug:
    msg: "UE {{ item.0 }} has no oaitun_ue1 IP and will be skipped"
  loop: "{{ ue_list_raw | zip(ue_ips_raw) | selectattr('1','==','') | list }}"
  when: ue_list_raw | zip(ue_ips_raw) | selectattr('1','==','') | list | length > 0

# ----------------- Uplink tests -----------------
- name: Run iperf3 uplink tests on all NR-UEs
  vars:
    pod_name: "{{ item.0 }}"
    pod_ip: "{{ item.1 }}"
  shell: kubectl -n open5gs exec {{ pod_name }} -- bash -c 'iperf3 -B {{ pod_ip }} -c {{ core_ip }} -t {{ duration }}'
  register: uplink_result
  ignore_errors: yes
  loop: "{{ ue_list | zip(ue_ips) | list }}"

- name: Pause between uplink tests
  pause:
    seconds: "{{ sleep }}"

# ----------------- Downlink tests -----------------
- name: Run iperf3 downlink tests on all NR-UEs
  vars:
    pod_name: "{{ item.0 }}"
    pod_ip: "{{ item.1 }}"
  shell: kubectl -n open5gs exec {{ pod_name }} -- bash -c 'iperf3 -B {{ pod_ip }} -c {{ core_ip }} -t {{ duration }} -R'
  register: downlink_result
  ignore_errors: yes
  loop: "{{ ue_list | zip(ue_ips) | list }}"

- name: Pause between downlink tests
  pause:
    seconds: "{{ sleep }}"
