---
- name: Set default vars
  set_fact:
    duration: "{{ duration | default(10) }}"
    sleep: "{{ sleep | default(5) }}"
    core_ip: "{{ hostvars[groups['core_node'][0]].ip }}"

- name: Get list of NR-UE pods
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: open5gs
    label_selectors:
      - "app=oai-nr-ue"
  register: ue_pods

- name: Install iperf3 and get oaitun_ue1 IPs on NR-UEs
  shell: |
    if ! command -v iperf3 >/dev/null 2>&1; then
      if command -v apt-get >/dev/null 2>&1; then
        apt-get update -qq && apt-get install -y -qq iperf3 iproute2
      elif command -v yum >/dev/null 2>&1; then
        yum install -y -q iperf3 iproute
      fi
    fi
    ip -4 addr show oaitun_ue1 2>/dev/null | grep -oP "(?<=inet\s)\d+(\.\d+){3}" | head -n1 || echo ""
  loop: "{{ ue_pods.resources }}"
  args:
    executable: /bin/bash
  register: ue_setup
  changed_when: false

- name: Build UE lists
  set_fact:
    ue_list_valid: >-
      {{ ue_setup.results
         | zip(ue_pods.resources)
         | selectattr('0.stdout','!=','')
         | map('last')
         | map(attribute='metadata.name')
         | list }}
    ue_ips_valid: >-
      {{ ue_setup.results
         | map(attribute='stdout')
         | reject('equalto','')
         | list }}
    ue_list_invalid: >-
      {{ ue_setup.results
         | zip(ue_pods.resources)
         | selectattr('0.stdout','equalto','')
         | map('last')
         | list }}

- name: Warn for UEs without IP
  debug:
    msg: "UE number {{ idx + 1 }} (pod {{ item.metadata.name }}) has no oaitun_ue1 IP and will be skipped"
  loop: "{{ ue_list_invalid }}"
  loop_control:
    index_var: idx

- name: Run iperf3 uplink tests on valid NR-UEs
  shell: kubectl -n open5gs exec {{ item.0 }} -- bash -c 'iperf3 -B {{ item.1 }} -c {{ hostvars[groups["core_node"][0]].ip }} -t {{ duration | default(10) }}'
  loop: "{{ ue_list_valid | zip(ue_ips_valid) | list }}"
  ignore_errors: yes

- name: Pause between uplink tests
  pause:
    seconds: "{{ sleep | default(5) }}"

- name: Run iperf3 downlink tests on valid NR-UEs
  shell: kubectl -n open5gs exec {{ item.0 }} -- bash -c 'iperf3 -B {{ item.1 }} -c {{ hostvars[groups["core_node"][0]].ip }} -t {{ duration | default(10) }} -R'
  loop: "{{ ue_list_valid | zip(ue_ips_valid) | list }}"
  ignore_errors: yes

- name: Pause between downlink tests
  pause:
    seconds: "{{ sleep | default(5) }}"
