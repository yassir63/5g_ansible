---
#
# Deploy iperf servers on core_node with session-based reporting
#

- name: Set defaults
  set_fact:
    duration: "{{ duration | default(10) }}"
    sleep: "{{ sleep | default(5) }}"
    core_ip: "{{ hostvars[groups['core_node'][0]].ip }}"

- name: Get all pods in namespace
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: open5gs
  register: all_pods

- name: Filter UE pods by name
  set_fact:
    ue_resources: "{{ all_pods.resources | selectattr('metadata.name', 'search', '^oai-nr-ue') | list }}"

- name: Force Install iperf3 (Checking for existing installation first)
  shell: |
    kubectl exec -n open5gs {{ item.metadata.name }} -- bash -c "
    if ! command -v iperf3 &> /dev/null; then
      apt-get update -qq && apt-get install -y -qq iperf3 iproute2
    fi
    which iperf3"
  loop: "{{ ue_resources }}"
  loop_control:
    label: "Checking/Installing iperf3 on {{ item.metadata.name }}"
  register: install_check
  # On arrÃªte tout si iperf3 ne peut vraiment pas Ãªtre installÃ©
  failed_when: install_check.rc != 0 

- name: Get oaitun_ue1 IP
  shell: |
    kubectl exec -n open5gs {{ item.metadata.name }} -- bash -c "
    ip -4 addr show oaitun_ue1 2>/dev/null | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | head -n1 | tr -d '\n\r '"
  loop: "{{ ue_resources }}"
  loop_control:
    label: "Getting IP for {{ item.metadata.name }}"
  register: ue_ip_results
  changed_when: false

- name: Init UE lists
  set_fact:
    valid_ues: []

- name: Classify valid UEs
  set_fact:
    valid_ues: "{{ valid_ues + [ {'pod': item.item.metadata.name, 'ip': item.stdout | trim} ] }}"
  loop: "{{ ue_ip_results.results }}"
  loop_control:
    label: "{{ item.item.metadata.name }} -> {{ item.stdout | trim }}"
  when:
    - item.stdout is defined
    - item.stdout | trim is search('([0-9]{1,3}\.){3}[0-9]{1,3}')

- name: Run iperf uplink
  shell: >
    kubectl exec -n open5gs {{ item.pod }} --
    iperf3 -B {{ item.ip }} -c {{ core_ip }} -p {{ (5201 + idx | int) }} -t {{ duration | int }}
  loop: "{{ valid_ues }}"
  loop_control:
    index_var: idx
    label: "{{ item.pod }} (Port: {{ 5201 + idx | int }})"
  register: uplink_results
  ignore_errors: yes

- name: Wait for sockets to clear
  pause:
    seconds: 2

- name: Run iperf downlink
  shell: >
    kubectl exec -n open5gs {{ item.pod }} --
    iperf3 -B {{ item.ip }} -c {{ core_ip }} -p {{ (5201 + idx | int) }} -t {{ duration | int }} -R
  loop: "{{ valid_ues }}"
  loop_control:
    index_var: idx
    label: "{{ item.pod }} (Port: {{ 5201 + idx | int }})"
  ignore_errors: yes

# --- SUMMARY DISPLAY ---

- name: Read session logs from Core Node
  command: "cat {{ item.path }}"
  loop: "{{ iperf_files.files | default([]) | sort(attribute='path') }}"
  loop_control:
    label: "{{ item.path | basename }}"
  register: log_contents
  delegate_to: "{{ groups['core_node'][0] }}"
  when: iperf_files.files is defined
  changed_when: false

- name: "ðŸ“Š FINAL SUMMARY"
  debug:
    msg: "{{ report_lines }}"
  vars:
    report_lines: |
      {% set reports = [] %}
      {% for log in log_contents.results | default([]) %}
      {% if log.stdout is defined %}
      {{ '========================================' }}
      {{ 'FILE: ' ~ log.item.path | basename }}
      {{ '========================================' }}
      {{ log.stdout }}
      {% endif %}
      {% endfor %}
