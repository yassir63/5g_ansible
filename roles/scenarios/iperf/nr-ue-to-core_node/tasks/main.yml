- name: Set defaults
  set_fact:
    duration: "{{ duration | default(10) }}"
    sleep: "{{ sleep | default(5) }}"
    core_ip: "{{ hostvars[groups['core_node'][0]].ip }}"

- name: Get NR-UE pods
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: open5gs
    label_selectors:
      - "app=oai-nr-ue"
  register: ue_pods

# -------------------------------------------------------
# Récupération des IPs réelles dans les pods
# -------------------------------------------------------

- name: Get UE tunnel IPs
  shell: |
    kubectl -n open5gs exec {{ item.metadata.name }} -- \
    ip -4 addr show oaitun_ue1 2>/dev/null | awk '/inet /{print $2}' | cut -d/ -f1
  loop: "{{ ue_pods.resources }}"
  register: ue_ips
  changed_when: false

# -------------------------------------------------------
# Boucle simple, fiable
# -------------------------------------------------------

- name: Run iperf uplink if IP exists
  shell: |
    kubectl -n open5gs exec {{ item.item.metadata.name }} -- \
    iperf3 -B {{ item.stdout }} -c {{ core_ip }} -t {{ duration }}
  loop: "{{ ue_ips.results }}"
  when: item.stdout != ""
  ignore_errors: true

- name: Warn if UE has no IP
  debug:
    msg: "UE {{ loop.index }} ({{ item.item.metadata.name }}) has NO tun IP"
  loop: "{{ ue_ips.results }}"
  when: item.stdout == ""

- pause:
    seconds: "{{ sleep }}"

# -------------------------------------------------------
# DOWNLINK
# -------------------------------------------------------

- name: Run iperf downlink if IP exists
  shell: |
    kubectl -n open5gs exec {{ item.item.metadata.name }} -- \
    iperf3 -B {{ item.stdout }} -c {{ core_ip }} -t {{ duration }} -R
  loop: "{{ ue_ips.results }}"
  when: item.stdout != ""
  ignore_errors: true

- pause:
    seconds: "{{ sleep }}"
