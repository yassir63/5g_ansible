---
- name: Set default vars
  set_fact:
    duration: "{{ duration | default(10) }}"
    sleep: "{{ sleep | default(5) }}"
    core_ip: "{{ hostvars[groups['core_node'][0]].ip }}"

- name: Get list of NR-UE pods
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: open5gs
  register: ue_pods

- name: Install iperf3 and get oaitun_ue1 IPs
  shell: |
    kubectl -n open5gs exec {{ item.metadata.name }} -- bash -c '
      set -euo pipefail
      if ! command -v iperf3 >/dev/null 2>&1; then
        yum update -y -qq && yum install -y -qq iperf3
      fi
      ip -4 addr show oaitun_ue1 | grep -oP "(?<=inet\s)\d+(\.\d+){3}"'
  loop: "{{ ue_pods.resources }}"
  register: ue_setup
  changed_when: false

- name: Build UE facts
  set_fact:
    ue_list: "{{ ue_pods.resources | map(attribute='metadata.name') | list }}"
    ue_ips: "{{ ue_setup.results | map(attribute='stdout') | list }}"

- name: Run iperf3 uplink tests on all NR-UEs
  loop: "{{ ue_list | zip(ue_ips) | list }}"
  loop_control:
    loop_var: ue
  vars:
    pod_name: "{{ ue[0] }}"
    pod_ip: "{{ ue[1] }}"
  block:
    - name: Uplink test
      shell: kubectl -n open5gs exec {{ pod_name }} -- bash -c 'iperf3 -B {{ pod_ip }} -c {{ core_ip }} -t {{ duration }}'
      register: uplink_result
      ignore_errors: yes

    - name: Wait between tests
      pause:
        seconds: "{{ sleep }}"

- name: Run iperf3 downlink tests on all NR-UEs
  loop: "{{ ue_list | zip(ue_ips) | list }}"
  loop_control:
    loop_var: ue
  vars:
    pod_name: "{{ ue[0] }}"
    pod_ip: "{{ ue[1] }}"
  block:
    - name: Downlink test
      shell: kubectl -n open5gs exec {{ pod_name }} -- bash -c 'iperf3 -B {{ pod_ip }} -c {{ core_ip }} -t {{ duration }} -R'
      register: downlink_result
      ignore_errors: yes

    - name: Wait between tests
      pause:
        seconds: "{{ sleep }}"
