---
#
# Deploy iperf servers on core_node with session-based reporting
#

- name: Set defaults
  set_fact:
    base_port: 5201
    actual_nb_ues: "{{ nb_ues | default(3) | int }}"

- name: Kill ANY existing iperf3 process
  shell: pkill iperf3 || true
  become: true
  changed_when: false

- name: Create base directory for iperf logs
  file:
    path: /root/IPERF
    state: directory
    mode: "0755"

- name: Get session timestamp
  command: date +"%Y%m%d_%H%M%S"
  register: iperf_timestamp
  changed_when: false

- name: Start iperf3 servers on incremental ports
  shell: >
    iperf3 -s -p {{ base_port + item | int }} -D 
    --logfile /root/IPERF/iperf_{{ base_port + item | int }}_{{ iperf_timestamp.stdout }}.log
  loop: "{{ range(0, actual_nb_ues | int) | list }}"
  become: true
  loop_control:
    label: "Port {{ base_port + item | int }}"

- name: Wait for tests to complete
  pause:
    seconds: "{{ duration | default(10) | int + 5 }}"
  comment: "On attend la fin des tests clients avant de lire les logs"

- name: Get CURRENT session log files
  find:
    paths: /root/IPERF
    patterns: "iperf_*_{{ iperf_timestamp.stdout }}.log"
  register: iperf_files

- name: Read session logs
  command: "cat {{ item.path }}"
  loop: "{{ iperf_files.files | sort(attribute='path') }}"
  loop_control:
    label: "{{ item.path | basename }}"
  register: log_contents
  changed_when: false

- name: "ðŸ“Š RECAPITULATIF DES TESTS IPERF (Session: {{ iperf_timestamp.stdout }})"
  debug:
    msg: |
      {% for log in log_contents.results %}
      ======================================================================
      FILE: {{ log.item.path | basename }}
      ======================================================================
      {{ log.stdout }}

      {% endfor %}

- name: Verify servers are listening
  shell: netstat -tulpn | grep iperf3
  register: iperf_status
  changed_when: false
  failed_when: false

- name: Debug server status
  debug:
    var: iperf_status.stdout_lines
