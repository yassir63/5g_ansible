---
# Start a dedicated iperf3 server for this UE on a unique port
- name: Start iperf3 server on port {{ iperf_port }}
  shell: "iperf3 -s -p {{ iperf_port }} -D --logfile /root/IPERF/iperf_{{ current_ue }}.log"
  delegate_to: "{{ groups['core_node'][0] }}"

# Display iPerf parameters before launching the client
- name: "Display iPerf parameters for {{ current_ue }}"
  debug:
    msg:
      - "--- IPERF3 CONFIGURATION ---"
      - "UE Host: {{ current_ue }}"
      - "Port: {{ iperf_port }}"
      - "Binding to Local IP: {{ ue_ip_cmd.stdout | default('NOT FOUND') }}"
      - "Connecting to Core IP: {{ core_ip }}"

# Run Uplink test
- name: Run uplink iperf from {{ current_ue }}
  shell: |
    ssh -o BatchMode=yes root@{{ current_ue }} \
    "iperf3 -p {{ iperf_port }} -B {{ ue_ip_cmd.stdout }} -c {{ core_ip }} -t {{ duration }} -J > /tmp/log_iperf_{{ current_ue }}_up.json"
  ignore_errors: "{{ ignore_task_errors | default(false) }}"
  when: ue_ip_cmd.stdout is defined and ue_ip_cmd.stdout != ""

- pause:
    seconds: "{{ sleep }}"

# Run Downlink test (Reverse mode)
- name: Run downlink iperf from {{ current_ue }}
  shell: |
    ssh -o BatchMode=yes root@{{ current_ue }} \
    "iperf3 -p {{ iperf_port }} -B {{ ue_ip_cmd.stdout }} -c {{ core_ip }} -t {{ duration }} -R -J > /tmp/log_iperf_{{ current_ue }}_down.json"
  ignore_errors: "{{ ignore_task_errors | default(false) }}"
  when: ue_ip_cmd.stdout is defined and ue_ip_cmd.stdout != ""

# Stop the dedicated iperf3 server
- name: Stop iperf3 server on port {{ iperf_port }}
  shell: "pkill -f 'iperf3 -s -p {{ iperf_port }}'"
  delegate_to: "{{ groups['core_node'][0] }}"
  ignore_errors: true

- name: Fetch iperf3 uplink JSON results for {{ current_ue }}
  fetch:
    # Use the path defined in your "Run uplink iperf" task
    src: "/tmp/log_iperf_{{ current_ue }}_up.json"
    dest: "{{ playbook_dir }}/results/{{ current_ue }}_log_ul_test.json"
    flat: yes
  # Run this fetch via Faraday since the file is on the UE accessed via Faraday
  # Note: Ensure Faraday has connectivity to pull this, or use a ProxyJump if needed.

- name: Extract Uplink average throughput for {{ current_ue }}
  local_action: 
    module: shell
    cmd: "jq '.end.sum_sent.bits_per_second' {{ playbook_dir }}/results/{{ current_ue }}_log_ul_test.json"
  register: ul_raw_value
  changed_when: false
  ignore_errors: true

- name: Print Uplink Mbps results for {{ current_ue }}
  debug:
    msg: "UE {{ current_ue }} Uplink Average Throughput: {{ (ul_raw_value.stdout | default(0) | float / 1000000) | round(2) }} Mbps"
  when: ul_raw_value.stdout is defined and ul_raw_value.stdout != ""

# Final pause before next UE
- name: Pause between UEs
  pause:
    seconds: "{{ sleep }}"