---
- name: Set defaults and initialize ue_ips dictionary
  set_fact:
    ue_ips: {}
    ignore_task_errors: true
    target_server: "{{ hostvars[groups['core_node'][0]].ip }}"
    duration: "{{ iperf_duration | default(12) }}"
    sleep: "{{ iperf_sleep | default(5) }}"

- name: Connect all qhat UEs sequentially
  include_tasks: connect_ue.yml
  loop: "{{ groups['qhats'] }}"
  loop_control:
    loop_var: current_ue
    index_var: ue_index
  vars:
    target_server: "{{ hostvars[groups['core_node'][0]].ip }}"
    iperf_port: "{{ 5201 + ue_index }}"
    ignore_task_errors: true

- name: Execute iperf tests for all connected UEs
  include_tasks: iperf_execution.yml
  loop: "{{ groups['qhats'] }}"
  loop_control:
    loop_var: current_ue
    index_var: ue_index
  vars:
    ue_ip_cmd:
      stdout: "{{ ue_ips[current_ue] }}"
    iperf_port: "{{ 5201 + ue_index }}"
    target_server: "{{ hostvars[groups['core_node'][0]].ip }}"
    duration: "{{ iperf_duration | default(12) }}"
    sleep: "{{ iperf_sleep | default(2) }}"
    ignore_task_errors: true
    sleep: 2
