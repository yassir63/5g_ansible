---
- name: Set defaults and initialize ue_ips dictionary
  set_fact:
    core_node_host: "{{ groups['core_node'][0] }}"
    ue_ips: {}

- name: Connect all qhat UEs sequentially
  include_tasks: connect_ue.yml
  loop: "{{ groups['qhats'] }}"
  loop_control:
    loop_var: current_ue
    index_var: ue_index # Use index (0, 1, 2...)
  vars:
    core_ip: "{{ hostvars[groups['core_node'][0]].ip }}"
    # Each UE gets a unique port: 5201, 5202, 5203...
    iperf_port: "{{ 5201 + ue_index }}"

- name: "--- COLLECTING SERVER-SIDE STATS FROM CORE NODE ---"
  block:
    - name: Find iperf log files on Core Node
      find:
        paths: "/root/IPERF"
        # Adjusted pattern to match common iperf server log naming
        patterns: "iperf_*.log"
      delegate_to: "{{ core_node_host }}"
      register: iperf_files

    - name: Read session logs from Core Node
      command: "cat {{ item.path }}"
      loop: "{{ iperf_files.files | sort(attribute='path') }}"
      loop_control:
        label: "Reading {{ item.path | basename }}"
      register: log_contents
      delegate_to: "{{ core_node_host }}"
      when: iperf_files.matched > 0
      changed_when: false

    - name: "ðŸ“Š FINAL SUMMARY (Server Side)"
      debug:
        msg: |
          {% for log in log_contents.results %}
          {% if log.stdout is defined %}
          ============================================================
          FILE: {{ log.item.path | basename }}
          ============================================================
          {{ log.stdout }}
          {% endif %}
          {% endfor %}
      when: log_contents.results is defined