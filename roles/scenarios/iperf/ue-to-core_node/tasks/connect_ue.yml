---
- name: Check if {{ current_ue }} already has a wwan0 IP
  shell: |
    ssh -o ConnectTimeout=5 -o BatchMode=yes -o StrictHostKeyChecking=no root@{{ current_ue }} \
    "ip -4 addr show wwan0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}'"
  register: check_ip_ready
  changed_when: false
  ignore_errors: true

- name: Connect UE {{ current_ue }} to 5G network (if not connected)
  include_role:
    name: r2lab/ue/connect
  vars:
    ue_item: "{{ current_ue }}"
  when: check_ip_ready.stdout == "" or check_ip_ready.rc != 0
  ignore_errors: "{{ ignore_task_errors | default(false) }}"

- name: Retrieve wwan0 IP for {{ current_ue }}
  shell: |
    ssh -o ConnectTimeout=5 -o BatchMode=yes root@{{ current_ue }} \
    "ip -4 addr show wwan0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}'"
  register: ue_ip_cmd
  until: ue_ip_cmd.stdout != ""
  retries: 5
  delay: 2
  changed_when: false
  ignore_errors: "{{ ignore_task_errors | default(false) }}"

- name: Check route to {{ core_ip }} on {{ current_ue }}
  shell: ssh -o BatchMode=yes root@{{ current_ue }} "ip route get {{ core_ip }}"
  register: route_check
  changed_when: false
  ignore_errors: true

- name: Add route to {{ core_ip }} via wwan0
  shell: ssh -o BatchMode=yes root@{{ current_ue }} "ip route add {{ core_ip }} dev wwan0"
  when: route_check.stdout is defined and "dev wwan0" not in route_check.stdout
  ignore_errors: true

- name: Build dict ue_ips
  set_fact:
    ue_ips: "{{ ue_ips | default({}) | combine({ current_ue: ue_ip_cmd.stdout }) }}"
  when: ue_ip_cmd.stdout != ""

- name: Execute iperf tests for {{ current_ue }}
  include_tasks: iperf_execution.yml