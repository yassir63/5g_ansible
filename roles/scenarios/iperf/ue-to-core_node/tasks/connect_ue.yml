---
- name: Include 5G profile variables
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/../group_vars/all/5g_profile_{{ fiveg_profile | default('default') }}.yaml"
    name: fiveg

- name: "Get UPF IP for a specific UE"
  set_fact:
    upf_ip: >-
      {{
        (fiveg.slices
         | selectattr('name', 'equalto', fiveg.ues[current_ue].slice)
         | first).ip_prefix
      }}.1

- name: "Debug: Show UPF IP for current UE"
  debug:
    msg: "UE {{ current_ue }} â†’ UPF IP = {{ upf_ip }}"

- name: Check if {{ current_ue }} already has a wwan0 IP
  shell: |
    ssh -o ConnectTimeout=5 -o BatchMode=yes -o StrictHostKeyChecking=no root@{{ current_ue }} \
    "ip -4 addr show wwan0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}'"
  register: check_ip_ready
  changed_when: false
  ignore_errors: true

- name: Connect UE {{ current_ue }} to 5G network (if not connected)
  include_role:
    name: r2lab/ue/connect
  vars:
    ue_item: "{{ current_ue }}"
  when: check_ip_ready.stdout == "" or check_ip_ready.rc != 0
  ignore_errors: "{{ ignore_task_errors | default(false) }}"

- name: Retrieve wwan0 IP for {{ current_ue }}
  shell: |
    ssh -o ConnectTimeout=5 -o BatchMode=yes root@{{ current_ue }} \
    "ip -4 addr show wwan0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}'"
  register: ue_ip_cmd
  until: ue_ip_cmd.stdout != ""
  retries: 5
  delay: 2
  changed_when: false
  ignore_errors: "{{ ignore_task_errors | default(false) }}"

- name: Wait until wwan0 interface is fully up
  shell: ssh root@{{ current_ue }} "ip link show wwan0"
  register: wwan0_status
  retries: 10
  delay: 2
  until: "'UP' in wwan0_status.stdout"
  changed_when: false


- name: Add route to {{ target_server }} via UPF IP when wwan0 is ready
  shell: |
    ssh -o BatchMode=yes root@{{ current_ue }} "
    	ip route add {{ upf_ip }} dev wwan0 2>/dev/null || true
        ip route add {{ target_server }} via {{ upf_ip }} 2>/dev/null || true
        ip route get {{ target_server }}
    "
  changed_when: false
  ignore_errors: true

- name: Build dict ue_ips
  set_fact:
    ue_ips: "{{ ue_ips | default({}) | combine({ current_ue: ue_ip_cmd.stdout }) }}"
  when: ue_ip_cmd.stdout != ""
