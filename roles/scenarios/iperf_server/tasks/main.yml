---
#
# Deploy iperf servers on core_node
#
---
- name: Set defaults
  set_fact:
    base_port: 5201
    # On force la conversion ici au cas oÃ¹
    actual_nb_ues: "{{ nb_ues | default(3) | int }}"

- name: Kill ANY existing iperf3 process
  shell: pkill iperf3 || true
  become: true
  changed_when: false


- name: Create base directory for iperf logs
  file:
    path: /root/IPERF
    state: directory
    mode: "0755"

- name: Start iperf3 servers on incremental ports
  shell: >
    iperf3 -s -p {{ base_port + item }} -D 
    --logfile /root/IPERF/iperf_{{ base_port + item }}_{{ iperf_timestamp.stdout }}.log
  loop: "{{ range(0, actual_nb_ues | int) | list }}"
  become: true

- name: Create base directory for iperf logs
  file:
    path: /root/IPERF
    state: directory
    mode: "0755"

- name: Get timestamp
  command: date +"%Y%m%d_%H%M%S"
  register: iperf_timestamp
  changed_when: false

- name: Start iperf3 servers on incremental ports
  shell: >
    iperf3 -s -p {{ base_port + item }} -D 
    --logfile /root/IPERF/iperf_{{ base_port + item }}_{{ iperf_timestamp.stdout }}.log
  # item est l'index fourni par range (0, 1, 2...)
  loop: "{{ range(0, nb_ues) | list }}"
  become: true

- name: Verify servers are listening
  shell: netstat -tulpn | grep iperf3
  register: iperf_status
  changed_when: false

- name: Debug server status
  debug:
    var: iperf_status.stdout_lines
