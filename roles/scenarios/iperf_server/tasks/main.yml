---
#
# Deploy one iperf per UE in the core_node server
#
- name: Set defaults
  set_fact:
    nb_ues: "{{ (nb_ues | default(3)) | int }}"  # Force nb_ues en entier
    base_port: 5201

- name: Ensure iperf3 is installed
  package:
    name: iperf3
    state: present

- name: Create base directory for iperf logs
  file:
    path: /root/IPERF
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Get timestamp for log files
  command: date +"%Y%m%d_%H%M%S"
  register: iperf_timestamp
  changed_when: false

- name: Start iperf3 servers for each UE
  shell: >
    nohup iperf3 -s -p {{ base_port + item }} -D
    --logfile /root/IPERF/iperf_{{ base_port + item }}_{{ iperf_timestamp.stdout }}.log
  args:
    executable: /bin/bash
  loop: "{{ range(0, nb_ues | int) | list }}"
