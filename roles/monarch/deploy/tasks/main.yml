---
- name: START_MONARCH_DEPLOY
  ansible.builtin.meta: noop
  
- import_tasks: persist_data.yml

- name: Clone 5G-Monarch repo
  git:
    repo: "{{ repo_url }}"
    dest: "{{ repo_dest }}"
    version: "{{ branch }}"
    update: yes
    force: yes 

- name: Label {{ groups['monitor_node'][0] }} for Monarch scheduling
  command: kubectl label node {{ groups['monitor_node'][0] }} monarch-node=true --overwrite
  changed_when: false

- name: Ensure Kyverno namespace exists
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: kyverno
    state: present

- name: Check if Kyverno release exists
  ansible.builtin.command: helm status kyverno -n kyverno
  register: kyverno_status
  failed_when: false
  changed_when: false

- name: Add Kyverno Helm repo
  ansible.builtin.command: helm repo add kyverno https://kyverno.github.io/kyverno/
  when: kyverno_status.rc != 0

- name: Update Helm repos
  ansible.builtin.command: helm repo update
  when: kyverno_status.rc != 0

- name: Install Kyverno using Helm
  ansible.builtin.command: >
    helm upgrade --install kyverno kyverno/kyverno -n kyverno --create-namespace
  when: kyverno_status.rc != 0

- name: Wait for Kyverno Admission Controller to be ready
  kubernetes.core.k8s_info:
    kind: Deployment
    name: kyverno-admission-controller
    namespace: kyverno
  register: kyverno_adm_deploy
  until: 
    - kyverno_adm_deploy.resources is defined
    - kyverno_adm_deploy.resources | length > 0
    - kyverno_adm_deploy.resources[0].status.readyReplicas | default(0) > 0
  retries: 30
  delay: 10

- name: Copy Kyverno policy
  copy:
    dest: /tmp/monarch-force-node.yaml
    content: |
      apiVersion: kyverno.io/v1
      kind: ClusterPolicy
      metadata:
        name: monarch-force-node
      spec:
        rules:
          - name: add-monarch-node-selector
            match:
              resources:
                kinds: ["Pod"]
                namespaces: ["monarch"]
            mutate:
              patchStrategicMerge:
                spec:
                  nodeSelector:
                    monarch-node: "true"

- name: Apply Kyverno policy
  command: kubectl apply -f /tmp/monarch-force-node.yaml

- name: Ensure {{ monarch_ns }} namespace exists
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ monarch_ns }}"

- name: Patch namespace with default nodeSelector to force scheduling on labeled node
  kubernetes.core.k8s:
    state: patched
    kind: Namespace
    name: "{{ monarch_ns }}"
    merge_type: merge
    definition:
      metadata:
        annotations:
          scheduler.kubernetes.io/node-selector: "monarch-node=true"

- name: Get IP of node {{ groups['monitor_node'][0] }}
  command: kubectl get node {{ groups['monitor_node'][0] }} -o jsonpath='{.status.addresses[?(@.type=="InternalIP")].address}'
  register: monarch_node_ip_result

- name: Set monarch_node_ip fact
  set_fact:
    monarch_node_ip: "{{ monarch_node_ip_result.stdout }}"

- name: Patch NODE_IP in .env
  lineinfile:
    path: "{{ repo_dest }}/.env"
    regexp: '^NODE_IP=.*'
    line: 'NODE_IP="{{ monarch_node_ip }}"'
    create: yes

- name: Install Python requirements
  ansible.builtin.pip:
    requirements: "{{ repo_dest }}/requirements.txt"
    executable: pip3

- name: Deploy Monarch External Components (SO, NFVO)
  ansible.builtin.debug:
    msg: "Starting deployment of Monarch external components..."

- import_tasks: deploy_external.yml

- name: Append nodeSelector for MongoDB (exact indent, end of file)
  blockinfile:
    path: "{{ repo_dest }}/data_store/mongodb/mongodb-deployment.yaml"
    marker: "# {mark} ANSIBLE MANAGED BLOCK: NodeSelector for MongoDB"
    insertafter: EOF
    block: |
      # fixing indentation
            nodeSelector:
              kubernetes.io/hostname: {{ groups['monitor_node'][0] }}

- name: Deploy Monarch Core Components (Data, Monitoring)"
  ansible.builtin.debug:
    msg: "Starting deployment of Monarch core components..."

- import_tasks: deploy_core.yml

- name: Deploy Monarch NSS Components (NSSDC, Prometheus)
  ansible.builtin.debug:
    msg: "Starting deployment of Monarch NSS components..."

- import_tasks: deploy_nss.yml

- name: Deploy Kepler for monitoring (if enabled)
  ansible.builtin.debug:
    msg: "Starting deployment of Kepler for monitoring..."

- import_tasks: deploy_kepler.yml
  when: enable_kepler