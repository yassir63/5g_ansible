---
- name: RESTART_OAI_SETUP
  ansible.builtin.meta: noop

- name: Check if yq is already installed
  ansible.builtin.stat:
    path: "{{ yq_bin_path }}"
  register: yq_bin

- name: Download yq binary using curl or wget
  ansible.builtin.shell: |
    set -e
    if command -v curl >/dev/null 2>&1; then
      curl -L --fail "{{ yq_url }}" -o "{{ yq_bin_path }}"
    elif command -v wget >/dev/null 2>&1; then
      wget -O "{{ yq_bin_path }}" "{{ yq_url }}"
    else
      echo "Neither curl nor wget found" >&2
      exit 1
    fi
  args:
    creates: "{{ yq_bin_path }}"
  when: not yq_bin.stat.exists
  become: true

- name: Ensure yq is executable
  ansible.builtin.file:
    path: "{{ yq_bin_path }}"
    mode: '0755'
    state: file
  become: true

- name: Remove existing OAI directory if it exists
  ansible.builtin.file:
    path: "{{ dir_oai }}"
    state: absent

- name: Ensure OAI directory exists in $HOME
  ansible.builtin.file:
    path: "{{ dir_oai }}"
    state: directory
    mode: '0755'

- name: Download prepare-demo-oai.sh using curl or wget
  ansible.builtin.shell: |
    set -e
    if command -v curl >/dev/null 2>&1; then
      curl -L --fail \
        "https://raw.githubusercontent.com/sopnode/oai5g-rru/{{ tag_oai5g_rru }}/testing/prepare-demo-oai.sh" \
        -o "{{ prepare_demo_script }}"
    elif command -v wget >/dev/null 2>&1; then
      wget -O "{{ prepare_demo_script }}" \
        "https://raw.githubusercontent.com/sopnode/oai5g-rru/{{ tag_oai5g_rru }}/testing/prepare-demo-oai.sh"
    else
      echo "Neither curl nor wget found" >&2
      exit 1
    fi
    chmod 0755 "{{ prepare_demo_script }}"
  args:
    creates: "{{ prepare_demo_script }}"
  become: true

- name: Retrieve physical interfaces for multus on the core and ran nodes
  ansible.builtin.set_fact:
    multus_core_if: "{{ hostvars[groups['core_node'][0]].nic_interface }}"
    multus_ran_if: "{{ hostvars[groups['ran_node'][0]].nic_interface }}"
  when: not bridge_enabled

- name: Retrieve bridge interfaces for multus on the core and ran nodes
  ansible.builtin.set_fact:
    multus_core_if: "n3br"
    multus_ran_if: "n3br"
  when: bridge_enabled

- name: Update NS variable in prepare-demo-oai.sh
  ansible.builtin.lineinfile:
    path: "{{ prepare_demo_script }}"
    regexp: '^NS='
    line: "NS=\"{{ core }}\""
    backrefs: true

- name: Determine HOST_AMF_UPF value
  ansible.builtin.set_fact:
    host_amf_upf_value: "{{ '10.10.3.200' if core == 'open5gs' else (ran_node_name if fhi72 | bool else core_node_name) }}"

- name: Update HOST_AMF_UPF variable in prepare-demo-oai.sh
  ansible.builtin.lineinfile:
    path: "{{ prepare_demo_script }}"
    regexp: '^HOST_AMF_UPF='
    line: "HOST_AMF_UPF=\"{{ host_amf_upf_value }}\""
    backrefs: true

- name: Update HOST_GNB variable in prepare-demo-oai.sh
  ansible.builtin.lineinfile:
    path: "{{ prepare_demo_script }}"
    regexp: '^HOST_GNB='
    line: "HOST_GNB=\"{{ ran_node_name }}\""
    backrefs: true

- name: Update TAG_OAI5G_RRU variable in prepare-demo-oai.sh
  ansible.builtin.lineinfile:
    path: "{{ prepare_demo_script }}"
    regexp: '^TAG_OAI5G_RRU='
    line: "TAG_OAI5G_RRU=\"{{ tag_oai5g_rru }}\""
    backrefs: true

- name: Update REPO_OAI5G_RRU variable in prepare-demo-oai.sh
  ansible.builtin.lineinfile:
    path: "{{ prepare_demo_script }}"
    regexp: '^REPO_OAI5G_RRU='
    line: "REPO_OAI5G_RRU=\"{{ repo_oai5g_rru }}\""
    backrefs: true

- name: Update TAG_OAI_CN5G_FED variable in prepare-demo-oai.sh
  ansible.builtin.lineinfile:
    path: "{{ prepare_demo_script }}"
    regexp: '^TAG_OAI_CN5G_FED='
    line: "TAG_OAI_CN5G_FED=\"{{ tag_oai_cn5g_fed }}\""
    backrefs: true

- name: Update REPO_OAI_CN5G_FED variable in prepare-demo-oai.sh
  ansible.builtin.lineinfile:
    path: "{{ prepare_demo_script }}"
    regexp: '^REPO_OAI_CN5G_FED='
    line: "REPO_OAI_CN5G_FED=\"{{ repo_oai_cn5g_fed }}\""
    backrefs: true

- name: Update LOCAL_CORE_INTERFACE variable in prepare-demo-oai.sh
  ansible.builtin.lineinfile:
    path: "{{ prepare_demo_script }}"
    regexp: '^LOCAL_CORE_INTERFACE='
    line: "LOCAL_CORE_INTERFACE=\"{{ multus_ran_if if fhi72 | bool else multus_core_if }}\""
    backrefs: true

- name: Update LOCAL_RAN_INTERFACE variable in prepare-demo-oai.sh
  ansible.builtin.lineinfile:
    path: "{{ prepare_demo_script }}"
    regexp: '^LOCAL_RAN_INTERFACE='
    line: "LOCAL_RAN_INTERFACE=\"{{ multus_ran_if }}\""
    backrefs: true

- name: Update RRU variable
  ansible.builtin.lineinfile:
    path: "{{ prepare_demo_script }}"
    regexp: '^RRU='
    line: "RRU=\"{{ rru }}\""
    backrefs: true

- name: Update RUN_MODE variable
  ansible.builtin.lineinfile:
    path: "{{ prepare_demo_script }}"
    regexp: '^RUN_MODE='
    line: "RUN_MODE=\"{{ 'full' if core == 'oai' else 'gnb-only' }}\""
    backrefs: true

# use extra-var "e.g. with ansible-playbook -e "oai_cn_mode=advance"
- name: Update CN_MODE variable
  ansible.builtin.lineinfile:
    path: "{{ prepare_demo_script }}"
    regexp: '^CN_MODE='
    line: 'CN_MODE="{{ oai_cn_mode }}"'
    backrefs: true
  when: oai_cn_mode is defined

# use extra-var "e.g. with ansible-playbook -e "oai_gnb_mode=cudu"
- name: Update GNB_MODE variable
  ansible.builtin.lineinfile:
    path: "{{ prepare_demo_script }}"
    regexp: '^GNB_MODE='
    line: 'GNB_MODE="{{ oai_gnb_mode }}"'
    backrefs: true
  when: oai_gnb_mode is defined
 
- name: Run prepare-demo-oai.sh to pull and configure OAI charts
  ansible.builtin.shell: "./prepare-demo-oai.sh -a 2>&1 | tee /tmp/output-prepare-demo-oai.txt"
  args:
    chdir: "{{ dir_oai }}"
  register: prepare_script
  changed_when: "'OAI5G charts are now configured' in prepare_script.stdout"

- name: Ensure Helm is installed, required for demo-oai.sh script
  ansible.builtin.shell: |
    if ! command -v helm >/dev/null 2>&1; then
      curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    fi
  args:
    executable: /bin/bash
  become: true
