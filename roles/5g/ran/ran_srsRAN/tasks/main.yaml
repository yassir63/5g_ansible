---
- name: Clone repo srsRAN
  ansible.builtin.git:
    repo: "{{ repo_url }}"
    dest: "{{ repo_dest }}"
    version: "{{ version | default('main') }}"
    update: no
    force: yes
  
# ------------------------------
# Namespace
# ------------------------------
- name: Ensure namespace exists
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: "{{ open5gs_ns }}"
    state: present

# (If your play doesn't already gather facts)
- name: Gather env facts (remote)
  ansible.builtin.setup:
    filter: ansible_env
  when: ansible_env is not defined

# Ensure we have remote env facts
- name: Gather env facts (remote)
  ansible.builtin.setup:
    filter: ansible_env
  when: ansible_env is not defined

# Normalize repo_dest to an absolute remote path (expand ~, trim)
- name: Normalize repo_dest to remote HOME
  ansible.builtin.set_fact:
    repo_dest_abs: "{{ (repo_dest | default('~/srsran-helm') | trim)
                       | regex_replace('^~/?', ansible_env.HOME ~ '/') }}"

# Choose filename from rru (lower/trim), fall back to values.yaml
- name: Select values filename from rru
  ansible.builtin.set_fact:
    values_filename: "{{ rru_file_map[(rru | default('rfsim') | string | trim | lower)] | default('values.yaml') }}"
  vars:
    rru_file_map:
      benetel: values-benetel.yaml
      liteon:  values-liteon.yaml
      n300:    values-n300.yaml
      n320:    values-n320.yaml
      rfsim:   values-rfsim.yaml

# Build full path with path_join (prevents spaces/slash issues)
- name: Build absolute values_file path
  ansible.builtin.set_fact:
    values_file: "{{ [repo_dest_abs, 'charts', 'srsran-gnb', values_filename] | path_join }}"

# Sanity check
- name: debug
  ansible.builtin.debug:
    msg:
      - "repo_dest_abs='{{ repo_dest_abs }}'"
      - "values_file='{{ values_file }}'"

# Ensure file exists
- name: Ensure values file exists (remote)
  ansible.builtin.stat:
    path: "{{ values_file }}"
  register: values_stat

- name: Fail if values file missing
  ansible.builtin.fail:
    msg: "Values file not found: {{ values_file }}"
  when: not values_stat.stat.exists

# Deploy with kubernetes.core.helm (use chart_ref + values_files)
- name: Deploy srsRAN gNB using Helm
  kubernetes.core.helm:
    name: srsran-gnb
    chart_ref: "{{ [repo_dest_abs, 'charts', 'srsran-gnb'] | path_join }}"
    release_namespace: "{{ open5gs_ns }}"
    values_files:
      - "{{ values_file }}"
    state: present
    wait: true
    atomic: true
# --- gNB pod discovery & wait ---
- name: Snapshot gNB pods by selectors
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ open5gs_ns }}"
    label_selectors: "{{ srs_gnb_label_selectors }}"
  register: srs_gnb_pods

- name: Debug gNB names/phases (selectors)
  ansible.builtin.debug:
    msg:
      - "selectors={{ srs_gnb_label_selectors | join(',') }}"
      - "names={{ srs_gnb_pods.resources | map(attribute='metadata.name') | list }}"
      - "phases={{ srs_gnb_pods.resources | map(attribute='status.phase') | list }}"

- name: Wait for gNB pods Ready via selectors
  ansible.builtin.command: >
    {{ kubectl_bin | default('kubectl') }}
    wait --for=condition=Ready
    pod -l {{ srs_gnb_label_selectors | join(',') }}
    -n {{ open5gs_ns }} --timeout=600s
  register: gnb_wait
  changed_when: false
  failed_when: gnb_wait.rc != 0

- name: Refresh gNB pods after wait
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ open5gs_ns }}"
    label_selectors: "{{ srs_gnb_label_selectors }}"
  register: srs_gnb_pods

# Pick the first gNB pod name (useful for exec steps)
- name: Select a gNB pod name (from selectors)
  ansible.builtin.set_fact:
    gnb_pod_name: "{{ (srs_gnb_pods.resources | first).metadata.name }}"

# gNB starts automatically via its entrypoint

# ------------------------------
# Helm-based Telegraf deployment
# ------------------------------
- name: Deploy Telegraf using Helm
  kubernetes.core.helm:
    name: telegraf
    chart_ref: "{{ [repo_dest_abs, 'charts', 'telegraf'] | path_join }}"
    release_namespace: "{{ open5gs_ns }}"
    values_files:
      - "{{ [repo_dest_abs, 'charts', 'telegraf', 'values.yaml'] | path_join }}"
    state: present
    wait: true
    atomic: true
    timeout: 600
  register: telegraf_apply

# ------------------------------
# Deploy srsRAN UEs (tmux-managed in a single pod)
# ------------------------------

# ------------------------------
# Helm-based UE deployment
# ------------------------------
# UE chart deploy (only for rfsim)
- name: Deploy srsRAN UE using Helm (rfsim only)
  kubernetes.core.helm:
    name: srsran-ue
    chart_ref: "{{ [repo_dest_abs, 'charts', 'srsue'] | path_join }}"
    release_namespace: "{{ open5gs_ns }}"
    values_files:
      - "{{ [repo_dest_abs, 'charts', 'srsue', 'values.yaml'] | path_join }}"
    # You can also pass inline overrides as a dict if needed:
    # values:
    #   ueCount: {{ ue_count | default(3) }}
    state: present
    wait: true
    atomic: true
    timeout: 600
  register: srs_ue_apply
  when: (rru | lower) == 'rfsim'

# --- UE pod discovery & wait ---
- name: List all pods in {{ open5gs_ns }}
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ open5gs_ns }}"
  register: all_pods
  when: rru == 'rfsim'

- name: Filter UE pods by provided selectors (if any)
  when: srs_ue_label_selectors is defined and (srs_ue_label_selectors | length) > 0
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ open5gs_ns }}"
    label_selectors: "{{ srs_ue_label_selectors }}"
  register: ue_by_labels
  when: rru == 'rfsim'

- name: Build UE pod candidates
  ansible.builtin.set_fact:
    ue_candidates: >-
      {{
        (ue_by_labels.resources if (ue_by_labels is defined and (ue_by_labels.resources | length) > 0)
         else
         (all_pods.resources
           | selectattr('metadata.name','search','^(srsran-ue|srsue|ue)[0-9-]'))
         ) | list
      }}
  when: rru == 'rfsim'

- name: Debug available pod names (when no UE candidates)
  ansible.builtin.debug:
    msg: "{{ all_pods.resources | map(attribute='metadata.name') | list }}"
  when: ue_candidates | length == 0 and rru == 'rfsim'

- name: Fail if no UE pods were found
  ansible.builtin.fail:
    msg: "No UE pods found via selectors {{ srs_ue_label_selectors | default([]) }} or name patterns ^(srsran-ue|srsue|ue)"
  when: ue_candidates | length == 0 and rru == 'rfsim'

- name: Choose the first UE pod
  ansible.builtin.set_fact:
    ue_pod_name: "{{ (ue_candidates | first).metadata.name }}"
  when: rru == 'rfsim'

- name: Wait for chosen UE pod to be Ready
  ansible.builtin.command: >
    {{ kubectl_bin }} wait --for=condition=Ready pod/{{ ue_pod_name }}
    -n {{ open5gs_ns }} --timeout=600s
  register: ue_wait
  changed_when: false
  failed_when: ue_wait.rc != 0
  when: rru == 'rfsim'

# -----------------------------------------
# UE in one pod + tmux-managed processes
# -----------------------------------------

# ------------------------------
# Ensure tmux inside the UE pod
# ------------------------------

# Tmux already installed in the srsue image

# Build ue indices 1..N
- name: Build ue indices
  ansible.builtin.set_fact:
    ue_indices: "{{ range(1, ue_count + 1) | list }}"
  when: rru == 'rfsim'
  

# (optional) sanity: tmux present in the pod
- name: Check tmux exists in UE pod
  ansible.builtin.command: >
    {{ kubectl_bin }} -n {{ open5gs_ns }} exec {{ ue_pod_name }} --
    tmux -V
  register: tmux_ver
  changed_when: false
  failed_when: false
  when: rru == 'rfsim'

# Ensure tmux session 'ran' exists
- name: Create tmux session 'ran' if missing
  ansible.builtin.command: >
    {{ kubectl_bin }} -n {{ open5gs_ns }} exec {{ ue_pod_name }} --
    /bin/sh -lc "tmux has-session -t ran || tmux new-session -d -s ran"
  changed_when: true
  failed_when: false
  when: rru == 'rfsim'

# Start/refresh UE windows and run start_ue.sh in each
- name: Start each UE in its own tmux window
  ansible.builtin.command: >
    {{ kubectl_bin }} -n {{ open5gs_ns }} exec {{ ue_pod_name }} --
    /bin/sh -lc "
      tmux list-windows -t ran | grep -q 'ue{{ idx }}' && tmux kill-window -t ran:ue{{ idx }} || true;
      tmux new-window -t ran -n ue{{ idx }} 'bash -lc \"/srsran/config/start_ue.sh {{ idx }}\"'
    "
  loop: "{{ ue_indices }}"
  loop_control:
    loop_var: idx
  register: tmux_ue_windows
  changed_when: true
  failed_when: false
  when: rru == 'rfsim'

# Wait for each UE to be up (either PID file or srsue process per config)
- name: Wait until each UE is up (pid OR srsue process)
  ansible.builtin.command: >
    {{ kubectl_bin }} -n {{ open5gs_ns }} exec {{ ue_pod_name }} -- /bin/sh -lc
    'ok=1; for i in $(seq 1 {{ ue_count }}); do
       if ! { test -f /tmp/ue${i}.pid || pgrep -af "srsue .*ue_${i}\\.conf" >/dev/null; }; then
         ok=0; break;
       fi
     done; test "$ok" = "1"'
  register: ue_up_check
  changed_when: false
  failed_when: false
  retries: 60
  delay: 2
  until: ue_up_check.rc == 0
  when: rru == 'rfsim'

# Small stagger before GNU
- name: Pause briefly before starting GNU Radio
  ansible.builtin.pause:
    seconds: 2
  when: rru == 'rfsim'

# Start/refresh GNU window and run start_gnu.sh once
- name: Start GNU in tmux window 'gnu'
  ansible.builtin.command: >
    {{ kubectl_bin }} -n {{ open5gs_ns }} exec {{ ue_pod_name }} --
    /bin/sh -lc "
      tmux list-windows -t ran | grep -q '^\\s*[0-9]\\+: gnu\\b' && tmux kill-window -t ran:gnu || true;
      tmux new-window -t ran -n gnu 'bash -lc \"/srsran/config/start_gnu.sh {{ ue_count }}\"'
    "
  register: tmux_gnu_win
  changed_when: true
  failed_when: false
  when: rru == 'rfsim'

# Wait until GNU prints its interactive prompt
- name: Wait for GNU to print its prompt
  ansible.builtin.command: >
    {{ kubectl_bin }} -n {{ open5gs_ns }} exec {{ ue_pod_name }} -- /bin/sh -lc
    "grep -q 'Press Enter to quit' /var/log/gnu_multi_ue.log"
  register: gnu_log_wait
  changed_when: false
  failed_when: false
  retries: 30
  delay: 2
  until: gnu_log_wait.rc == 0
  when: rru == 'rfsim'

# Show GNU status (ps + log tail)
- name: Show GNU status (process + log tail)
  ansible.builtin.command: >
    {{ kubectl_bin }} -n {{ open5gs_ns }} exec {{ ue_pod_name }} -- /bin/sh -lc
    "echo '== ps =='; pgrep -af 'python3 .*srsran/config/multi_ue_scenario.py' || true;
     echo '== gnu log tail =='; tail -n 50 /var/log/gnu_multi_ue.log || true"
  register: gnu_status
  changed_when: false
  failed_when: false
  when: rru == 'rfsim'

- name: GNU status
  ansible.builtin.debug:
    msg: "{{ gnu_status.stdout }}"
  when: rru == 'rfsim'

# Small pause, then routing (script may warn for absent namespaces; don't fail)
- name: Pause briefly before adding default route
  ansible.builtin.pause:
    seconds: 2
  when: rru == 'rfsim'

- name: Add default route once (inside the UE pod)
  ansible.builtin.command: >
    {{ kubectl_bin }} -n {{ open5gs_ns }} exec {{ ue_pod_name }} -- /bin/bash -lc
    'UE_COUNT={{ ue_count }} /srsran/config/add_route.sh'
  register: route_once
  changed_when: false
  failed_when: false
  when: rru == 'rfsim'

# Extract UE IP addresses from logs
- name: Extract UE IP addresses from logs
  ansible.builtin.command: >
    {{ kubectl_bin }} -n {{ open5gs_ns }}
    exec {{ ue_pod_name }} -- /bin/sh -lc
    "grep -m1 'PDU Session Establishment successful' /var/log/ue{{ idx }}.log | awk '{print \$NF}'"
  loop: "{{ ue_indices }}"
  loop_control:
    loop_var: idx
    extended: true
  register: ue_ips
  changed_when: false
  failed_when: false
  when: rru == 'rfsim'

- name: Show UE IP addresses
  ansible.builtin.debug:
    msg: "UE{{ idx }} â†’ {{ ue_ips.results[ansible_loop.index0].stdout | default('N/A') }}"
  loop: "{{ ue_indices }}"
  loop_control:
    loop_var: idx
    extended: true
  when: rru == 'rfsim'

# Summary
- name: Summary (RFSIM)
  ansible.builtin.debug:
    msg:
      - "UEs started in tmux session 'ran': windows ue1..ue{{ ue_count }}, logs /var/log/ueN.log"
      - "GNU multi-UE started in tmux window 'gnu': log /var/log/gnu_multi_ue.log"
      - "Routes attempted via add_route.sh (non-fatal if some UEs absent)"
      - "Inspect tmux: kubectl -n {{ open5gs_ns }} exec -it {{ ue_pod_name }} -- tmux attach -t ran"
  when: rru == 'rfsim'

- name: Summary (Non-RFSIM)
  ansible.builtin.debug:
    msg:
      - "gNB deployed via Helm chart 'srsran-gnb' in namespace {{ open5gs_ns }}"
      - "Telegraf deployed via Helm chart 'telegraf' in namespace {{ open5gs_ns }}"
      - "UE deployment skipped (rru={{ rru }})"
  when: rru != 'rfsim'
