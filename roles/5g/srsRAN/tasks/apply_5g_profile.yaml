---
# Apply 5G profile to srsRAN values.yaml minimal pour gNB

- name: Check if yq is already installed
  ansible.builtin.stat:
    path: "{{ yq_bin_path }}"
  register: yq_bin

- name: Download yq binary using curl or wget
  ansible.builtin.shell: |
    set -e
    if command -v curl >/dev/null 2>&1; then
      curl -L --fail "{{ yq_url }}" -o "{{ yq_bin_path }}"
    elif command -v wget >/dev/null 2>&1; then
      wget -O "{{ yq_bin_path }}" "{{ yq_url }}"
    else
      echo "Neither curl nor wget found" >&2
      exit 1
    fi
  args:
    creates: "{{ yq_bin_path }}"
  when: not yq_bin.stat.exists
  become: true

- name: Ensure yq is executable
  ansible.builtin.file:
    path: "{{ yq_bin_path }}"
    mode: '0755'
    state: file
  become: true
  
- name: Resolve 5G profile file
  set_fact:
    fiveg_profile_file: "{{ playbook_dir }}/../group_vars/all/5g_profile_{{ fiveg_profile | default('default') }}.yaml"

- name: Load 5G profile
  include_vars:
    file: "{{ fiveg_profile_file }}"
    name: fiveg

- name: Show active 5G profile
  debug:
    msg:
      - "Using 5G profile: {{ fiveg_profile | default('default') }}"
      - "PLMN: {{ fiveg.plmn.mcc }}{{ fiveg.plmn.mnc }}"
      - "TAC: {{ fiveg.plmn.tac }}"

- name: Uninstall existing srsran-gnb Helm release if present
  ansible.builtin.shell: >
    helm -n {{ ran_ns }} uninstall srsran-gnb || true
  changed_when: true
  ignore_errors: true

- name: Initialize gnb_slices and amf_slices
  set_fact:
    gnb_slices: []
    amf_slices: []

- name: Apply 5G profile and fix slicing types
  ansible.builtin.shell: |
    # 1. Basics
    {{ yq_bin_path }} eval -i '.gnbConfig.cell_cfg.plmn = "{{ fiveg.plmn.mcc }}{{ fiveg.plmn.mnc }}" | .gnbConfig.cell_cfg.tac = {{ fiveg.plmn.tac | int }}' "{{ values_file }}"
    {{ yq_bin_path }} eval -i '.gnbConfig.cu_cp.amf.supported_tracking_areas[0].tac = {{ fiveg.plmn.tac | int }} | .gnbConfig.cu_cp.amf.supported_tracking_areas[0].plmn_list[0].plmn = "{{ fiveg.plmn.mcc }}{{ fiveg.plmn.mnc }}"' "{{ values_file }}"

    # 2. Slices block generation
    cat <<EOF > /tmp/slices_block.yaml
{% for sl in fiveg.slices %}
- sst: {{ sl.sst | int }}
  sd: {{ sl.sd if (sl.sd is defined and sl.sd != 'EMPTY') else '0xFFFFFF' }}
{% endfor %}
EOF

    # 3. Injection
    {{ yq_bin_path }} eval -i '.gnbConfig.cell_cfg.slicing = load("/tmp/slices_block.yaml")' "{{ values_file }}"
    {{ yq_bin_path }} eval -i '.gnbConfig.cu_cp.amf.supported_tracking_areas[0].plmn_list[0].tai_slice_support_list = load("/tmp/slices_block.yaml")' "{{ values_file }}"

    # 4. Quotes removal
    sed -i 's/sst: "\(.*\)"/sst: \1/g' "{{ values_file }}"
    sed -i 's/sd: "\(.*\)"/sd: \1/g' "{{ values_file }}"
    rm /tmp/slices_block.yaml
  become: true

- name: Check SD values
  ansible.builtin.shell: "grep 'sd:' {{ values_file }}"
  register: check_sd
  changed_when: false

- name: Display SD
  ansible.builtin.debug:
    var: check_sd.stdout_lines

- name: Update AMF supported_tracking_areas from 5G profile
  ansible.builtin.shell: >
    yq eval -i '
      .gnbConfig.cu_cp.amf.supported_tracking_areas = [
        {
          "tac": {{ fiveg.plmn.tac | int }},
          "plmn_list": [
            {
              "plmn": "{{ fiveg.plmn.mcc }}{{ fiveg.plmn.mnc }}",
              "tai_slice_support_list": {{ amf_slices | to_json }}
            }
          ]
        }
      ]
    ' "{{ values_file }}"

- name: Update PLMN, TAC and slicing in values file
  ansible.builtin.shell: >
    yq eval -i '
      .gnbConfig.cell_cfg.plmn = "{{ fiveg.plmn.mcc }}{{ fiveg.plmn.mnc }}" |
      .gnbConfig.cell_cfg.tac = {{ fiveg.plmn.tac }} |
      .gnbConfig.cell_cfg.slicing = {{ gnb_slices | to_json }}
    ' "{{ values_file }}"

- name: Show final updated values (PLMN, TAC, slicing)
  ansible.builtin.shell: >
    yq eval -P '.gnbConfig.cell_cfg.plmn, .gnbConfig.cell_cfg.tac, .gnbConfig.cell_cfg.slicing' "{{ values_file }}"
  register: final_values
  changed_when: false

- name: Display final YAML values
  ansible.builtin.debug:
    var: final_values.stdout
