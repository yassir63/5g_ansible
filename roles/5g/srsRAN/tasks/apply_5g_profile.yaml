---
# Apply 5G profile to srsRAN values.yaml minimal pour gNB

- name: Resolve 5G profile file
  set_fact:
    fiveg_profile_file: "{{ playbook_dir }}/../group_vars/all/5g_profile_{{ fiveg_profile | default('default') }}.yaml"

- name: Load 5G profile
  include_vars:
    file: "{{ fiveg_profile_file }}"
    name: fiveg

- name: Show active 5G profile
  debug:
    msg:
      - "Using 5G profile: {{ fiveg_profile | default('default') }}"
      - "PLMN: {{ fiveg.plmn.mcc }}{{ fiveg.plmn.mnc }}"
      - "TAC: {{ fiveg.plmn.tac }}"

- name: Uninstall existing srsran-gnb Helm release if present
  ansible.builtin.shell: >
    helm -n {{ open5gs_ns }} uninstall srsran-gnb || true
  changed_when: true
  ignore_errors: true

- name: Map slices minimal pour gNB
  set_fact:
    gnb_slices: >-
      {{
        gnb_slices | default([]) +
        [
          dict(sst=item.sst, **({ 'sd': item.sd } if item.sd is defined and item.sd != "EMPTY" else {}))
        ]
      }}
  loop: "{{ fiveg.slices }}"
  loop_control:
    loop_var: item

- name: Update PLMN, TAC and slicing in values file
  ansible.builtin.shell: >
    yq eval -i '
      .gnbConfig.cell_cfg.plmn = "{{ fiveg.plmn.mcc }}{{ fiveg.plmn.mnc }}" |
      .gnbConfig.cell_cfg.tac = {{ fiveg.plmn.tac }} |
      .gnbConfig.cell_cfg.slicing = {{ gnb_slices | to_json }}
    ' "{{ values_file }}"

- name: Show final updated values (PLMN, TAC, slicing)
  ansible.builtin.shell: >
    yq eval -P '.gnbConfig.cell_cfg.plmn, .gnbConfig.cell_cfg.tac, .gnbConfig.cell_cfg.slicing' "{{ values_file }}"
  register: final_values
  changed_when: false

- name: Display final YAML values
  ansible.builtin.debug:
    var: final_values.stdout
