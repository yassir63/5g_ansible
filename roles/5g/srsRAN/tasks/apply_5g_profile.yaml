---
- name: Resolve 5G profile file
  set_fact:
    fiveg_profile_file: >-
      {{ playbook_dir }}/../group_vars/all/5g_profile_{{ fiveg_profile | default('default') }}.yaml

- name: Load 5G profile
  include_vars:
    file: "{{ fiveg_profile_file }}"
    name: fiveg

- name: Show active 5G profile
  debug:
    msg:
      - "Using 5G profile: {{ fiveg_profile | default('default') }}"
      - "PLMN: {{ fiveg.plmn.mcc }}{{ fiveg.plmn.mnc }}"
      - "TAC: {{ fiveg.plmn.tac }}"

- name: Uninstall existing srsran-gnb Helm release if present
  ansible.builtin.shell: >
    helm -n {{ open5gs_ns }} uninstall srsran-gnb || true
  changed_when: true
  ignore_errors: true

- name: Update PLMN in values file
  ansible.builtin.command: >
    yq eval -i '.plmn = "{{ fiveg.plmn.mcc }}{{ fiveg.plmn.mnc }}"' "{{ values_file }}"

- name: Update TAC in values file
  ansible.builtin.command: >
    yq eval -i '.tac = {{ fiveg.plmn.tac }}' "{{ values_file }}"

- name: Map slices for gNB
  set_fact:
    gnb_slices: >-
      {{ fiveg.slices | map('lambda x: {"sst": x.sst, "sd": (x.sd if x.sd != "EMPTY" else None)}') | list }}

- name: Replace slicing configuration (RFSIM)
  ansible.builtin.command: >
    yq eval -i '.slicing = {{ gnb_slices | to_json }}' "{{ values_file }}"
  when: rru == "rfsim"

- name: Replace slicing configuration (ZMQ)
  ansible.builtin.command: >
    yq eval -i '.gnbConfig.cell_cfg.slicing = {{ gnb_slices | to_json }}' "{{ values_file }}"
  when: rru != "rfsim"

- name: Show updated slicing section
  ansible.builtin.command: >
    yq eval '{{ ".slicing" if rru == "rfsim" else ".gnbConfig.cell_cfg.slicing" }}' "{{ values_file }}"
  changed_when: false
