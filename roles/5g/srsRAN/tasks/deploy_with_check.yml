---

- name: Inject nodeSelector into values file
  ansible.builtin.blockinfile:
    path: "{{ values_file }}"
    marker: "# {mark} ANSIBLE MANAGED NODE SELECTOR"
    insertbefore: BOF
    block: |
      nodeSelector:
        kubernetes.io/hostname: "{{ ran_node_name }}"
      gnb:
        nodeSelector:
          kubernetes.io/hostname: "{{ ran_node_name }}"

- name: Deploy srsRAN gNB using Helm
  kubernetes.core.helm:
    name: srsran-gnb
    chart_ref: "{{ [repo_dest_abs, 'charts', 'srsran-gnb'] | path_join }}"
    release_namespace: "{{ ran_ns }}"
    values_files:
      - "{{ values_file }}"
    state: present
    wait: true
    atomic: true
    timeout: 120s

- name: Wait for gNB container to be Ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ ran_ns }}"
    label_selectors: "{{ srs_gnb_label_selectors }}"
  register: pod_check
  until: 
    - pod_check.resources | length > 0
    - (pod_check.resources[0].status.containerStatuses | default([]) | selectattr('name', 'equalto', 'gnb') | first).ready | default(false) == true
  retries: 10
  delay: 5
  ignore_errors: yes

- name: Check if gNB is actually stable
  ansible.builtin.set_fact:
    gnb_startup_success: >-
      {{
        pod_check.resources is defined and
        pod_check.resources | length > 0 and
        (pod_check.resources[0].status.containerStatuses | default([]) | selectattr('name', 'equalto', 'gnb') | first).ready | default(false)
      }}

- name: Handle IP Swap if gNB failed
  block:
    - name: Extract current IP (Strict)
      ansible.builtin.shell: |
        grep -oE '(mgmt_addr|addr)=[0-9.]+' {{ values_file }} | head -1 | cut -d= -f2 | tr -d ' '
      register: current_ip_cmd
      changed_when: false

    - name: Determine new IP based on algorithm
      ansible.builtin.set_fact:
        new_ip: >-
          {% if current_ip_cmd.stdout == '192.168.235.105' %}192.168.235.106
          {% elif current_ip_cmd.stdout == '192.168.235.106' %}192.168.235.105
          {% elif current_ip_cmd.stdout == '192.168.235.103' %}192.168.235.104
          {% elif current_ip_cmd.stdout == '192.168.235.104' %}192.168.235.103
          {% else %}{{ current_ip_cmd.stdout }}{% endif %}

    - name: Update IP in values file (No spaces)
      ansible.builtin.replace:
        path: "{{ values_file }}"
        regexp: '(?<==){{ current_ip_cmd.stdout | regex_escape }}'
        replace: "{{ new_ip }}"
      when: new_ip != current_ip_cmd.stdout

    - name: Clean up any accidental spaces around commas
      ansible.builtin.replace:
        path: "{{ values_file }}"
        regexp: '\s+,'
        replace: ','

    - name: Stop gNB before retry
      kubernetes.core.helm:
        name: srsran-gnb
        release_namespace: "{{ ran_ns }}"
        state: absent
        wait: true
      when: item | int < max_attempts | int

  when: 
    - not gnb_startup_success
    - rru in ['n300', 'n320']

