---
- name: Inject nodeSelector into values file
  ansible.builtin.blockinfile:
    path: "{{ values_file }}"
    marker: "# {mark} ANSIBLE MANAGED NODE SELECTOR"
    insertbefore: BOF
    block: |
      nodeSelector:
        kubernetes.io/hostname: "{{ ran_node_name }}"
      gnb:
        nodeSelector:
          kubernetes.io/hostname: "{{ ran_node_name }}"

- name: Deploy srsRAN gNB using Helm
  kubernetes.core.helm:
    name: srsran-gnb
    chart_ref: "{{ [repo_dest_abs, 'charts', 'srsran-gnb'] | path_join }}"
    release_namespace: "{{ ran_ns }}"
    values_files:
      - "{{ values_file }}"
    state: present
    # On désactive wait/atomic ici pour laisser le Deep Check analyser le crash
    wait: false
    atomic: false

- name: Wait for gNB pod to exist
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ ran_ns }}"
    label_selectors: "{{ srs_gnb_label_selectors }}"
  register: pod_exists
  until: pod_exists.resources | length > 0
  retries: 10
  delay: 2

- name: Deep Check - Observe logs for stability (15s)
  ansible.builtin.shell: |
    timeout 15 kubectl logs -n {{ ran_ns }} -l component=gnb -c gnb -f
  register: gnb_logs
  failed_when: false
  changed_when: false

- name: Verify if gNB is truly stable
  ansible.builtin.set_fact:
    # On est strict : il faut le message de démarrage ET pas de Fatal Error
    gnb_startup_success: >-
      {{
        '==== gNB started ===' in gnb_logs.stdout and
        'FATAL ERROR' not in gnb_logs.stdout and
        'srsRAN FATAL ERROR' not in gnb_logs.stdout
      }}

- name: Debug GNB stability status
  ansible.builtin.debug:
    msg: 
      - "GNB Startup Success: {{ gnb_startup_success }}"
      - "Reason: {{ 'Success' if gnb_startup_success else ('FATAL ERROR detected' if 'FATAL' in gnb_logs.stdout else 'GNB never reached started state') }}"

- name: Handle IP Swap if gNB failed
  block:
    - name: Extract current IP (Strict)
      ansible.builtin.shell: |
        grep -oE '(mgmt_addr|addr)=[0-9.]+' {{ values_file }} | head -1 | cut -d= -f2 | tr -d ' '
      register: current_ip_cmd
      changed_when: false

    - name: Determine new IP
      ansible.builtin.set_fact:
        new_ip: >-
          {% if current_ip_cmd.stdout == '192.168.235.105' %}192.168.235.106
          {% elif current_ip_cmd.stdout == '192.168.235.106' %}192.168.235.105
          {% elif current_ip_cmd.stdout == '192.168.235.103' %}192.168.235.104
          {% elif current_ip_cmd.stdout == '192.168.235.104' %}192.168.235.103
          {% else %}{{ current_ip_cmd.stdout }}{% endif %}

    - name: Update IP in values file
      ansible.builtin.replace:
        path: "{{ values_file }}"
        regexp: '(?<==){{ current_ip_cmd.stdout | regex_escape }}'
        replace: "{{ new_ip }}"
      when: new_ip != current_ip_cmd.stdout

    - name: Clean up spaces
      ansible.builtin.replace:
        path: "{{ values_file }}"
        regexp: '\s+,'
        replace: ','

    - name: Stop gNB before retry
      kubernetes.core.helm:
        name: srsran-gnb
        release_namespace: "{{ ran_ns }}"
        state: absent
        wait: true
      # Toujours supprimer si on va re-boucler (item < max_attempts)
      when: item | int < max_attempts | int

  when: 
    - not gnb_startup_success
    - rru in ['n300', 'n320']
