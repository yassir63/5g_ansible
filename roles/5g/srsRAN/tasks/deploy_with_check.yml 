---
- name: Deploy srsRAN gNB using Helm
  kubernetes.core.helm:
    name: srsran-gnb
    chart_ref: "{{ [repo_dest_abs, 'charts', 'srsran-gnb'] | path_join }}"
    release_namespace: "{{ ran_ns }}"
    values_files:
      - "{{ values_file }}"
    state: present
    wait: true
    atomic: true

- name: Wait up to 60s for gNB container to be Ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ ran_ns }}"
    label_selectors: "{{ srs_gnb_label_selectors }}"
  register: pod_check
  until: 
    - pod_check.resources | length > 0
    - (pod_check.resources[0].status.containerStatuses | default([]) | selectattr('name', 'equalto', 'gnb') | first).ready | default(false) == true
  retries: 12
  delay: 5
  ignore_errors: yes

- name: Check if gNB is actually stable
  ansible.builtin.set_fact:
    gnb_startup_success: "{{ (pod_check.resources | length > 0) and ((pod_check.resources[0].status.containerStatuses | default([]) | selectattr('name', 'equalto', 'gnb') | first).ready | default(false)) }}"

- name: Handle IP Swap if gNB failed
  block:
    - name: Extract current IP from values file
      ansible.builtin.shell: |
        grep "mgmt_addr=" {{ values_file }} | sed -E 's/.*mgmt_addr=([0-9.]+),.*/\1/'
      register: current_ip_cmd
      changed_when: false

    - name: Determine new IP based on algorithm
      ansible.builtin.set_fact:
        new_ip: >-
          {% if current_ip_cmd.stdout == '192.168.235.105' %}192.168.235.106
          {% elif current_ip_cmd.stdout == '192.168.235.106' %}192.168.235.105
          {% elif current_ip_cmd.stdout == '192.168.235.103' %}192.168.235.104
          {% elif current_ip_cmd.stdout == '192.168.235.104' %}192.168.235.103
          {% else %}{{ current_ip_cmd.stdout }}{% endif %}

    - name: Update IP in values file (Swap)
      ansible.builtin.replace:
        path: "{{ values_file }}"
        regexp: "{{ current_ip_cmd.stdout }}"
        replace: "{{ new_ip }}"
      when: new_ip != current_ip_cmd.stdout

    - name: Stop gNB before retry
      kubernetes.core.helm:
        name: srsran-gnb
        release_namespace: "{{ ran_ns }}"
        state: absent
      when: item < max_attempts

  when: not gnb_startup_success and rru in ['n300', 'n320']