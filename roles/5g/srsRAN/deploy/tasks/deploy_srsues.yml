# ------------------------------
# Deploy srsRAN UEs (tmux-managed in a single pod)
# 
# Helm-based UE deployment (RFSIM ONLY)
# ------------------------------

- name: Deploy srsRAN UE using Helm
  kubernetes.core.helm:
    name: srsran-ue
    chart_ref: "{{ [repo_dest_abs, 'charts', 'srsue'] | path_join }}"
    release_namespace: "{{ ran_ns }}"
    values_files:
      - "{{ [repo_dest_abs, 'charts', 'srsue', 'values.yaml'] | path_join }}"
    state: present
    wait: true
    atomic: true
    timeout: 600s
  register: srs_ue_apply

# --- UE pod discovery & wait ---
- name: List all pods in {{ ran_ns }}
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ ran_ns }}"
  register: all_pods

- name: Filter UE pods by provided selectors (if any)
  when: srs_ue_label_selectors is defined and (srs_ue_label_selectors | length) > 0
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ ran_ns }}"
    label_selectors: "{{ srs_ue_label_selectors }}"
  register: ue_by_labels

- name: Build UE pod candidates
  ansible.builtin.set_fact:
    ue_candidates: >-
      {{
        (ue_by_labels.resources if (ue_by_labels is defined and (ue_by_labels.resources | length) > 0)
         else
         (all_pods.resources
           | selectattr('metadata.name','search','^(srsran-ue|srsue|ue)[0-9-]'))
         ) | list
      }}

- name: Debug available pod names (when no UE candidates)
  ansible.builtin.debug:
    msg: "{{ all_pods.resources | map(attribute='metadata.name') | list }}"
  when: ue_candidates | length == 0

- name: Fail if no UE pods were found
  ansible.builtin.fail:
    msg: "No UE pods found via selectors {{ srs_ue_label_selectors | default([]) }} or name patterns ^(srsran-ue|srsue|ue)"
  when: ue_candidates | length == 0

- name: Choose the first UE pod
  ansible.builtin.set_fact:
    ue_pod_name: "{{ (ue_candidates | first).metadata.name }}"

- name: Wait for chosen UE pod to be Ready
  ansible.builtin.command: >
    {{ kubectl_bin }} wait --for=condition=Ready pod/{{ ue_pod_name }}
    -n {{ ran_ns }} --timeout=600s
  register: ue_wait
  changed_when: false
  failed_when: ue_wait.rc != 0

# -----------------------------------------
# UE in one pod + tmux-managed processes
# -----------------------------------------

- name: Build ue indices
  ansible.builtin.set_fact:
    ue_indices: "{{ range(1, ue_count + 1) | list }}"

- name: Check tmux exists in UE pod
  ansible.builtin.command: >
    {{ kubectl_bin }} -n {{ ran_ns }} exec {{ ue_pod_name }} --
    tmux -V
  register: tmux_ver
  changed_when: false
  failed_when: false

- name: Ensure tmux session 'ran' exists
  ansible.builtin.command: >
    {{ kubectl_bin }} -n {{ ran_ns }} exec {{ ue_pod_name }} --
    /bin/sh -lc "tmux has-session -t ran || tmux new-session -d -s ran"
  changed_when: true
  failed_when: false

- name: Start each UE in its own tmux window
  ansible.builtin.command: >
    {{ kubectl_bin }} -n {{ ran_ns }} exec {{ ue_pod_name }} --
    /bin/sh -lc "
      tmux list-windows -t ran | grep -q 'ue{{ idx }}' && tmux kill-window -t ran:ue{{ idx }} || true;
      tmux new-window -t ran -n ue{{ idx }} 'bash -lc \"/srsran/config/start_ue.sh {{ idx }}\"'
    "
  loop: "{{ ue_indices }}"
  loop_control:
    loop_var: idx
  register: tmux_ue_windows
  changed_when: true
  failed_when: false

- name: Wait until each UE is up (pid OR srsue process)
  ansible.builtin.command: >
    {{ kubectl_bin }} -n {{ ran_ns }} exec {{ ue_pod_name }} -- /bin/sh -lc
    'ok=1; for i in $(seq 1 {{ ue_count }}); do
        if ! { test -f /tmp/ue${i}.pid || pgrep -af "srsue .*ue_${i}\\.conf" >/dev/null; }; then
          ok=0; break;
        fi
      done; test "$ok" = "1"'
  register: ue_up_check
  changed_when: false
  failed_when: false
  retries: 60
  delay: 2
  until: ue_up_check.rc == 0

- name: Pause briefly before starting GNU Radio
  ansible.builtin.pause:
    seconds: 2

- name: Start GNU in tmux window 'gnu'
  ansible.builtin.command: >
    {{ kubectl_bin }} -n {{ ran_ns }} exec {{ ue_pod_name }} --
    /bin/sh -lc "
      tmux list-windows -t ran | grep -q '^\\s*[0-9]\\+: gnu\\b' && tmux kill-window -t ran:gnu || true;
      tmux new-window -t ran -n gnu 'bash -lc \"/srsran/config/start_gnu.sh {{ ue_count }}\"'
    "
  register: tmux_gnu_win
  changed_when: true
  failed_when: false

- name: Wait for GNU to print its prompt
  ansible.builtin.command: >
    {{ kubectl_bin }} -n {{ ran_ns }} exec {{ ue_pod_name }} -- /bin/sh -lc
    "grep -q 'Press Enter to quit' /var/log/gnu_multi_ue.log"
  register: gnu_log_wait
  changed_when: false
  failed_when: false
  retries: 30
  delay: 2
  until: gnu_log_wait.rc == 0

- name: Show GNU status (process + log tail)
  ansible.builtin.command: >
    {{ kubectl_bin }} -n {{ ran_ns }} exec {{ ue_pod_name }} -- /bin/sh -lc
    "echo '== ps =='; pgrep -af 'python3 .*srsran/config/multi_ue_scenario.py' || true;
      echo '== gnu log tail =='; tail -n 50 /var/log/gnu_multi_ue.log || true"
  register: gnu_status
  changed_when: false
  failed_when: false

- name: GNU status
  ansible.builtin.debug:
    msg: "{{ gnu_status.stdout }}"

- name: Pause briefly before adding default route
  ansible.builtin.pause:
    seconds: 2

- name: Add default route once (inside the UE pod)
  ansible.builtin.command: >
    {{ kubectl_bin }} -n {{ ran_ns }} exec {{ ue_pod_name }} -- /bin/bash -lc
    'UE_COUNT={{ ue_count }} /srsran/config/add_route.sh'
  register: route_once
  changed_when: false
  failed_when: false

- name: Extract UE IP addresses from logs
  ansible.builtin.command: >
    {{ kubectl_bin }} -n {{ ran_ns }}
    exec {{ ue_pod_name }} -- /bin/sh -lc
    "grep -m1 'PDU Session Establishment successful' /var/log/ue{{ idx }}.log | awk '{print \$NF}'"
  loop: "{{ ue_indices }}"
  loop_control:
    loop_var: idx
    extended: true
  register: ue_ips
  changed_when: false
  failed_when: false

- name: Show UE IP addresses
  ansible.builtin.debug:
    msg: "UE{{ idx }} â†’ {{ ue_ips.results[ansible_loop.index0].stdout | default('N/A') }}"
  loop: "{{ ue_indices }}"
  loop_control:
    loop_var: idx
    extended: true

