---
- name: START_OPEN5GS_DEPLOY
  ansible.builtin.meta: noop

- name: Reload and restart kubelet
  ansible.builtin.shell: |
    systemctl daemon-reload
    systemctl restart kubelet
  become: true
  changed_when: false

- name: Restart CoreDNS pods after kubelet restart
  ansible.builtin.shell: |
    kubectl -n kube-system delete pod -l k8s-app=kube-dns --ignore-not-found
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  changed_when: false

- name: Wait for CoreDNS to be Ready
  ansible.builtin.shell: |
    kubectl wait -n kube-system --for=condition=Ready pod -l k8s-app=kube-dns --timeout=180s
  args:
    executable: /bin/bash
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: wait_coredns
  retries: 3
  delay: 10
  until: wait_coredns.rc == 0
  changed_when: false

- name: Test CoreDNS resolution from core node
  become: true
  delegate_to: "{{ groups['core_node'][0] }}"
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  ansible.builtin.shell: |
    set -eux
    for NODE in {{ groups['core_node'][0] }}; do
      kubectl run dns-test-$NODE --image=busybox:1.36 --restart=Never \
        --overrides='{"spec": {"nodeName": "'"${NODE}"'"}}' --command -- sh -c 'nslookup kubernetes.default.svc.cluster.local' || true
    done
    kubectl delete pod dns-test-{{ groups['core_node'][0] }} --ignore-not-found
  changed_when: false

- name: Ensure Open5GS namespace exists
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: "{{ open5gs_ns }}"
    state: present

- name: Apply MongoDB with Kustomize
  ansible.builtin.command: kubectl apply -k "{{ repo_dest }}/mongodb" -n {{ open5gs_ns }}

- name: Wait for MongoDB pod to be Ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ open5gs_ns }}"
    label_selectors:
      - app.kubernetes.io/name=mongodb
  register: mongo_pods
  until: >
    mongo_pods.resources | length > 0 and
    (mongo_pods.resources[0].status.containerStatuses is defined) and
    (mongo_pods.resources[0].status.containerStatuses[0].ready | default(false))
  retries: 40
  delay: 10

- name: Apply NADs with Kustomize
  ansible.builtin.command: kubectl apply -k "{{ repo_dest }}/networks5g" -n {{ open5gs_ns }}

- name: Wait for kube-apiserver to be responsive
  shell: kubectl get --raw='/healthz'
  register: api_health
  retries: 30
  delay: 10
  until: api_health.rc == 0
  changed_when: false

- name: Wait for CRDs registration to be ready
  shell: kubectl get crds
  register: crd_list
  retries: 20
  delay: 5
  until: "'network-attachment-definitions.k8s.cni.cncf.io' in crd_list.stdout"
  changed_when: false

- name: Install jq
  ansible.builtin.apt:
    name: jq
    state: present
    update_cache: yes
  become: yes

- name: Wait for Multus CRD
  ansible.builtin.shell: kubectl get crd network-attachment-definitions.k8s.cni.cncf.io
  register: multus_crd_check
  retries: 60
  delay: 5
  until: multus_crd_check.rc == 0
  changed_when: false
  failed_when: false

- name: Install OVS CNI via Cluster Network Addons Operator (single-node)
  block:
    - name: Apply Cluster Network Addons Operator namespace
      ansible.builtin.shell: |
        kubectl apply -f https://github.com/kubevirt/cluster-network-addons-operator/releases/download/v0.98.1/namespace.yaml

    - name: Apply Cluster Network Addons CRDs
      ansible.builtin.shell: |
        kubectl apply -f https://github.com/kubevirt/cluster-network-addons-operator/releases/download/v0.98.1/network-addons-config.crd.yaml

    - name: Apply Cluster Network Addons Operator
      ansible.builtin.shell: |
        kubectl apply -f https://github.com/kubevirt/cluster-network-addons-operator/releases/download/v0.98.1/operator.yaml

    - name: Create NetworkAddonsConfig for OVS
      ansible.builtin.copy:
        dest: /tmp/netaddonsconf.yaml
        content: |
          apiVersion: networkaddonsoperator.network.kubevirt.io/v1
          kind: NetworkAddonsConfig
          metadata:
            name: cluster
          spec:
            ovs: {}
    - name: Apply NetworkAddonsConfig
      ansible.builtin.shell: |
        kubectl apply -f /tmp/netaddonsconf.yaml

    - name: Wait for NetworkAddonsConfig to become Available
      ansible.builtin.shell: |
        kubectl wait networkaddonsconfig cluster --for condition=Available --timeout=300s

  when: core_node_name == ran_node_name and core == "open5gs" and not fhi72
  become: yes

- name: Patch NADs to use unique interface names
  shell: |
    set -euo pipefail
    for nad in n2network n3network n4network; do
      case "$nad" in
        n2network) ifname=n2 ;;
        n3network) ifname=n3 ;;
        n4network) ifname=n4 ;;
      esac
      if ! kubectl get networkattachmentdefinition "$nad" -n open5gs &>/dev/null; then
        continue
      fi
      config=$(kubectl get networkattachmentdefinition "$nad" -n open5gs -o jsonpath='{.spec.config}')
      newconfig=$(echo "$config" | jq --arg n "$ifname" '.ifname = $n')
      kubectl patch networkattachmentdefinition "$nad" -n open5gs --type=merge -p "{\"spec\":{\"config\":$newconfig}}"
    done
  register: patch_nad
  failed_when: false
  changed_when: "'Skipping' not in patch_nad.stdout"

- name: Verify required NADs exist
  kubernetes.core.k8s_info:
    kind: NetworkAttachmentDefinition
    namespace: "{{ open5gs_ns }}"
  register: nad_info

- name: Fail if a required NAD is missing
  ansible.builtin.fail:
    msg: "NAD {{ item }} is missing in {{ open5gs_ns }}"
  when: item not in (nad_info.resources | map(attribute='metadata.name') | list)
  loop: "{{ nad_list }}"

- name: Bring OVS bridges up if single-node Open5GS
  ansible.builtin.shell: |
    ip link set dev n2br up
    ip link set dev n3br up
    ip link set dev n4br up
  become: true
  when: core_node_name == ran_node_name and core == "open5gs" and not fhi72

- name: Apply Open5GS NFs with Kustomize
  ansible.builtin.command: kubectl apply -k "{{ repo_dest }}/{{ deployment_option }}" -n {{ open5gs_ns }}

- name: Wait for Open5GS Core NFs pods Ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ open5gs_ns }}"
    label_selectors:
      - "nf={{ item }}"
  register: nf_pod
  until: >
    nf_pod.resources | length > 0 and
    (nf_pod.resources[0].status.containerStatuses is defined) and
    (nf_pod.resources[0].status.containerStatuses[0].ready | default(false))
  retries: 40
  delay: 5
  loop: "{{ nfs }}"
  loop_control:
    label: "{{ item }}"

- name: Install python3-venv
  ansible.builtin.apt:
    name: python3-venv
    state: present
  become: yes

- name: Create Python virtual environment
  ansible.builtin.command:
    cmd: python3 -m venv "{{ repo_dest }}/venv"
    creates: "{{ repo_dest }}/venv/bin/activate"
  become: yes

- name: Upgrade pip in virtualenv
  ansible.builtin.pip:
    name: pip
    state: latest
    executable: "{{ repo_dest }}/venv/bin/pip"
  become: yes

- name: Install Python requirements
  ansible.builtin.pip:
    requirements: "{{ repo_dest }}/requirements.txt"
    executable: "{{ repo_dest }}/venv/bin/pip"
  become: yes

- name: Deploy Open5GS Web UI
  ansible.builtin.command: kubectl apply -k "{{ repo_dest }}/open5gs-webui" -n {{ open5gs_ns }}

- name: Wait for WebUI pod Ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ open5gs_ns }}"
    label_selectors:
      - "nf=webui"
  register: webui_pod
  until: >
    webui_pod.resources | length > 0 and
    (webui_pod.resources[0].status.containerStatuses[0].ready | default(false))
  retries: 40
  delay: 5

- name: Run Python scripts to generate and add subscribers
  ansible.builtin.shell: |
    {{ repo_dest }}/venv/bin/python {{ repo_dest }}/mongo-tools/generate-data-fiveg.py
    {{ repo_dest }}/venv/bin/python {{ repo_dest }}/mongo-tools/add-subscribers.py
  args:
    chdir: "{{ repo_dest }}"

- name: Run add-admin-account.py
  ansible.builtin.command: >
    {{ repo_dest }}/venv/bin/python mongo-tools/add-admin-account.py
  args:
    chdir: "{{ repo_dest }}"

- name: Check Open5GS deployment
  ansible.builtin.include_role:
    name: 5g/open5gs/check_all
