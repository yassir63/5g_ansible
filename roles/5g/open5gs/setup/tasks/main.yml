---
- name: RESTART_OPEN5GS_SETUP
  ansible.builtin.meta: noop

- name: Reload and restart kubelet
  ansible.builtin.shell: |
    systemctl daemon-reload
    systemctl restart kubelet
  become: true
  changed_when: false

- name: Restart CoreDNS pods after kubelet restart
  ansible.builtin.shell: |
    kubectl -n kube-system delete pod -l k8s-app=kube-dns --ignore-not-found
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  changed_when: false

- name: Wait for CoreDNS to be Ready
  ansible.builtin.shell: |
    kubectl wait -n kube-system --for=condition=Ready pod -l k8s-app=kube-dns --timeout=180s
  args:
    executable: /bin/bash
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: wait_coredns
  retries: 3
  delay: 10
  until: wait_coredns.rc == 0
  changed_when: false

# --- Test DNS ---
- name: Test CoreDNS resolution from core node
  become: true
  delegate_to: "{{ groups['core_node'][0] }}"
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  ansible.builtin.shell: |
    set -eux
    for NODE in {{ groups['core_node'][0] }}; do
      echo "=== Testing DNS on $NODE ==="
      kubectl run dns-test-$NODE \
        --image=busybox:1.36 \
        --restart=Never \
        --overrides='{"spec": {"nodeName": "'"${NODE}"'"}}' \
        --command -- sh -c 'nslookup kubernetes.default.svc.cluster.local' || true
    done

    echo "Cleaning up test pods..."
    kubectl delete pod dns-test-{{ groups['core_node'][0] }} --ignore-not-found
  changed_when: false

- name: Label {{ groups['core_node'][0] }} for Open5GS Core scheduling
  command: kubectl label node {{ groups['core_node'][0] }} open5gs-core-node=true --overwrite
  changed_when: false

# === KYVERNO INSTALLATION =====================================================
- name: Add and update Kyverno Helm repo
  ansible.builtin.shell: |
    helm repo add kyverno https://kyverno.github.io/kyverno/ || true
    helm repo update
  args:
    executable: /bin/bash

- name: Ensure Kyverno namespace exists
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: kyverno

# --- Optional cleanup if Kyverno partially installed ---
- name: Uninstall previous Kyverno (safe cleanup)
  ansible.builtin.shell: |
    helm uninstall kyverno -n kyverno || true
    kubectl delete crds -l app.kubernetes.io/name=kyverno --ignore-not-found=true
  args:
    executable: /bin/bash
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  ignore_errors: true

# --- Flannel CNI Check ---
- name: Wait for Flannel pods to be Ready
  ansible.builtin.shell: |
    kubectl wait -n kube-flannel --for=condition=Ready pod -l app=flannel --timeout=180s
  args:
    executable: /bin/bash
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: wait_flannel
  retries: 5
  delay: 10
  until: wait_flannel.rc == 0
  changed_when: false

- name: Wait for Flannel CNI interface (cni0) to exist on core node
  ansible.builtin.shell: |
    set -e
    echo "Checking if cni0 exists on {{ item }}..."
    for i in {1..30}; do
      if ip link show cni0 2>/dev/null; then
        echo "✅ cni0 exists on {{ item }}"
        exit 0
      fi
      echo "⏳ Waiting for cni0 to appear on {{ item }}..."
      sleep 5
    done
    echo "❌ cni0 not found on {{ item }}" >&2
    exit 1
  delegate_to: "{{ item }}"
  loop: "{{ groups['core_node'] }}"
  retries: 3
  delay: 5
  register: wait_cni
  changed_when: false

# --- Wait for kube-proxy pods to be Running and Ready ----
- name: Wait for all kube-proxy pods to be Ready
  shell: |
    set -e
    for i in $(seq 1 30); do
      ready=$(kubectl -n kube-system get pods -l k8s-app=kube-proxy -o jsonpath='{range .items[*]}{.metadata.name}:{range .status.containerStatuses[*]}{.ready};{end}{"\n"}{end}' | grep -c false || true)
      if [ "$ready" -eq 0 ]; then
        echo "✅ All kube-proxy pods are ready"
        exit 0
      fi
      echo "⏳ Waiting for kube-proxy pods ($i/30)..."
      sleep 5
    done
    echo "❌ kube-proxy pods not ready after 30 retries"
    kubectl -n kube-system get pods -o wide
    exit 1
  args:
    executable: /bin/bash
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  changed_when: false

# --- Wait for kubernetes service endpoint to exist ---
- name: Wait for kubernetes service endpoint to exist (10.96.0.1)
  ansible.builtin.shell: |
    set -eu
    tries=0
    until kubectl -n default get endpoints kubernetes -o jsonpath='{.subsets}' | grep -q '.'; do
      tries=$((tries+1))
      if [ $tries -gt 30 ]; then
        echo "no endpoints for kubernetes service after timeout" >&2
        exit 1
      fi
      sleep 2
    done
    kubectl -n default get endpoints kubernetes -o wide
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  args:
    executable: /bin/bash
  changed_when: false
  register: kubernetes_endpoints

- name: Verify core node has a route to service IP 10.96.0.1
  ansible.builtin.shell: |
    if ip route get 10.96.0.1 >/dev/null 2>&1; then
      ip route get 10.96.0.1
      exit 0
    else
      echo "no route to 10.96.0.1 on $(hostname)" >&2
      exit 2
    fi
  delegate_to: "{{ item }}"
  loop: "{{ groups['core_node'] }}"
  register: route_check
  failed_when: false
  changed_when: false

- name: Debug route check failures if any node lacks route to 10.96.0.1
  ansible.builtin.debug:
    msg: "Node {{ item.item }}: rc={{ item.rc }} stdout='{{ item.stdout }}' stderr='{{ item.stderr }}'"
  loop: "{{ route_check.results }}"
  when: item.rc != 0

- name: Check if no route to 10.96.0.1 on core node 
  ansible.builtin.fail:
    msg: "Core node does not have a route to 10.96.0.1; Kyverno install deferred."
  when: route_check.results | selectattr('rc','ne',0) | list | length > 0

- name: Set subscriber variables
  set_fact:
    mongo_namespace: "open5gs"
    mongo_pod: "mongodb-0"
    mongo_local_port: 27017
    yaml_file: "/etc/5g_profile_default.yaml"
    mongo_tools_dir: "/root/open5gs-k8s/mongo-tools"
    python_venv: "/root/open5gs-k8s/venv/bin/python"
    python_script: "add-subscribers.py"

- name: Ensure lsof is installed
  ansible.builtin.apt:
    name: lsof
    state: present
    update_cache: yes
  become: yes

- name: Check if port 27017 is already used by kubectl
  ansible.builtin.shell: |
    lsof -i :{{ mongo_local_port }} | grep kubectl || true
  register: port_forward_check
  changed_when: false

- name: Start MongoDB port-forward if not already running
  ansible.builtin.shell: |
    nohup kubectl port-forward -n {{ mongo_namespace }} {{ mongo_pod }} {{ mongo_local_port }}:27017 > /tmp/port-forward.log 2>&1 &
    echo $! > /tmp/port-forward.pid
  when: port_forward_check.stdout == ""
  async: 0
  poll: 0

- name: Wait until MongoDB accepts connections
  ansible.builtin.wait_for:
    host: 127.0.0.1
    port: "{{ mongo_local_port }}"
    delay: 2
    timeout: 120

# --- Add subscribers ---
- name: Add subscribers
  ansible.builtin.shell: |
    {{ repo_dest }}/venv/bin/python mongo-tools/generate-data.py && \
    {{ repo_dest }}/venv/bin/python mongo-tools/add-subscribers.py
  args:
    chdir: "{{ repo_dest }}"
  register: sub_out
  changed_when: false

- name: Check added subscribers
  ansible.builtin.shell: |
    {{ repo_dest }}/venv/bin/python mongo-tools/check-subscribers.py
  args:
    chdir: "{{ repo_dest }}"
  register: check_out
  changed_when: false

- name: Show Added subscribers
  debug:
    var: check_out.stdout
