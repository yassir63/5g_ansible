---
- name: Include 5G profile variables
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/../group_vars/all/5g_profile_{{ fiveg_profile | default('default') }}.yaml"
    name: fiveg

- name: Validate IMSI length
  ansible.builtin.assert:
    that:
      - "(fiveg.plmn.mcc | length) == 3"
      - "(fiveg.plmn.mnc | length) in [2,3]"
      - "(fiveg.plmn.mcc | length) + (fiveg.plmn.mnc | length) + (item.value.imsi_suffix | length) == 15"
    fail_msg: "Invalid IMSI for UE {{ item.key }}"
  loop: "{{ fiveg.ues | dict2items }}"

- name: Build enriched UE list
  set_fact:
    open5gs_ues: >-
      {{
        open5gs_ues | default([]) + [{
          'name': item.key,
          'imsi': fiveg.plmn.mcc ~ fiveg.plmn.mnc ~ item.value.imsi_suffix,
          'key': fiveg.security.full_key,
          'opc': fiveg.security.opc,
          'slices': (
            item.value.slices
            if item.value.slices is defined
            else [ item.value.slice ]
          )
        }]
      }}
  loop: "{{ fiveg.ues | dict2items }}"

- name: Get MongoDB pod name
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ open5gs_ns }}"
    label_selectors:
      - "app.kubernetes.io/name=mongodb"
  register: mongo_pods

- name: Wait for MongoDB to be ready
  shell: |
    kubectl exec -n {{ open5gs_ns }} {{ open5gs_dbctl_pod }} -- \
      bash -c "until mongo --disableImplicitSessions --eval 'db.hello().isWritablePrimary || db.hello().secondary' | grep -q 'true'; do sleep 1; done"
  register: mongo_ready
  retries: 60
  delay: 5
  until: mongo_ready.rc == 0
  changed_when: false

- name: Check if subscriber exists
  ansible.builtin.shell: |
    kubectl exec -n {{ open5gs_ns }} {{ open5gs_dbctl_pod }} -- \
      mongo open5gs --quiet --eval 'db.subscribers.findOne({imsi:"{{ item.imsi }}"})'
  register: subscriber_check
  changed_when: false
  loop: "{{ open5gs_ues }}"

- name: Add subscriber
  ansible.builtin.shell: |
    kubectl exec -n {{ open5gs_ns }} {{ open5gs_dbctl_pod }} -- \
      open5gs-dbctl add {{ item.item.imsi }} {{ item.item.key }} {{ item.item.opc }}
  when: item.stdout == "null"
  loop: "{{ subscriber_check.results }}"

- name: Configure slices, DNN and AMBR for all UEs and slices
  vars:
    slice_objects: "{{ fiveg.slices }}"
  ansible.builtin.shell: |
    kubectl exec -n {{ open5gs_ns }} {{ open5gs_dbctl_pod }} -- \
      open5gs-dbctl update {{ ue.imsi }} \
      --slice {{ slice.sst }}{% if slice.sd != "EMPTY" %}:{{ slice.sd }}{% endif %} \
      --dnn {{ slice.dnn }} \
      --ambr {{ slice.bandwidth.uplink }} {{ slice.bandwidth.downlink }}
  loop: "{{ open5gs_ues | subelements('slices') }}"
  loop_control:
    loop_var: ue_slice_pair
  vars:
    ue: "{{ ue_slice_pair.0 }}"
    slice_name: "{{ ue_slice_pair.1 }}"
    slice: "{{ slice_objects | selectattr('name','equalto', slice_name) | first }}"
