---
- name: Include 5G profile variables
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/../group_vars/all/5g_profile_{{ fiveg_profile | default('default') }}.yaml"
    name: fiveg

- name: Ensure data directory exists
  ansible.builtin.file:
    path: "{{ repo_dest }}/data"
    state: directory
    mode: "0755"

- name: Write generate-data-fiveg.py script on the server
  ansible.builtin.copy:
    dest: "{{ repo_dest }}/mongo-tools/generate-data-fiveg.py"
    content: |
      #!/usr/bin/env python3
      """
      Generate Open5GS subscribers from a 5G profile YAML.
      Supports multi-slices per UE.
      Writes subscribers.yaml in data/ for add-subscribers.py.
      """
      import yaml
      import os
      import argparse

      REPO_DIR = os.path.dirname(os.path.abspath(__file__)) + "/.."
      DATA_DIR = os.path.join(REPO_DIR, "data")
      os.makedirs(DATA_DIR, exist_ok=True)
      DEFAULT_PROFILE = os.path.join(REPO_DIR, "group_vars/all/5g_profile_default.yaml")
      OUTPUT_FILE = os.path.join(DATA_DIR, "subscribers.yaml")

      def load_profile(path):
          with open(path, "r") as f:
              return yaml.safe_load(f)

      def generate_subscribers(profile):
          subscribers = {}
          plmn = profile["plmn"]
          slices = {s["name"]: s for s in profile["slices"]}
          security = profile["security"]

          for ue_name, ue in profile["ues"].items():
              ue_slices = ue.get("slices", [ue.get("slice")])
              ue_entry = {
                  "imsi": f"{plmn['mcc']}{plmn['mnc']}{ue['imsi_suffix']}",
                  "key": security["full_key"],
                  "opc": security["opc"],
                  "slices": []
              }

              for s_name in ue_slices:
                  s = slices[s_name]
                  slice_entry = {
                      "name": s["name"],
                      "sst": s["sst"],
                      "sd": None if s["sd"] == "EMPTY" else s["sd"],
                      "dnn": s["dnn"],
                      "ambr": s["bandwidth"]
                  }
                  ue_entry["slices"].append(slice_entry)

              subscribers[ue_name] = ue_entry

          return subscribers

      def main():
          parser = argparse.ArgumentParser(description="Generate Open5GS subscribers from 5G profile")
          parser.add_argument("--profile", default=DEFAULT_PROFILE, help="Path to 5G profile YAML")
          args = parser.parse_args()

          profile = load_profile(args.profile)
          subscribers = generate_subscribers(profile)

          with open(OUTPUT_FILE, "w") as f:
              yaml.dump(subscribers, f, sort_keys=False)

          print(f"Generated {len(subscribers)} subscribers in {OUTPUT_FILE}")

      if __name__ == "__main__":
          main()
    mode: '0755'

- name: Generate subscribers YAML from 5G profile
  ansible.builtin.command:
    cmd: python3 mongo-tools/generate-data-fiveg.py
    chdir: "{{ repo_dest }}"
  register: generate_result

- name: Show generated subscribers info
  ansible.builtin.debug:
    msg: "{{ generate_result.stdout }}"

- name: Add subscribers into MongoDB
  ansible.builtin.command:
    cmd: python3 mongo-tools/add-subscribers.py
    chdir: "{{ repo_dest }}"
  register: add_result

- name: Show add subscribers output
  ansible.builtin.debug:
    msg: "{{ add_result.stdout }}"
