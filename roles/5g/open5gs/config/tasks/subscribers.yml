---
- name: Generate Open5GS subscribers JSON
  template:
    src: subscribers.json.j2
    dest: /tmp/open5gs-subscribers.json
  tags: subscribers

- name: Set variables
  set_fact:
    mongo_namespace: "open5gs"
    mongo_pod: "mongodb-0"
    mongo_local_port: 27017
    subscribers_json: "/tmp/open5gs-subscribers.json"
    python_script: "{{ playbook_dir }}/roles/5g/open5gs/config/mongo-tools/add-subscribers.py"
  tags: subscribers

- name: Wait for MongoDB pod to be Ready
  command: kubectl wait --for=condition=Ready pod/{{ mongo_pod }} -n {{ mongo_namespace }} --timeout=180s
  register: pod_ready
  retries: 3
  delay: 5
  until: pod_ready.rc == 0
  tags: subscribers

- name: Kill old MongoDB port-forward if exists
  shell: |
    if [ -f /tmp/port-forward.pid ]; then
      kill $(cat /tmp/port-forward.pid) || true
      rm -f /tmp/port-forward.pid /tmp/port-forward.log
    fi
  delegate_to: localhost
  ignore_errors: yes
  tags: subscribers

- name: Start MongoDB port-forwarding locally
  shell: |
    nohup kubectl port-forward -n {{ mongo_namespace }} {{ mongo_pod }} {{ mongo_local_port }}:27017 > /tmp/port-forward.log 2>&1 &
    echo $! > /tmp/port-forward.pid
  async: 0
  poll: 0
  delegate_to: localhost
  tags: subscribers

- name: Wait until MongoDB accepts connections
  wait_for:
    host: 127.0.0.1
    port: "{{ mongo_local_port }}"
    delay: 2
    timeout: 60
  delegate_to: localhost
  tags: subscribers

- name: Run Python subscriber import locally
  command: python3 "{{ python_script }}" "{{ subscribers_json }}"
  environment:
    DATA_FILE: "{{ subscribers_json }}"
    MONGO_URI: "localhost"
    MONGO_PORT: "{{ mongo_local_port }}"
  delegate_to: localhost
  tags: subscribers

- name: Stop MongoDB port-forwarding
  shell: |
    kill $(cat /tmp/port-forward.pid)
    rm -f /tmp/port-forward.pid /tmp/port-forward.log
  ignore_errors: yes
  delegate_to: localhost
  tags: subscribers
