#!/usr/bin/env python3
"""
Script YAML-ready pour importer automatiquement les abonnés Open5GS
à partir de group_vars/all/5g_profile_default.yaml.

Fonctionnalités :
- Lecture directe du YAML
- Création d'abonnés dans MongoDB via Open5GS
- Idempotence : les IMSI existants ne sont pas recréés
- Compatible avec port-forwarding automatique
"""

import yaml
from bson.objectid import ObjectId
from open5gs import Open5GS
from port_forwarding import run_with_port_forwarding
from logger import log
import argparse
from functools import partial

# MongoDB local
MONGO_URI = "localhost"
MONGO_PORT = 27017

def add_subscribers(yaml_file):
    # Lecture du YAML
    with open(yaml_file, "r") as f:
        cfg = yaml.safe_load(f)

    ues = cfg.get("ues", {})
    slices = {s["name"]: s for s in cfg.get("slices", [])}
    security = cfg.get("security", {})
    plmn = cfg.get("plmn", {})

    db = Open5GS(MONGO_URI, MONGO_PORT)

    # Récupère les IMSI déjà présents pour idempotence
    existing = db.get_subscribers()
    existing_imsis = [sub["imsi"] for sub in existing]

    for ue_name, ue in ues.items():
        slice_info = slices.get(ue["slice"], {})
        imsi = f"{plmn.get('mcc','001')}{plmn.get('mnc','01')}{ue['imsi_suffix']}"

        if imsi in existing_imsis:
            log.warning(f"Subscriber {imsi} already exists, skipping")
            continue

        subscriber = {
            "_id": ObjectId(),
            "imsi": imsi,
            "msisdn": imsi,
            "key": security.get("full_key"),
            "opc": security.get("opc"),
            "subscribed_ue_ambr": {
                "uplink": slice_info.get("bandwidth", {}).get("uplink", "20Mbps"),
                "downlink": slice_info.get("bandwidth", {}).get("downlink", "40Mbps")
            },
            "slice_info": {
                "name": ue["slice"],
                "sst": slice_info.get("sst"),
                "sd": slice_info.get("sd"),
                "dnn": slice_info.get("dnn"),
                "ip_prefix": slice_info.get("ip_prefix")
            }
        }

        db.add_subscriber(subscriber)
        log.info(f"Added subscriber {ue_name} ({imsi})")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Import Open5GS subscribers from YAML")
    parser.add_argument("yaml_file", help="Chemin vers le fichier YAML des abonnés")
    args = parser.parse_args()

    # Exécute avec port-forwarding si nécessaire
    run_with_port_forwarding(partial(add_subscribers, args.yaml_file))
