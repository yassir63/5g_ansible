---
# First clone open5gs-k8s
- name: Clone open5gs-k8s repo
  ansible.builtin.git:
    repo: "{{ repo_url }}"
    dest: "{{ repo_dest }}"
    version: main
    update: yes
    force: yes

# Then apply the 5G profile settings on the repo

- name: Load active 5G profile
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/../group_vars/all/5g_profile_{{ fiveg_profile | default('default') }}.yaml"
    name: fiveg

- name: Validate PLMN
  assert:
    that:
      - fiveg.plmn.mcc is defined
      - fiveg.plmn.mnc is defined
      - fiveg.plmn.tac is defined

- name: Validate slices
  assert:
    that:
      - slice.name is defined
      - slice.sst is defined
      - slice.dnn is defined
  loop: "{{ fiveg.slices }}"
  loop_control:
    loop_var: slice

- name: Validate UE slice references
  assert:
    that:
      - ue.value.slice in fiveg.slices | map(attribute='name') | list
  loop: "{{ fiveg.ues | dict2items }}"
  loop_control:
    loop_var: ue

- name: Update AMF ConfigMap on disk
  ansible.builtin.template:
    src: amf-configmap.yaml.j2
    dest: "{{ open5gs_root }}/common/amf/amf-configmap.yaml"

- name: Update SMF1 ConfigMap on disk
  ansible.builtin.template:
    src: smf1-configmap.yaml.j2
    dest: "{{ open5gs_root }}/slices/slice1/smf1/smf-configmap.yaml"

- name: Update SMF2 ConfigMap on disk
  ansible.builtin.template:
    src: smf2-configmap.yaml.j2
    dest: "{{ open5gs_root }}/slices/slice2/smf2/smf-configmap.yaml"

- name: Update UPF1 ConfigMap on disk
  ansible.builtin.template:
    src: upf-configmap.yaml.j2
    dest: "{{ open5gs_root }}/slices/slice1/upf1/upf-configmap.yaml"
  vars:
    upf_name: upf1
    upf_slice: slice1

- name: Update UPF2 ConfigMap on disk
  ansible.builtin.template:
    src: upf-configmap.yaml.j2
    dest: "{{ open5gs_root }}/slices/slice2/upf2/upf-configmap.yaml"
  vars:
    upf_name: upf2
    upf_slice: slice2

- name: Generate profile check file
  ansible.builtin.copy:
    content: |
      PLMN:
        mcc: {{ fiveg.plmn.mcc }}
        mnc: {{ fiveg.plmn.mnc }}
        tac: {{ fiveg.plmn.tac }}

{% for s in fiveg.slices %}
      SLICE {{ s.name }}:
        DNN: {{ s.dnn }}
        SST: {{ s.sst }}
        SD: {% if s.sd == "EMPTY" %}FFFFFF{% else %}{{ s.sd }}{% endif %}
        QoS:
          five_qi: {{ s.qos.five_qi }}
          priority_level: {{ s.qos.priority_level }}
          arp:
            priority_level: {{ s.qos.arp.priority_level }}
            preempt_cap: {{ s.qos.arp.preempt_cap }}
            preempt_vuln: {{ s.qos.arp.preempt_vuln }}
        Bandwidth:
          uplink: {{ s.bandwidth.uplink }}
          downlink: {{ s.bandwidth.downlink }}
        IP Prefix: {{ s.ip_prefix }}
{% endfor %}
    dest: /root/open5gs_profile_check.txt
    owner: root
    mode: '0644'

