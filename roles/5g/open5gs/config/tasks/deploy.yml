---
- name: RESTART_OPEN5GS
  ansible.builtin.meta: noop

- name: Normalize booleans at playbook start
  import_tasks: "{{ playbook_dir }}/../tasks/reload_booleans.yml"
      
- name: Load 5G profile
  include_vars:
    file: "{{ playbook_dir }}/../group_vars/all/5g_profile_{{ fiveg_profile | default('default') }}.yaml"

- name: Clone Open5GS k8s repo
  git:
    repo: https://github.com/sopnode/open5gs-k8s.git
    dest: /root/open5gs-k8s
    version: main
    force: true
  become: true

- name: Generate Open5GS Helm values from 5G profile
  template:
    src: values-5g.yaml.j2
    dest: /root/open5gs-k8s/open5gs/values-5g.yaml
  become: true

- name: Ensure open5gs namespace exists
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: open5gs
    state: present
    kubeconfig: /etc/kubernetes/admin.conf

# -------------------------------------------------------------------
# Persistent Volume pour MongoDB
# -------------------------------------------------------------------
- name: Ensure local directory exists for MongoDB PV
  file:
    path: /root/open5gs-mongodb-data
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Create PersistentVolume for MongoDB
  kubernetes.core.k8s:
    api_version: v1
    kind: PersistentVolume
    name: datadir-mongodb
    state: present
    kubeconfig: /etc/kubernetes/admin.conf
    definition:
      spec:
        capacity:
          storage: 1Gi
        accessModes:
          - ReadWriteOnce
        persistentVolumeReclaimPolicy: Retain
        hostPath:
          path: /root/open5gs-mongodb-data

- name: Create PersistentVolumeClaim for MongoDB
  kubernetes.core.k8s:
    api_version: v1
    kind: PersistentVolumeClaim
    name: datadir-mongodb-0
    namespace: open5gs
    state: present
    kubeconfig: /etc/kubernetes/admin.conf
    definition:
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi

- name: Deploy Open5GS core via Kustomize with realtime logs
  shell: |
    stdbuf -oL kubectl apply -k /root/open5gs-k8s/open5gs --kubeconfig=/etc/kubernetes/admin.conf | tee /tmp/open5gs-deploy.log
  args:
    chdir: /root/open5gs-k8s
  become: true

- name: Wait for Open5GS pods to be ready
  shell: |
    for pod in mongodb nrf scp amf udr bsf webui; do
      until kubectl get pods -n open5gs -l "app.kubernetes.io/name=$pod" -o jsonpath='{.items[0].status.containerStatuses[0].ready}' --kubeconfig=/etc/kubernetes/admin.conf | grep true >/dev/null; do
        echo "Waiting for pod $pod..."
        sleep 5
      done
      echo "$pod ready"
    done
  args:
    chdir: /root/open5gs-k8s
  become: true
