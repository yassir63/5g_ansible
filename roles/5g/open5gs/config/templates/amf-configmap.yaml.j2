apiVersion: v1
kind: ConfigMap
metadata:
  name: amf-configmap
  labels:
    app: open5gs
data:
  amfcfg.yaml: |
    logger:
      file: /open5gs/install/var/log/open5gs/amf.log

    global:
      max:
        ue: 1024

    amf:
      sbi:
        server:
          - dev: eth0
            advertise: amf-namf
            port: 80
        client:
          scp:
            - uri: http://scp-nscp:80
      ngap:
        server:
          - address: 10.10.3.200
            dev: n3xs
      metrics:
        server:
          - address: 0.0.0.0
            port: 9090
      guami:
        - plmn_id:
            mcc: {{ fiveg.plmn.mcc }}
            mnc: {{ fiveg.plmn.mnc }}
          amf_id:
            region: 2
            set: 1
      tai:
        - plmn_id:
            mcc: {{ fiveg.plmn.mcc }}
            mnc: {{ fiveg.plmn.mnc }}
          tac: {{ fiveg.plmn.tac }}
      plmn_support:
        - plmn_id:
            mcc: {{ fiveg.plmn.mcc }}
            mnc: {{ fiveg.plmn.mnc }}
          s_nssai:
{% for slice in fiveg.slices %}
            - sst: {{ slice.sst }}
              sd: {{ "FFFFFF" if slice.sd == "EMPTY" else slice.sd }}
{% endfor %}
      security:
        integrity_order: [ NIA2, NIA1, NIA0 ]
        ciphering_order: [ NEA0, NEA1, NEA2 ]
      network_name:
        full: Open5GS
      amf_name: open5gs-amf0

      time:
        t3512:
          value: 540

  wrapper.sh: |
    #!/bin/bash

    # Wait for Multus to assign the IP 10.10.3.200 to the n3 interface
    # This prevents the "Cannot assign requested address" error during SCTP bind
    echo "Waiting for interface n3 to be ready with IP 10.10.3.200..."
    while ! ip addr show dev n3 | grep -q "10.10.3.200"; do
      sleep 2
    done

    # Start the Open5GS AMF daemon
    /open5gs/install/bin/open5gs-amfd -c /open5gs/config/amfcfg.yaml
