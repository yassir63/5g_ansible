apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ upf_name }}-configmap
  labels:
    app: open5gs
    nf: upf
    name: {{ upf_name }}
data:
  upfcfg.yaml: |
    logger:
      file: /open5gs/install/var/log/open5gs/upf.log
      level: info

    global:
      max:
        ue: 1024

    upf:
      pfcp:
        server:
          - dev: n4
      gtpu:
        server:
          - dev: n3
      session:
{% for slice in fiveg.slices %}{% if slice.name == upf_slice %}
        - subnet: {{ slice.ip_prefix }}.0/16
          dnn: {{ slice.dnn }}
{% endif %}{% endfor %}
      metrics:
        server:
          - address: 0.0.0.0
            port: 9090

  wrapper.sh: |
    #!/bin/bash

    # Wait for Multus to finish attaching interfaces n3 and n4
    echo "Waiting for network interfaces..."
    while ! ip link show n3 >/dev/null 2>&1; do echo "Waiting for n3..."; sleep 2; done
    while ! ip link show n4 >/dev/null 2>&1; do echo "Waiting for n4..."; sleep 2; done

    # Create and configure the TUN device (ogstun)
    ip tuntap add name ogstun mode tun;
    ip addr add {{ upf_slice_data.ip_prefix }}.1/16 dev ogstun;
    
    # Disable IPv6 for the TUN interface
    sysctl -w net.ipv6.conf.all.disable_ipv6=1;
    
    # Bring the interface up and set MTU
    ip link set ogstun up;
    ip link set dev ogstun mtu 1350;
    
    # Enable IPv4 forwarding for user plane traffic
    sh -c "echo 1 > /proc/sys/net/ipv4/ip_forward";
    
    # Set up NAT Masquerade for the UE subnet
    iptables -t nat -A POSTROUTING -s {{ upf_slice_data.ip_prefix }}.0/16 ! -o ogstun -j MASQUERADE;

    # Final stabilization delay before starting the binary
    sleep 5;

    # Start the Open5GS UPF daemon
    /open5gs/install/bin/open5gs-upfd -c /open5gs/config/upfcfg.yaml
