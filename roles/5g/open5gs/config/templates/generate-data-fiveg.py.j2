#!/usr/bin/env python3
from open5gs import Open5GS
from ruamel.yaml import YAML
from logger import log
import os

yaml = YAML()
yaml.default_flow_style = False

DATA_DIR = "data"
SUBSCRIBER_FILE = os.path.join(DATA_DIR, "subscribers.yaml")
SLICE_FILE = os.path.join(DATA_DIR, "slices.yaml")
os.makedirs(DATA_DIR, exist_ok=True)

DEFAULT_KEY = "{{ profile.security.full_key }}"
DEFAULT_OPC = "{{ profile.security.opc }}"
DEFAULT_UPLINK = {"value": 1, "unit": Open5GS.Unit.Gbps}
DEFAULT_DOWNLINK = {"value": 1, "unit": Open5GS.Unit.Gbps}
DEFAULT_ARP = {"priority_level": 8,
               "pre_emption_capability": Open5GS.Status.DISABLED,
               "pre_emption_vulnerability": Open5GS.Status.DISABLED}

FIVEG_PROFILE = {
    "plmn": {"mcc": "{{ profile.plmn.mcc }}", "mnc": "{{ profile.plmn.mnc }}"},
    "slices": [
    {% for s in profile.slices %}
        {"name": "{{ s.name }}",
         "sst": {{ s.sst | int }},
         "sd": {{ "0xFFFFFF" if s.sd == "EMPTY" else ("0x" + s.sd) }},
         "dnn": "{{ s.dnn }}",
         "ambr": {"uplink": {"value": {{ s.bandwidth.uplink | regex_replace('Mbps','') | int }}, "unit": Open5GS.Unit.Mbps},
                  "downlink": {"value": {{ s.bandwidth.downlink | regex_replace('Mbps','') | int }}, "unit": Open5GS.Unit.Mbps}},
         "qos_index": {{ s.qos.five_qi | int }} }{% if not loop.last %},{% endif %}
    {% endfor %}
    ],
    "ues": [
    {% for ue_name, ue in profile.ues.items() %}
        {"name": "{{ ue_name }}",
         "imsi_suffix": "{{ ue.imsi_suffix }}",
         "key": "{{ profile.security.full_key }}",
         "opc": "{{ profile.security.opc }}",
         "slices": ["{{ ue.slice }}"] }{% if not loop.last %},{% endif %}
    {% endfor %}
    ]
}


def generate_slices(profile):
    slices = {}
    for s in profile["slices"]:
        slices[s["name"]] = {
            "sst": s["sst"],
            "sd": s["sd"],
            "default_indicator": True,
            "session": [{
                "name": s["dnn"],
                "type": Open5GS.Type.IPv4,
                "pcc_rule": [],
                "ambr": {"uplink": s["ambr"]["uplink"], "downlink": s["ambr"]["downlink"]},
                "qos": {"index": s["qos_index"], "arp": DEFAULT_ARP},
            }],
        }
    return slices

def generate_subscribers(profile, slices):
    subscribers = {}
    for ue in profile["ues"]:
        imsi = f'{profile["plmn"]["mcc"]}{profile["plmn"]["mnc"]}{ue["imsi_suffix"]}'
        assigned_slices = [slices[s] for s in ue["slices"] if s in slices]
        subscribers[ue["name"]] = {
            "_id": "",
            "imsi": imsi,
            "subscribed_rau_tau_timer": 12,
            "network_access_mode": 0,
            "subscriber_status": 0,
            "access_restriction_data": 32,
            "slice": assigned_slices,
            "ambr": {"uplink": DEFAULT_UPLINK, "downlink": DEFAULT_DOWNLINK},
            "security": {"k": ue["key"], "amf": "8000", "op": None, "opc": ue["opc"]},
            "schema_version": 1,
            "__v": 0,
        }
    return subscribers

def main():
    log.info("Generating slices and subscribers from 5G profile...")
    slices = generate_slices(FIVEG_PROFILE)
    subscribers = generate_subscribers(FIVEG_PROFILE, slices)

    with open(SLICE_FILE, "w") as f:
        yaml.dump(slices, f)
    log.info(f"Saved slices to {SLICE_FILE}")

    with open(SUBSCRIBER_FILE, "w") as f:
        yaml.dump(subscribers, f)
    log.info(f"Saved subscribers to {SUBSCRIBER_FILE}")

if __name__ == "__main__":
    main()
