---
- name: RESTART_5G_CORE
  ansible.builtin.meta: noop
  
- name: Label {{ groups['core_node'][0] }} for Open5GS Core scheduling
  command: kubectl label node {{ groups['core_node'][0] }} open5gs-core-node=true --overwrite
  changed_when: false

# === KYVERNO INSTALLATION =====================================================
- name: Add and update Kyverno Helm repo
  ansible.builtin.shell: |
    helm repo add kyverno https://kyverno.github.io/kyverno/ || true
    helm repo update
  args:
    executable: /bin/bash

- name: Ensure Kyverno namespace exists
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: kyverno

# --- Optional cleanup if Kyverno partially installed ---
- name: Uninstall previous Kyverno (safe cleanup)
  ansible.builtin.shell: |
    helm uninstall kyverno -n kyverno || true
    kubectl delete crds -l app.kubernetes.io/name=kyverno --ignore-not-found=true
  args:
    executable: /bin/bash
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  ignore_errors: true

# --- Install CRDs first (fixes the init crash) ---
- name: Download Kyverno chart and apply CRDs manually
  ansible.builtin.shell: |
    helm pull kyverno/kyverno --version 2.5.3 --untar --untardir /tmp
    kubectl apply -f /tmp/kyverno/crds
  args:
    executable: /bin/bash
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf

- name: Wait for Kyverno CRDs to be registered
  ansible.builtin.shell: |
    kubectl get crd | grep kyverno || exit 1
  register: kyverno_crd_check
  retries: 10
  delay: 10
  until: kyverno_crd_check.rc == 0
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf

# --- Install Kyverno once CRDs exist ---
- name: Install or upgrade Kyverno (with hostNetwork fix)
  ansible.builtin.shell: |
    helm upgrade --install kyverno kyverno/kyverno \
      --namespace kyverno \
      --create-namespace \
      --version 2.5.3 \
      --set installCRDs=true \
      --set kyvernoPre.enabled=false \
      --set admissionController.podSpec.hostNetwork=true \
      --set admissionController.podSpec.dnsPolicy=ClusterFirstWithHostNet \
      --wait --timeout 10m
  args:
    executable: /bin/bash
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf

# --- Wait for Kyverno to stabilize ---
- name: Wait for Kyverno deployments to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    namespace: kyverno
  register: kyverno_deploys
  retries: 30
  delay: 10
  until: >
    kyverno_deploys.resources | selectattr('status.readyReplicas', 'defined')
    | selectattr('status.readyReplicas', '>=', 1)
    | list | length >= 1
  ignore_errors: no

# === KYVERNO POLICY (Open5GS placement) =======================================
- name: Copy Kyverno policy to force Open5GS pods to {{ groups['core_node'][0] }}
  copy:
    dest: /tmp/force-open5gs-node.yaml
    content: |
      apiVersion: kyverno.io/v1
      kind: ClusterPolicy
      metadata:
        name: force-open5gs-to-core-node
      spec:
        mutateExistingOnPolicyUpdate: true
        rules:
          - name: add-open5gs-node-selector
            match:
              resources:
                kinds: ["Pod"]
                selector:
                  matchLabels:
                    app: open5gs
            mutate:
              patchStrategicMerge:
                spec:
                  nodeSelector:
                    open5gs-core-node: "true"

- name: Apply Kyverno policy
  command: kubectl apply -f /tmp/force-open5gs-node.yaml
  changed_when: false

- name: Clone open5gs-k8s repo
  ansible.builtin.git:
    repo: "{{ repo_url }}"
    dest: "{{ repo_dest }}"
    version: main
    update: yes
    force: yes

- name: Ensure {{ open5gs_ns }} namespace exists
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: "{{ open5gs_ns }}"
    state: present

- name: Apply MongoDB with Kustomize
  ansible.builtin.command: kubectl apply -k "{{ repo_dest }}/mongodb" -n {{ open5gs_ns }}

- name: Wait for MongoDB pod to be Ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ open5gs_ns }}"
    label_selectors:
      - app.kubernetes.io/name=mongodb
  register: mongo_pods
  until: >
    mongo_pods.resources | length > 0 and
    (mongo_pods.resources[0].status.containerStatuses is defined) and
    (mongo_pods.resources[0].status.containerStatuses | length > 0) and
    (mongo_pods.resources[0].status.containerStatuses[0].ready | default(false))
  retries: 40
  delay: 5

# 1. Apply NADs (creates the objects)
- name: Apply NADs with Kustomize
  ansible.builtin.command: kubectl apply -k "{{ repo_dest }}/networks5g" -n {{ open5gs_ns }}

# 2. WAIT FOR MULTUS CRD
- name: Wait for kube-apiserver to be responsive
  shell: kubectl get --raw='/healthz'
  register: api_health
  retries: 30
  delay: 5
  until: api_health.rc == 0
  changed_when: false

- name: Wait for CRDs registration to be ready
  shell: kubectl get crds
  register: crd_list
  retries: 20
  delay: 5
  until: "'network-attachment-definitions.k8s.cni.cncf.io' in crd_list.stdout"
  changed_when: false

# 3. Install jq (needed for patching)
- name: Install jq (required for NAD patching)
  ansible.builtin.apt:
    name: jq
    state: present
    update_cache: yes
  become: yes

# 4. Patch NADs to avoid interface name conflict
- name: Wait for Multus CRD to be registered in API server
  ansible.builtin.shell: kubectl get crd network-attachment-definitions.k8s.cni.cncf.io
  register: multus_crd_check
  retries: 60
  delay: 5
  until: multus_crd_check.rc == 0
  changed_when: false
  failed_when: false

# Ensure Multus CRD is available before proceeding
- name: Wait for Cluster Network Addons Operator to deploy Multus CRD
  ansible.builtin.shell: |
    set -e
    kubectl wait deployment -n cluster-network-addons cluster-network-addons-operator --for=condition=Available --timeout=300s || true
    until kubectl get crd network-attachment-definitions.k8s.cni.cncf.io >/dev/null 2>&1; do
      echo "â³ Waiting for Multus CRD..."
      sleep 5
    done
  register: wait_multus_crd
  changed_when: false
  failed_when: false
  
- name: Patch NADs to use unique interface names (net1/net2/net3)
  shell: |
    set -euo pipefail
    for nad in n2network n3network n4network; do
      case "$nad" in
        n2network) ifname=net1 ;;
        n3network) ifname=net2 ;;
        n4network) ifname=net3 ;;
        *) continue ;;
      esac
      if ! kubectl get networkattachmentdefinition "$nad" -n open5gs &>/dev/null; then
        echo "Skipping $nad (not yet created)"
        continue
      fi
      config=$(kubectl get networkattachmentdefinition "$nad" -n open5gs -o jsonpath='{.spec.config}')
      newconfig=$(echo "$config" | jq --arg n "$ifname" '.ifname = $n')
      kubectl patch networkattachmentdefinition "$nad" -n open5gs --type=merge -p "{\"spec\":{\"config\":$newconfig}}"
    done
  register: patch_nad
  failed_when: false
  changed_when: "'Skipping' not in patch_nad.stdout"

- name: Verify required NADs exist
  kubernetes.core.k8s_info:
    kind: NetworkAttachmentDefinition
    namespace: "{{ open5gs_ns }}"
  register: nad_info

- name: Fail if a required NAD is missing
  ansible.builtin.fail:
    msg: "NAD {{ item }} is missing in {{ open5gs_ns }}"
  when: item not in (nad_info.resources | map(attribute='metadata.name') | list)
  loop: "{{ nad_list }}"

- name: Apply Open5GS NFs with Kustomize
  ansible.builtin.command: kubectl apply -k "{{ repo_dest }}/{{ deployment_option }}" -n {{ open5gs_ns }}

- name: Wait for Open5GS Core NFs pods Ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ open5gs_ns }}"
    label_selectors:
      - "nf={{ item }}"
  register: nf_pod
  until: >
    nf_pod.resources | length > 0 and
    (nf_pod.resources[0].status.containerStatuses is defined) and
    (nf_pod.resources[0].status.containerStatuses | length > 0) and
    (nf_pod.resources[0].status.containerStatuses[0].ready | default(false))
  retries: 40
  delay: 5
  loop: "{{ nfs }}"
  loop_control:
    label: "{{ item }}"

- name: Install python3-venv (required for venv)
  ansible.builtin.apt:
    name: python3-venv
    state: present
  become: yes

- name: Create Python virtual environment for Open5GS admin scripts
  ansible.builtin.command:
    cmd: python3 -m venv "{{ repo_dest }}/venv"
    creates: "{{ repo_dest }}/venv/bin/activate"
  become: yes

- name: Upgrade pip in virtualenv
  ansible.builtin.pip:
    name: pip
    state: latest
    executable: "{{ repo_dest }}/venv/bin/pip"
  become: yes

- name: Install Python requirements for admin script
  ansible.builtin.pip:
    requirements: "{{ repo_dest }}/requirements.txt"
    executable: "{{ repo_dest }}/venv/bin/pip"
  become: yes

- name: Deploy Open5GS Web UI with Kustomize
  ansible.builtin.command: kubectl apply -k "{{ repo_dest }}//open5gs-webui" -n {{ open5gs_ns }}

- name: Wait for WebUI pod Ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ open5gs_ns }}"
    label_selectors:
      - "nf=webui"
  register: webui_pod
  until: >
    webui_pod.resources | length > 0 and
    (webui_pod.resources[0].status.containerStatuses is defined) and
    (webui_pod.resources[0].status.containerStatuses | length > 0) and
    (webui_pod.resources[0].status.containerStatuses[0].ready | default(false))
  retries: 40
  delay: 5

- name: Run add-admin-account.py
  ansible.builtin.command: >
    {{ repo_dest }}/venv/bin/python mongo-tools/add-admin-account.py
  args:
    chdir: "{{ repo_dest }}"

- name: Add subscribers
  ansible.builtin.shell: |
    {{ repo_dest }}/venv/bin/python mongo-tools/generate-data.py && \
    {{ repo_dest }}/venv/bin/python mongo-tools/add-subscribers.py
  args:
    chdir: "{{ repo_dest }}"
  register: sub_out
  changed_when: false

- name: Check added subscribers
  ansible.builtin.shell: |
    {{ repo_dest }}/venv/bin/python mongo-tools/check-subscribers.py
  args:
    chdir: "{{ repo_dest }}"
  register: check_out
  changed_when: false

- name: Show Added subscribers
  debug:
    var: check_out.stdout
    