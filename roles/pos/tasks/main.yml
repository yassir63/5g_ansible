---
# ================================
# POS role main.yml â€” debug visibility
# ================================

- name: Show input variables received by POS role
  ansible.builtin.debug:
    msg: |
      ðŸ“¦ INPUT VARIABLES FOR {{ node }}
      --------------------------------
      rru: {{ rru | default('undefined') }}
      ran_boot_mode: {{ ran_boot_mode | default('undefined') }}
      pos_image: {{ pos_image | default('undefined') }}
      pos_rt_image: {{ pos_rt_image | default('undefined') }}
      boot_parameters_rt: {{ boot_parameters_rt | default('undefined') }}
      boot_parameters_f1f2: {{ boot_parameters_f1f2 | default('undefined') }}
      boot_parameters_f3: {{ boot_parameters_f3 | default('undefined') }}

- name: (POS) Free any existing allocation for {{ node }}
  shell: pos allocations free -k "{{ node }}"

- name: (POS) Allocate {{ node }}
  shell: pos allocations allocate "{{ node }}"

# Always define these safely
- name: Ensure default variables exist
  set_fact:
    is_ran_node: "{{ (rru | default('')) in ['benetel1', 'benetel2'] }}"
    ran_boot_mode: "{{ ran_boot_mode | default('live') }}"
    ran_image_type: "{{ ran_image_type | default('standard') }}"

# Define POS image command
- name: Set POS image command
  set_fact:
    pos_image_cmd: >-
      {% if is_ran_node %}
        {% if ran_boot_mode == 'disk' %}
          pos node image {{ node }} boot-local
        {% else %}
          pos nodes image --staging {{ node }} {{ pos_rt_image }}
        {% endif %}
      {% else %}
        pos nodes image --staging {{ node }} {{ pos_image }}
      {% endif %}
    ran_image_type: >-
      {% if is_ran_node %}
        {{ ran_boot_mode }}
      {% else %}
        standard
      {% endif %}

# Get BIOS cmdline if accessible
- name: Try to read BIOS cmdline (may fail if node offline)
  shell: ssh -o ConnectTimeout=5 root@{{ node }} 'cat /proc/cmdline' 2>/dev/null || echo "unavailable"
  register: bios_cmdline
  changed_when: false

# Display pre-reset summary
- name: Show POS image summary (pre-reset)
  debug:
    msg: |
      ðŸ§© POS IMAGE SUMMARY (pre-reset) for {{ node }}
      -------------------------------------
      Image Command : {{ pos_image_cmd }}
      Image Type    : {{ ran_image_type }}
      RRU Type      : {{ rru | default('unknown') }}
      Boot Mode     : {{ ran_boot_mode }}
      BIOS Cmdline  : {{ bios_cmdline.stdout | default('unavailable') }}

- name: Write summary to /tmp/pos_summary.log
  lineinfile:
    path: /tmp/pos_summary.log
    line: |
      {{ lookup('pipe', 'date "+%Y-%m-%d %H:%M:%S"') }} - {{ node }} (pre-reset):
        Image Command : {{ pos_image_cmd }}
        Image Type    : {{ ran_image_type }}
        RRU Type      : {{ rru | default('unknown') }}
        Boot Mode     : {{ ran_boot_mode }}
        BIOS Cmdline  : {{ bios_cmdline.stdout | default('unavailable') }}
  delegate_to: localhost