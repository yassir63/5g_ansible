---
- name: Compute normalized POS facts
  set_fact:
    is_ran: "{{ node == ran_node_name }}"
    is_f3: "{{ node == 'sopnode-f3' }}"
    rru_type: "{{ rru_type }}"
    boot_mode: "{{ hostvars[node].ran_boot_mode | default('unknown') }}"

- name: Compute POS image command
  set_fact:
    pos_image_cmd: >-
      {% if is_ran and is_f3 and fhi72 %}
        {% if boot_mode == 'disk' %}
          pos node image {{ node }} boot-local
        {% else %}
          pos nodes image --staging {{ node }} {{ pos_rt_image }}
        {% endif %}
      {% else %}
        pos nodes image --staging {{ node }} {{ pos_image }}
      {% endif %}

- name: Select POS boot parameters
  set_fact:
    boot_params: >-
      {% if is_ran and is_f3 and fhi72 %}
        {{ boot_parameters_rt_f3 }}
      {% elif is_ran and is_f3 %}
        {{ boot_parameters_f3 }}
      {% else %}
        {{ boot_parameters_f1f2 }}
      {% endif %}

- name: Flash POS image
  shell: "{{ pos_image_cmd }}"

- name: Apply POS boot parameters
  shell: pos nodes bootparameter {{ node }} --raw "{{ boot_params }}"
