---
- name: Compute normalized POS facts
  set_fact:
    is_ran: "{{ node == ran_node_name }}"
    is_f3: "{{ node == 'sopnode-f3' }}"
    is_fx: "{{ node == 'sopnode-f1' or node == 'sopnode-f2' or node == 'sopnode-f3' }}"
    rru: "{{ rru }}"
    fhi72: "{{ fhi72 }}"
    ran_boot_mode: "{{ hostvars[node].boot_mode | default('unknown') }}"

- name: DEBUG â€” Dump all role-relevant variables and hostvars
  tags: pos_debug
  when: pos_debug_enabled | default(false)
  block:
    - name: Load POS defaults early for debug
      include_vars: "{{ role_path }}/defaults/main.yml"

    - name: Dump debug information to .pos_debug_{{ node }}.log
      ansible.builtin.shell: |
        {
          echo "================ DEBUG FOR NODE: {{ node }} ================"
          echo "Date: $(date)"
          echo ""

          echo "ran_node_name = {{ ran_node_name | default([]) }}"
          echo "rru = {{ rru | default([]) }}"
          echo "is_ran = {{ is_ran | default([]) }}"
          echo "is_f3 = {{ is_f3 | default([]) }}"
          echo "ran_boot_mode = {{ ran_boot_mode | default([]) }}"

          echo "--- Variables loaded from defaults ---"
          echo "pos_rt_image = {{ pos_rt_image }}"
          echo "pos_image = {{ pos_image }}"
          echo "boot_parameters_rt_f3 = {{ boot_parameters_rt_f3 }}"
          echo "boot_ran_parameters = {{ boot_ran_parameters }}"
          echo ""

          echo "============================================================"
        } > .pos_debug_{{ node }}.log

- name: (POS) Free any existing allocation for {{ node }}
  shell: pos allocations free -k "{{ node }}"

- name: (POS) Allocate {{ node }}
  shell: pos allocations allocate "{{ node }}"

- name: Load POS defaults
  include_vars: "{{ role_path }}/defaults/main.yml"

- name: Compute POS image command
  set_fact:
    pos_image_cmd: >-
      {% if is_ran and is_f3 and fhi72 %}
        {% if ran_boot_mode == 'disk' %}
          pos node image {{ node }} boot-local
        {% else %}
          pos nodes image --staging {{ node }} {{ pos_rt_image }}
        {% endif %}
      {% else %}
        pos nodes image --staging {{ node }} {{ pos_image }}
      {% endif %}
  when: not no_boot | default(false)

- name: Select POS boot parameters
  set_fact:
    boot_params: >-
      {% if is_ran and is_f3 and fhi72 %}
        {{ boot_parameters_rt_f3 }}
      {% elif is_fx %}
        {{ boot_ran_parameters }}
      {% else %}
        {{ boot_parameters }}
      {% endif %}
  when: not no_boot | default(false)

- name: Flash POS image
  shell: "{{ pos_image_cmd }}"
  when: not no_boot | default(false)

- name: Apply POS boot parameters
  shell: pos nodes bootparameter {{ node }} --raw {{ boot_params }}
  when: not no_boot | default(false)

- name: DEBUG Log POS configuration pre-reset
  tags: pos_debug
  block:
    - ansible.builtin.shell: |
        # First clean up file
        > .pos_pre_reset_{{ node }}.log
        echo "--------------------------------------------------------" >> .pos_pre_reset_{{ node }}.log
        echo "$(date) - {{ node }} (pre-reset):" >> ./pos_pre_reset_{{ node }}.log
        echo "  Image Command : {{ pos_image_cmd }}" >> ./pos_pre_reset_{{ node }}.log
        echo "" >> ./pos_pre_reset_{{ node }}.log
        echo "  RRU Type      : {{ rru }}" >> ./pos_pre_reset_{{ node }}.log
        echo "  Boot Params   : {{ boot_params }}" >> ./pos_pre_reset_{{ node }}.log
        echo "--------------------------------------------------------" >> ./pos_pre_reset_{{ node }}.log
  when: (not (no_boot | default(false))) and (pos_debug_enabled | default(false))

- name: (POS) Reset {{ node }}
  shell: pos nodes reset "{{ node }}"
  when: not no_boot | default(false)

- name: (POS) Wait for SSH to be available on {{ node }}
  wait_for:
    host: "{{ node }}"
    port: 22
    timeout: 300
  when: not no_boot | default(false)

- name: Bootstrap {{ node }} if boot on disk
  shell: pos node bootstrap {{ node }}
  when: (not (no_boot | default(false))) and (is_ran and ran_boot_mode == 'disk')