---
# ================================
# POS role main.yml (stable + pre-reset summary)
# ================================

- name: (POS) Free any existing allocation for {{ node }}
  shell: pos allocations free -k "{{ node }}"

- name: (POS) Allocate {{ node }}
  shell: pos allocations allocate "{{ node }}"

# Determine if this node is a RAN node
- name: Determine if this node is a RAN node
  set_fact:
    is_ran_node: "{{ (rru is defined and rru in ['benetel1', 'benetel2']) or (ran_boot_mode is defined) }}"
    ran_boot_mode: "{{ ran_boot_mode | default('live') }}"
    ran_image_type: "{{ ran_image_type | default('standard') }}"

- name: Set POS image command and type for RAN {{ node }}
  ansible.builtin.set_fact:
    pos_image_cmd: >-
      {% if rru in ['benetel1', 'benetel2'] %}
        {% if ran_boot_mode == 'disk' %}
          pos node image {{ node }} boot-local
        {% else %}
          pos nodes image --staging {{ node }} {{ pos_rt_image }}
        {% endif %}
      {% else %}
        pos nodes image --staging {{ node }} {{ pos_image }}
      {% endif %}
    ran_image_type: >-
      {% if rru in ['benetel1', 'benetel2'] %}
        {{ ran_boot_mode }}
      {% else %}
        standard
      {% endif %}
  when: is_ran_node | bool

- name: Set POS image command for non-RAN {{ node }}
  ansible.builtin.set_fact:
    pos_image_cmd: "pos nodes image --staging {{ node }} {{ pos_image }}"
    ran_image_type: "standard"
  when: not is_ran_node | bool

# BIOS parameters before reset
- name: Get current BIOS kernel parameters (if accessible)
  shell: ssh -o ConnectTimeout=5 root@{{ node }} 'cat /proc/cmdline' || echo "unavailable"
  register: bios_cmdline
  changed_when: false

# Summary before reset (fast check)
- name: Show POS image summary (pre-reset) for {{ node }}
  ansible.builtin.debug:
    msg: |
      ðŸ§© POS IMAGE SUMMARY (pre-reset) for {{ node }}
      -------------------------------------
      Image Command : {{ pos_image_cmd }}
      Image Type    : {{ ran_image_type | default('unknown') }}
      RRU Type      : {{ rru | default('unknown') }}
      Boot Mode     : {{ ran_boot_mode | default('unknown') }}
      BIOS Cmdline  : {{ bios_cmdline.stdout | default('unavailable') }}

- name: Add pre-reset summary entry
  lineinfile:
    path: /tmp/pos_summary.log
    line: |
      {{ lookup('pipe', 'date "+%Y-%m-%d %H:%M:%S"') }} - {{ node }} (pre-reset):
        Image Command : {{ pos_image_cmd }}
        Image Type    : {{ ran_image_type | default('unknown') }}
        RRU Type      : {{ rru | default('unknown') }}
        Boot Mode     : {{ ran_boot_mode | default('unknown') }}
        BIOS Cmdline  : {{ bios_cmdline.stdout | default('unavailable') }}
  delegate_to: localhost

# =======================
# Safe reset
# =======================
- name: (POS) Reset {{ node }} safely
  block:
    - name: Perform reset
      shell: pos nodes reset "{{ node }}"
  rescue:
    - name: Log reset failure
      lineinfile:
        path: /tmp/pos_summary.log
        line: |
          {{ lookup('pipe', 'date "+%Y-%m-%d %H:%M:%S"') }} - {{ node }} :
            âš ï¸ Reset failed - NodeDidNotBoot or SSH timeout detected.
      delegate_to: localhost

    - name: Show warning in console
      debug:
        msg: "âš ï¸ Reset failed for {{ node }} â€” NodeDidNotBoot or SSH timeout. Continuing anyway."

# Wait and Bootstrap (unchanged)
- name: (POS) Wait for SSH to be available on {{ node }}
  wait_for:
    host: "{{ node }}"
    port: 22
    timeout: 300

- name: Bootstrap {{ node }} if RAN node for Benetel
  ansible.builtin.shell: >-
    {% if rru in ['benetel1', 'benetel2'] and ran_boot_mode == 'disk' %}
      pos node bootstrap {{ node }} && echo "BOOTSTRAP_EXECUTED"
    {% else %}
      echo "BOOTSTRAP_SKIPPED"
    {% endif %}
  register: bootstrap_result
  when: is_ran_node | bool