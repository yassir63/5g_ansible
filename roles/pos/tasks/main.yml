---
- name: (POS) Free any existing allocation for {{ node }}
  shell: pos allocations free -k "{{ node }}"

- name: (POS) Allocate {{ node }}
  shell: pos allocations allocate "{{ node }}"

- name: Set POS image command and type for RAN {{ node }}
  ansible.builtin.set_fact:
    pos_image_cmd: >-
      {% set rru = hostvars[groups['faraday'][0]].rru %}
      {% set ran_boot_mode = hostvars[node].get('ran_boot_mode', 'live') %}
      {% if rru in ['benetel1', 'benetel2'] %}
        {% if ran_boot_mode == 'disk' %}
          pos node image {{ node }} boot-local
        {% else %}
          pos nodes image --staging {{ node }} {{ pos_rt_image }}
        {% endif %}
      {% else %}
        pos nodes image --staging {{ node }} {{ pos_image }}
      {% endif %}
    ran_image_type: >-
      {% set rru = hostvars[groups['faraday'][0]].rru %}
      {% if rru in ['benetel1', 'benetel2'] %}
        {{ hostvars[node].get('ran_boot_mode', 'live') }}
      {% else %}
        standard
      {% endif %}
  when: node in groups['ran_node']

- name: Set POS image command for non-RAN {{ node }}
  ansible.builtin.set_fact:
    pos_image_cmd: "pos nodes image --staging {{ node }} {{ pos_image }}"
    ran_image_type: "standard"
  when: node not in groups['ran_node']

- name: (POS) Flash image {{ pos_image_cmd }} to {{ node }}
  ansible.builtin.shell: "{{ pos_image_cmd }}"

- name: (POS) Set boot parameters on node {{ node }}
  ansible.builtin.shell: >-
    {% set rru = hostvars[groups['faraday'][0]].rru %}
    {% if rru in ['benetel1', 'benetel2'] %}
      pos nodes bootparameter {{ node }} {{ boot_parameters_rt }}
    {% elif node in ['sopnode-f1', 'sopnode-f2'] %}
      pos nodes bootparameter {{ node }} {{ boot_parameters_f1f2 }}
    {% else %}
      pos nodes bootparameter {{ node }} {{ boot_parameters_f3 }}
    {% endif %}
  when: node in groups['ran_node']

- name: (POS) Reset {{ node }}
  shell: pos nodes reset "{{ node }}"

- name: (POS) Wait for SSH to be available on {{ node }}
  wait_for:
    host: "{{ node }}"
    port: 22
    timeout: 300

- name: Bootstrap {{ node }} if RAN node for Benetel
  ansible.builtin.shell: >-
    {% set rru = hostvars[groups['faraday'][0]].rru %}
    {% set ran_boot_mode = hostvars[node].get('ran_boot_mode', 'live') %}
    {% if rru in ['benetel1', 'benetel2'] and ran_boot_mode == 'disk' %}
      pos node bootstrap {{ node }} && echo "BOOTSTRAP_EXECUTED"
    {% else %}
      echo "BOOTSTRAP_SKIPPED"
    {% endif %}
  register: bootstrap_result
  when: node in groups['ran_node']

- name: Show POS image summary for {{ node }}
  ansible.builtin.debug:
    msg: |
      ✅ POS IMAGE SUMMARY for {{ node }}
      -------------------------------------
      Image Command : {{ pos_image_cmd }}
      Image Type    : {{ ran_image_type }}
      Bootstrap     : >-
        {% if bootstrap_result is defined and (bootstrap_result.stdout is defined) %}
          {% if 'BOOTSTRAP_EXECUTED' in bootstrap_result.stdout %}
            executed
          {% else %}
            skipped
          {% endif %}
        {% else %}
          not applicable
        {% endif %}

- name: Save POS image summary for {{ node }}
  ansible.builtin.blockinfile:
    path: /tmp/pos_summary.log
    create: yes
    marker: ""
    block: |
      ────────────────────────────────────────────────
      [{{ ansible_date_time.iso8601 | regex_replace('T.*', '') }} {{ ansible_date_time.time }}] {{ node }}
        Image Command : {{ pos_image_cmd }}
        Image Type    : {{ 'live' if node in groups['ran_node'] and (hostvars[groups['faraday'][0]].rru in ['benetel1','benetel2']) else 'standard' }}
        Bootstrap     : {% if node in groups['ran_node'] and (hostvars[groups['faraday'][0]].rru in ['benetel1','benetel2']) %}
{{ 'disk' if hostvars[node].get('ran_boot_mode', 'live') == 'disk' else 'live' }}
                       {% else %}not applicable{% endif %}
      ────────────────────────────────────────────────
  delegate_to: localhost
  run_once: false


