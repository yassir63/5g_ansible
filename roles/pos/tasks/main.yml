---
- name: Normalize execution flags
  set_fact:
    should_boot: "{{ not no_boot | default(false) | bool }}"
    is_debug_on: "{{ pos_debug_enabled | default(false) | bool }}"

- name: Compute normalized POS facts
  set_fact:
    is_ran: "{{ node == ran_node_name }}"
    is_f3: "{{ node == 'sopnode-f3' }}"
    is_fx: "{{ node == 'sopnode-f1' or node == 'sopnode-f2' or node == 'sopnode-f3' }}"
    rru: "{{ rru }}"
    fhi72: "{{ fhi72 }}"
    ran_boot_mode: "{{ hostvars[node].boot_mode | default('unknown') }}"

- name: DEBUG â€” Dump all role-relevant variables and hostvars
  tags: pos_debug
  when: is_debug_on
  block:
    - name: Load POS defaults early for debug
      include_vars: "{{ role_path }}/defaults/main.yml"

    - name: Dump debug information to .pos_debug_{{ node }}.log
      ansible.builtin.shell: |
        {
          echo "================ DEBUG FOR NODE: {{ node }} ================"
          echo "Date: $(date)"
          echo "ran_node_name = {{ ran_node_name | default('undefined') }}"
          echo "is_ran        = {{ is_ran }}"
          echo "should_boot   = {{ should_boot }}"
          echo "============================================================"
        } > .pos_debug_{{ node }}.log

- name: (POS) Free any existing allocation for {{ node }}
  shell: pos allocations free -k "{{ node }}"

- name: (POS) Allocate {{ node }}
  shell: pos allocations allocate "{{ node }}"

- name: Load POS defaults
  include_vars: "{{ role_path }}/defaults/main.yml"

- name: Compute POS image command
  set_fact:
    pos_image_cmd: >-
      {% if is_ran and is_f3 and fhi72 %}
        {% if ran_boot_mode == 'disk' %}
          pos node image {{ node }} boot-local
        {% else %}
          pos nodes image --staging {{ node }} {{ pos_rt_image }}
        {% endif %}
      {% else %}
        pos nodes image --staging {{ node }} {{ pos_image }}
      {% endif %}
  when: should_boot

- name: Select POS boot parameters
  set_fact:
    boot_params: >-
      {% if is_ran and is_f3 and fhi72 %}
        {{ boot_parameters_rt_f3 }}
      {% elif is_fx %}
        {{ boot_ran_parameters }}
      {% else %}
        {{ boot_parameters }}
      {% endif %}
  when: should_boot

- name: Flash POS image
  shell: "{{ pos_image_cmd }}"
  when: should_boot

- name: Apply POS boot parameters
  shell: pos nodes bootparameter {{ node }} --raw {{ boot_params }}
  when: should_boot

- name: DEBUG Log POS configuration pre-reset
  tags: pos_debug
  ansible.builtin.shell: |
    > .pos_pre_reset_{{ node }}.log
    echo "--------------------------------------------------------" >> .pos_pre_reset_{{ node }}.log
    echo "$(date) - {{ node }} (pre-reset):" >> ./pos_pre_reset_{{ node }}.log
    echo "  Image Command : {{ pos_image_cmd | default('SKIPPED') }}" >> ./pos_pre_reset_{{ node }}.log
    echo "  Boot Params   : {{ boot_params | default('SKIPPED') }}" >> ./pos_pre_reset_{{ node }}.log
    echo "--------------------------------------------------------" >> ./pos_pre_reset_{{ node }}.log
  when: should_boot and is_debug_on

- name: (POS) Reset {{ node }}
  shell: pos nodes reset "{{ node }}"
  when: should_boot

- name: (POS) Wait for SSH to be available on {{ node }}
  wait_for:
    host: "{{ node }}"
    port: 22
    timeout: 300
  when: should_boot

- name: Bootstrap {{ node }} if boot on disk
  shell: pos node bootstrap {{ node }}
  when: should_boot and is_ran and ran_boot_mode == 'disk'
