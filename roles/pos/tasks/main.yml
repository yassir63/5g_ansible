---
- name: (POS) Free any existing allocation for {{ node }}
  shell: pos allocations free -k "{{ node }}"

- name: (POS) Allocate {{ node }}
  shell: pos allocations allocate "{{ node }}"

# === Compute POS image command (corrected logic) ===
- name: Set POS image command for {{ node }}
  ansible.builtin.set_fact:
    pos_image_cmd: >-
      {% set rru = hostvars[groups['faraday'][0]].rru | default('unknown') %}
      {% if node in groups['ran_node']
            and rru in ['benetel1', 'benetel2']
            and (hostvars[node].get('ran_boot_mode', 'live') != 'live') %}
        pos node image {{ node }} boot-local
      {% elif node in groups['ran_node']
            and rru in ['benetel1', 'benetel2'] %}
        pos nodes image --staging {{ node }} {{ pos_rt_image }}
      {% else %}
        pos nodes image --staging {{ node }} {{ pos_image }}
      {% endif %}

# === Log pre-reset parameters (before flashing) ===
- name: Log current POS parameters before reset
  ansible.builtin.blockinfile:
    path: /tmp/pos_debug.log
    create: yes
    marker: "#### POS DEBUG ####"
    block: |
      {{ lookup('pipe', 'date "+%Y-%m-%d %H:%M:%S"') }} - {{ node }} (pre-reset):
        RRU Type      : {{ hostvars[groups['faraday'][0]].rru | default('unknown') }}
        Boot Mode     : {{ hostvars[node].get('ran_boot_mode', 'live') }}
        POS Image Cmd : {{ pos_image_cmd }}
      ------------------------------------------------------------------------
  delegate_to: localhost

- name: (POS) Flash image {{ pos_image_cmd }} to {{ node }}
  ansible.builtin.shell: "{{ pos_image_cmd }}"

- name: (POS) Set boot parameters on node {{ node }} for RRU {{ hostvars[groups['faraday'][0]].rru }}
  ansible.builtin.shell: >-
    {% set rru = hostvars[groups['faraday'][0]].rru | default('unknown') %}
    {% if node in groups['ran_node'] and rru in ['benetel1', 'benetel2'] %}
      pos nodes bootparameter {{ node }} {{ boot_parameters_rt }}
    {% elif node in ['sopnode-f1', 'sopnode-f2'] %}
      pos nodes bootparameter {{ node }} {{ boot_parameters_f1f2 }}
    {% else %}
      pos nodes bootparameter {{ node }} {{ boot_parameters_f3 }}
    {% endif %}
  when: node in groups['ran_node']

- name: (POS) Reset {{ node }}
  shell: pos nodes reset "{{ node }}"

- name: (POS) Wait for SSH to be available on {{ node }}
  wait_for:
    host: "{{ node }}"
    port: 22
    timeout: 300

- name: Bootstrap {{ node }} if RAN node for Benetel
  ansible.builtin.shell: >-
    {% if node in groups['ran_node']
          and hostvars[groups['faraday'][0]].rru in ['benetel1', 'benetel2'] %}
      pos node bootstrap {{ node }}
    {% endif %}
  when: node in groups['ran_node']