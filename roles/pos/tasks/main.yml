---
# ================================
# POS role main.yml â€” full stable version
# ================================

- name: (POS) Free any existing allocation for {{ node }}
  shell: pos allocations free -k "{{ node }}"

- name: (POS) Allocate {{ node }}
  shell: pos allocations allocate "{{ node }}"

# Determine if node is a RAN node
- name: Determine if this node is a RAN node
  set_fact:
    "is_ran_node_{{ node }}": "{{ (rru | default('')) in ['benetel1', 'benetel2'] }}"
    "ran_boot_mode_{{ node }}": "{{ ran_boot_mode | default('live') }}"
    "ran_image_type_{{ node }}": "{{ ran_image_type | default('standard') }}"

# Define image command
- name: Set POS image command and type for RAN {{ node }}
  set_fact:
    "pos_image_cmd_{{ node }}": >-
      {% if rru in ['benetel1', 'benetel2'] %}
        {% if ran_boot_mode | default('live') == 'disk' %}
          pos node image {{ node }} boot-local
        {% else %}
          pos nodes image --staging {{ node }} {{ pos_rt_image }}
        {% endif %}
      {% else %}
        pos nodes image --staging {{ node }} {{ pos_image }}
      {% endif %}
    "ran_image_type_{{ node }}": >-
      {% if rru in ['benetel1', 'benetel2'] %}
        {{ ran_boot_mode | default('live') }}
      {% else %}
        standard
      {% endif %}
  when: vars["is_ran_node_{{ node }}"] | bool

- name: Set POS image command for non-RAN {{ node }}
  set_fact:
    "pos_image_cmd_{{ node }}": "pos nodes image --staging {{ node }} {{ pos_image }}"
    "ran_image_type_{{ node }}": "standard"
  when: not (vars["is_ran_node_{{ node }}"] | bool)

# ================================
# DEBUG + LOG BEFORE RESET
# ================================

- name: Get current BIOS kernel parameters (if accessible)
  shell: ssh -o ConnectTimeout=5 root@{{ node }} 'cat /proc/cmdline' 2>/dev/null || echo "unavailable"
  register: "bios_cmdline_{{ node }}"
  changed_when: false

- name: Show PRE-RESET DEBUG INFO for {{ node }}
  debug:
    msg: |
      ðŸ” PRE-RESET INFO for {{ node }}
      -------------------------------------
      Image Command : {{ vars["pos_image_cmd_{{ node }}"] }}
      Image Type    : {{ vars["ran_image_type_{{ node }}"] }}
      RRU Type      : {{ rru | default('unknown') }}
      Boot Mode     : {{ vars["ran_boot_mode_{{ node }}"] }}
      BIOS Cmdline  : {{ vars["bios_cmdline_{{ node }}"].stdout | default('unavailable') }}

- name: Write pre-reset debug info to /tmp/pos_debug.log
  lineinfile:
    path: /tmp/pos_debug.log
    create: yes
    line: |
      {{ lookup('pipe', 'date "+%Y-%m-%d %H:%M:%S"') }} - {{ node }} (pre-reset):
        Image Command : {{ vars["pos_image_cmd_{{ node }}"] }}
        Image Type    : {{ vars["ran_image_type_{{ node }}"] }}
        RRU Type      : {{ rru | default('unknown') }}
        Boot Mode     : {{ vars["ran_boot_mode_{{ node }}"] }}
        BIOS Cmdline  : {{ vars["bios_cmdline_{{ node }}"].stdout | default('unavailable') }}
      ------------------------------------------------------------------------
  delegate_to: localhost

# ================================
# FLASH + RESET + BOOTSTRAP
# ================================

- name: (POS) Flash image {{ vars["pos_image_cmd_{{ node }}"] }} to {{ node }}
  shell: "{{ vars['pos_image_cmd_' ~ node] }}"

- name: (POS) Set boot parameters on node {{ node }}
  shell: >-
    {% if rru in ['benetel1', 'benetel2'] %}
      pos nodes bootparameter {{ node }} {{ boot_parameters_rt }}
    {% elif node in ['sopnode-f1', 'sopnode-f2'] %}
      pos nodes bootparameter {{ node }} {{ boot_parameters_f1f2 }}
    {% else %}
      pos nodes bootparameter {{ node }} {{ boot_parameters_f3 }}
    {% endif %}
  when: vars["is_ran_node_{{ node }}"] | bool

- name: (POS) Reset {{ node }}
  shell: pos nodes reset "{{ node }}"

- name: (POS) Wait for SSH to be available on {{ node }}
  wait_for:
    host: "{{ node }}"
    port: 22
    timeout: 300

- name: Bootstrap {{ node }} if RAN node for Benetel
  shell: >-
    {% if rru in ['benetel1', 'benetel2'] and vars["ran_boot_mode_{{ node }}"] == 'disk' %}
      pos node bootstrap {{ node }} && echo "BOOTSTRAP_EXECUTED"
    {% else %}
      echo "BOOTSTRAP_SKIPPED"
    {% endif %}
  register: "bootstrap_result_{{ node }}"
  when: vars["is_ran_node_{{ node }}"] | bool

# ================================
# POST-RESET LOG ENTRY
# ================================

- name: Append post-reset info to /tmp/pos_debug.log
  lineinfile:
    path: /tmp/pos_debug.log
    line: |
      {{ lookup('pipe', 'date "+%Y-%m-%d %H:%M:%S"') }} - {{ node }} (post-reset):
        Bootstrap     : >-
          {% set br = vars["bootstrap_result_{{ node }}"] if ("bootstrap_result_{{ node }}" in vars) else {} %}
          {% if br and br.stdout is defined %}
            {% if 'BOOTSTRAP_EXECUTED' in br.stdout %}
              executed
            {% else %}
              skipped
            {% endif %}
          {% else %}
            not applicable
          {% endif %}
      ------------------------------------------------------------------------
  delegate_to: localhost