---
# POS role main.yml â€” Fixed: reliable hostvars, image selection, and robust logging (append)
# Writes pre/post debug into /tmp/pos_debug.log on controller (append mode)

- name: (POS) Free any existing allocation for {{ node }}
  shell: pos allocations free -k "{{ node }}"

- name: (POS) Allocate {{ node }}
  shell: pos allocations allocate "{{ node }}"

# ---------------------
# Safe variable resolution with fallbacks
# ---------------------
- name: Gather node parameters safely
  set_fact:
    # prefer explicit rru variable, else hostvars[node].rru, else faraday group's rru (if set)
    rru: >-
      {{ rru
         | default(hostvars.get(node, {}).get('rru',
           (hostvars.get(groups['faraday']|first, {}).get('rru') if (groups['faraday'] is defined and groups['faraday']|length > 0) else ''))) }}
    # boot mode: prefer given var, else hostvars[node].ran_boot_mode, default to 'live'
    ran_boot_mode: "{{ ran_boot_mode | default(hostvars.get(node, {}).get('ran_boot_mode', 'live')) }}"
    # ran_image_type kept for compatibility; we compute image_selected below
    ran_image_type: "{{ ran_image_type | default(hostvars.get(node, {}).get('ran_image_type', 'standard')) }}"
    is_ran_node: "{{ ( (rru | default('')) in ['benetel1', 'benetel2'] ) }}"
  changed_when: false

# ---------------------
# Compute selected image and pos command deterministically
# ---------------------
- name: Compute selected image and pos image command
  set_fact:
    image_selected: >-
      {% if is_ran_node %}
        {% if ran_boot_mode == 'disk' %}
          boot-local
        {% else %}
          {{ pos_rt_image }}
        {% endif %}
      {% else %}
        {{ pos_image }}
      {% endif %}
    pos_image_cmd: >-
      {% if is_ran_node %}
        {% if ran_boot_mode == 'disk' %}
          pos node image {{ node }} boot-local
        {% else %}
          pos nodes image --staging {{ node }} {{ pos_rt_image }}
        {% endif %}
      {% else %}
        pos nodes image --staging {{ node }} {{ pos_image }}
      {% endif %}
  changed_when: false

# ---------------------
# PRE-RESET: read BIOS cmdline (best effort)
# ---------------------
- name: Get current BIOS kernel parameters (if accessible)
  shell: ssh -o BatchMode=yes -o ConnectTimeout=5 root@{{ node }} 'cat /proc/cmdline' 2>/dev/null || echo "unavailable"
  register: bios_cmdline
  changed_when: false
  failed_when: false

- name: Show PRE-RESET INFO for {{ node }}
  debug:
    msg: |
      ðŸ” PRE-RESET INFO for {{ node }}
      -------------------------------------
      Image Command : {{ pos_image_cmd }}
      Image Type    : {{ image_selected | default('unknown') }}
      RRU Type      : {{ rru | default('unknown') }}
      Boot Mode     : {{ ran_boot_mode | default('unknown') }}
      BIOS Cmdline  : {{ bios_cmdline.stdout | default('unavailable') }}

- name: Append pre-reset info to /tmp/pos_debug.log (controller)
  delegate_to: localhost
  shell: |
    printf '%s\n' "$(date '+%Y-%m-%d %H:%M:%S') - {{ node }} (pre-reset):" >> /tmp/pos_debug.log
    printf '  Image Command : %s\n' "{{ pos_image_cmd }}" >> /tmp/pos_debug.log
    printf '  Image Type    : %s\n' "{{ image_selected | default('unknown') }}" >> /tmp/pos_debug.log
    printf '  RRU Type      : %s\n' "{{ rru | default('unknown') }}" >> /tmp/pos_debug.log
    printf '  Boot Mode     : %s\n' "{{ ran_boot_mode | default('unknown') }}" >> /tmp/pos_debug.log
    printf '  BIOS Cmdline  : %s\n' "{{ bios_cmdline.stdout | default('unavailable') }}" >> /tmp/pos_debug.log
    printf '------------------------------------------------------------------------\n' >> /tmp/pos_debug.log
  args:
    warn: false

# ---------------------
# FLASH / BOOTPARAM / RESET / WAIT
# ---------------------
- name: (POS) Flash image {{ pos_image_cmd }} to {{ node }}
  shell: "{{ pos_image_cmd }}"
  register: pos_flash
  failed_when: false
  changed_when: pos_flash.rc == 0

- name: (POS) Set boot parameters on node {{ node }}
  shell: >-
    {% if rru in ['benetel1', 'benetel2'] %}
      pos nodes bootparameter {{ node }} {{ boot_parameters_rt }}
    {% elif node in ['sopnode-f1', 'sopnode-f2'] %}
      pos nodes bootparameter {{ node }} {{ boot_parameters_f1f2 }}
    {% else %}
      pos nodes bootparameter {{ node }} {{ boot_parameters_f3 }}
    {% endif %}
  when: is_ran_node | bool
  register: pos_bootparam
  failed_when: false
  changed_when: pos_bootparam.rc == 0

- name: (POS) Reset {{ node }}
  shell: pos nodes reset "{{ node }}"
  register: pos_reset_result
  failed_when: false
  changed_when: pos_reset_result.rc == 0

- name: (POS) Wait for SSH to be available on {{ node }}
  wait_for:
    host: "{{ node }}"
    port: 22
    timeout: 300
  register: wait_ssh
  failed_when: false

- name: Bootstrap {{ node }} if RAN node for Benetel
  shell: >-
    {% if is_ran_node and ran_boot_mode == 'disk' %}
      pos node bootstrap {{ node }} && echo "BOOTSTRAP_EXECUTED"
    {% else %}
      echo "BOOTSTRAP_SKIPPED"
    {% endif %}
  register: bootstrap_result
  when: is_ran_node | bool
  failed_when: false

# ---------------------
# POST-RESET: append bootstrap/reset info to centralized log (controller)
# ---------------------
- name: Append post-reset info to /tmp/pos_debug.log (controller)
  delegate_to: localhost
  shell: |
    printf '%s\n' "$(date '+%Y-%m-%d %H:%M:%S') - {{ node }} (post-reset):" >> /tmp/pos_debug.log
    printf '  Reset RC      : %s\n' "{{ pos_reset_result.rc | default('N/A') }}" >> /tmp/pos_debug.log
    printf '  Flash RC      : %s\n' "{{ pos_flash.rc | default('N/A') }}" >> /tmp/pos_debug.log
    printf '  Bootparam RC  : %s\n' "{{ pos_bootparam.rc | default('N/A') }}" >> /tmp/pos_debug.log
    printf '  SSH Wait      : %s\n' "{{ wait_ssh.elapsed | default('N/A') }}" >> /tmp/pos_debug.log
    if [ -n "{{ bootstrap_result.stdout | default('') }}" ]; then
      if echo "{{ bootstrap_result.stdout }}" | grep -q "BOOTSTRAP_EXECUTED"; then
        printf '  Bootstrap     : executed\n' >> /tmp/pos_debug.log
      else
        printf '  Bootstrap     : skipped\n' >> /tmp/pos_debug.log
      fi
    else
      printf '  Bootstrap     : not applicable\n' >> /tmp/pos_debug.log
    fi
    printf '------------------------------------------------------------------------\n' >> /tmp/pos_debug.log
  args:
    warn: false