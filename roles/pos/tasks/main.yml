---
- name: Compute normalized POS facts
  set_fact:
    is_ran: "{{ node == ran_node_name }}"
    is_f3: "{{ node == 'sopnode-f3' }}"
    rru_type: "{{ rru_type }}"
    boot_mode: "{{ hostvars[node].ran_boot_mode | default('unknown') }}"

- name: (POS) Free any existing allocation for {{ node }}
  shell: pos allocations free -k "{{ node }}"

- name: (POS) Allocate {{ node }}
  shell: pos allocations allocate "{{ node }}"

- name: Load POS defaults
  include_vars: "{{ role_path }}/defaults/main.yml"

- name: Compute POS image command
  set_fact:
    pos_image_cmd: >-
      {% if is_ran and is_f3 and fhi72 %}
        {% if boot_mode == 'disk' %}
          pos node image {{ node }} boot-local
        {% else %}
          pos nodes image --staging {{ node }} {{ pos_rt_image }}
        {% endif %}
      {% else %}
        pos nodes image --staging {{ node }} {{ pos_image }}
      {% endif %}

- name: Select POS boot parameters
  set_fact:
    boot_params: >-
      {% if is_ran and is_f3 and fhi72 %}
        {{ boot_parameters_rt_f3 }}
      {% elif is_ran and is_f3 %}
        {{ boot_parameters_f3 }}
      {% else %}
        {{ boot_parameters_f1f2 }}
      {% endif %}

- name: Flash POS image
  shell: "{{ pos_image_cmd }}"

- name: Apply POS boot parameters
  shell: pos nodes bootparameter {{ node }} --raw "{{ boot_params }}"

- name: (POS) Reset {{ node }}
  shell: pos nodes reset "{{ node }}"

- name: (POS) Wait for SSH to be available on {{ node }}
  wait_for:
    host: "{{ node }}"
    port: 22
    timeout: 300

- name: Bootstrap {{ node }} if boot on disk
  shell: pos node bootstrap {{ node }}
  when is_ran and boot_mode == 'disk'