---
# roles/pos/tasks/main.yml
# Corrected POS role with proper logic and pre-reset logging

- name: (POS) Free any existing allocation for {{ node }}
  ansible.builtin.shell: pos allocations free -k "{{ node }}"

- name: (POS) Allocate {{ node }}
  ansible.builtin.shell: pos allocations allocate "{{ node }}"

# Load role defaults explicitly (in case they're needed for templating)
- name: Load POS defaults
  ansible.builtin.include_vars:
    file: "{{ role_path }}/defaults/main.yml"
    name: pos_defaults

- name: Determine RRU type
  ansible.builtin.set_fact:
    rru_type: "{{ hostvars.get(groups.get('faraday', [])[0], {}).get('rru', 'unknown') }}"

- name: Determine if node is RAN
  ansible.builtin.set_fact:
    is_ran_node: "{{ node in (groups.get('ran_node') | default([])) }}"

- name: Compute POS image command
  ansible.builtin.set_fact:
    pos_image_cmd: >-
      {% if is_ran_node and rru_type in ['benetel1', 'benetel2'] %}
      pos node image {{ node }} boot-local
      {% else %}
      pos nodes image --staging {{ node }} {{ pos_defaults.pos_image }}
      {% endif %}

    pos_boot_params: >-
      {% if is_ran_node and rru_type in ['benetel1', 'benetel2'] %}
      {{ pos_defaults.boot_parameters_rt }}
      {% elif node in ['sopnode-f1', 'sopnode-f2'] %}
      {{ pos_defaults.boot_parameters_f1f2 }}
      {% else %}
      {{ pos_defaults.boot_parameters_f3 }}
      {% endif %}

# üßæ Log configuration before reset
- name: Log POS configuration pre-reset
  ansible.builtin.copy:
    dest: "/tmp/pos_pre_reset_{{ node }}.log"
    content: |
      --------------------------------------------------------
      {{ ansible_date_time.iso8601 }} - {{ node }} (pre-reset)
      --------------------------------------------------------
      RRU Type         : {{ rru_type }}
      Is RAN Node      : {{ is_ran_node }}
      POS Image Cmd    : {{ pos_image_cmd }}
      POS Boot Params  : {{ pos_boot_params }}
      --------------------------------------------------------

# üñºÔ∏è Flash image
- name: (POS) Flash image {{ pos_image_cmd }} to {{ node }}
  ansible.builtin.shell: "{{ pos_image_cmd }}"

# üß¨ Apply correct boot parameters (only if RAN node)
- name: (POS) Set boot parameters on node {{ node }}
  ansible.builtin.shell: >-
    pos nodes bootparameter {{ node }} "{{ pos_boot_params }}"
  when: is_ran_node

# üîÅ Reset node
- name: (POS) Reset {{ node }}
  ansible.builtin.shell: pos nodes reset "{{ node }}"

# ‚è±Ô∏è Wait for SSH
- name: (POS) Wait for SSH to be available on {{ node }}
  ansible.builtin.wait_for:
    host: "{{ node }}"
    port: 22
    timeout: 300

# üß© Bootstrap if Benetel RRU
- name: Bootstrap {{ node }} if RAN node for Benetel
  ansible.builtin.shell: pos node bootstrap {{ node }}
  when: is_ran_node and rru_type in ['benetel1', 'benetel2']
